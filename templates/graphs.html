<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#F7CF6B">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Time Tracker Pro">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="{{ pwa_manifest_url }}">
    <link rel="icon" href="{{ pwa_icon_url }}" type="image/png">
    <link rel="apple-touch-icon" href="{{ pwa_icon_url }}">
    <title>Graphs - Time Tracker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #F7F1E6 0%, #F2E6D5 40%, #E9DDCB 100%);
            color: #111827;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }
        .luxury-card {
            background: linear-gradient(135deg, #FEFCF8, #F5EDE1);
            border: 1px solid rgba(148, 126, 86, 0.18);
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.06);
        }
        .primary-cta {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.7rem 1.6rem;
            border-radius: 9999px;
            background: #111827;
            color: #F8D574;
            font-size: 0.9rem;
            letter-spacing: 0.03em;
            font-weight: 600;
            box-shadow: 0 14px 32px rgba(17, 24, 39, 0.55);
            border: 1px solid rgba(248, 213, 116, 0.4);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
        }
        .primary-cta:hover {
            transform: translateY(-1px);
            box-shadow: 0 20px 40px rgba(17, 24, 39, 0.7);
            filter: brightness(1.03);
        }
        .secondary-cta {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.55rem 1.4rem;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.75);
            color: #111827;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            border: 1px solid rgba(148, 126, 86, 0.35);
            box-shadow: 0 12px 24px rgba(148, 126, 86, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }
        .secondary-cta:hover {
            background: #F7F1E6;
            transform: translateY(-1px);
            box-shadow: 0 16px 28px rgba(148, 126, 86, 0.3);
        }
        .soft-pill {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(148, 126, 86, 0.28);
        }
        .range-pill.active, .ma-pill.active {
            background: linear-gradient(135deg, #F8D574, #F5B826);
            color: #111827;
            box-shadow: 0 12px 26px rgba(185, 132, 40, 0.35);
        }
        .graph-focus-option {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            font-weight: 500;
            color: #1F2937;
            padding-right: 2.25rem;
        }
        .graph-focus-option[data-active="true"] {
            background: #111827;
            color: #F8D574;
        }
        .graph-focus-option[data-active="true"]::after {
            content: '✓';
            position: absolute;
            right: 1rem;
            font-weight: 700;
            font-size: 0.8rem;
            color: #F8D574;
        }
        .graph-help-btn {
            width: 26px;
            height: 26px;
            border-radius: 9999px;
            border: 1px solid rgba(148, 126, 86, 0.35);
            background: rgba(255, 255, 255, 0.85);
            color: #1F2937;
            font-size: 0.75rem;
            font-weight: 700;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease, background 0.2s ease;
        }
        .graph-help-btn:hover {
            transform: translateY(-1px);
            background: #F7F1E6;
        }
        .graph-help-tooltip {
            width: 280px;
            background: #111827;
            color: #F8D574;
            padding: 0.75rem 0.9rem;
            border-radius: 0.85rem;
            font-size: 0.72rem;
            line-height: 1.4;
            box-shadow: 0 18px 40px rgba(17, 24, 39, 0.35);
            border: 1px solid rgba(248, 213, 116, 0.35);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: radial-gradient(circle at top left, #FFFFFF 0%, #F9FAFB 55%, #E5E7EB 100%);
            border-radius: 24px;
            max-width: 900px;
            max-height: 90vh;
            width: 90%;
            overflow-y: auto;
            border: 1px solid rgba(15,23,42,0.08);
            box-shadow: 0 30px 80px rgba(15,23,42,0.32);
        }
        .dropdown-item {
            padding: 0.65rem 1rem;
            cursor: pointer;
            transition: background 0.15s ease;
            font-size: 0.875rem;
            color: #374151;
        }
        .dropdown-item:hover {
            background: rgba(243, 244, 246, 0.8);
        }
        .dropdown-item:first-child {
            border-radius: 12px 12px 0 0;
        }
        .dropdown-item:last-child {
            border-radius: 0 0 12px 12px;
        }
    </style>
</head>
<body class="antialiased">
    <header class="bg-white/90 backdrop-blur border-b border-slate-200 shadow-sm" role="banner">
        <div class="max-w-6xl mx-auto px-6 md:px-8 py-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-semibold text-gray-900 tracking-tight">Time Tracker Pro</h1>
                    <p class="text-sm text-gray-500 mt-1">Trends and patterns over time</p>
                </div>
                <div class="flex items-center gap-3">
                    <a href="{{ url_for('main.dashboard') }}" class="px-4 py-2 rounded-full bg-white/80 border border-[rgba(148,126,86,0.35)] text-sm text-gray-700 hover:bg-[#F7F1E6] transition-all">Back to Dashboard</a>
                    {% if is_admin %}
                        <a href="{{ url_for('admin.admin_users') }}" class="md:hidden px-3 py-2 rounded-full bg-white/80 border border-[rgba(148,126,86,0.35)] text-xs font-semibold text-gray-700 hover:bg-[#F7F1E6] transition-all">Admin</a>
                    {% endif %}
                    {% if current_user and current_user.display_name %}
                        <div class="hidden md:flex items-center gap-2">
                            <a href="{{ url_for('main.settings') }}" class="px-3 py-2 rounded-full bg-white/80 border border-[rgba(148,126,86,0.35)] text-xs font-semibold text-gray-800 hover:bg-[#F7F1E6] transition-all">
                                {{ current_user.display_name }}
                            </a>
                            {% if is_admin %}
                                <a href="{{ url_for('admin.admin_users') }}" class="px-3 py-2 rounded-full bg-white/80 border border-[rgba(148,126,86,0.35)] text-xs font-semibold text-gray-700 hover:bg-[#F7F1E6] transition-all">Admin</a>
                            {% endif %}
                            <a href="{{ url_for('auth.logout') }}" class="px-3 py-2 rounded-full bg-gray-900 text-amber-300 text-xs font-semibold shadow-lg">Logout</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 md:px-8 py-6 md:py-12 pb-20 md:pb-12">
        <div class="mb-6 md:mb-8">
            <h2 class="text-2xl md:text-4xl font-light text-gray-900 mb-1 md:mb-2">Time Trends</h2>
            <p class="text-sm md:text-base text-gray-600">Pick a focus and see how it moves across days.</p>
        </div>

        <div class="luxury-card rounded-2xl md:rounded-3xl p-4 md:p-8 mb-6 md:mb-8">
            <div class="space-y-4">
                <label class="block text-xs md:text-sm font-medium text-gray-700">Graph focus</label>
                <div class="flex flex-col lg:flex-row lg:items-center gap-3">
                    <div class="relative w-full lg:max-w-[240px]">
                        <button id="graphFocusBtn" class="w-full px-4 py-3 rounded-2xl bg-white/85 border border-[rgba(148,126,86,0.35)] text-left text-sm md:text-base text-gray-900 font-semibold flex items-center justify-between hover:bg-[#F7F1E6] transition-all">
                            <span id="graphFocusLabel">Work</span>
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="graphFocusMenu" class="hidden absolute z-50 w-full mt-2 bg-[#FFFDF8] rounded-2xl shadow-2xl border border-[rgba(148,126,86,0.35)] max-h-80 overflow-y-auto">
                            <button type="button" class="graph-focus-option w-full text-left px-4 py-3 hover:bg-[#F7F1E6] text-sm transition-colors" data-value="search_only">Search only</button>
                            <button type="button" class="graph-focus-option w-full text-left px-4 py-3 hover:bg-[#F7F1E6] text-sm transition-colors" data-value="work">Work</button>
                            <button type="button" class="graph-focus-option w-full text-left px-4 py-3 hover:bg-[#F7F1E6] text-sm transition-colors" data-value="necessity">Necessity</button>
                            <button type="button" class="graph-focus-option w-full text-left px-4 py-3 hover:bg-[#F7F1E6] text-sm transition-colors" data-value="soul">Soul</button>
                            <button type="button" class="graph-focus-option w-full text-left px-4 py-3 hover:bg-[#F7F1E6] text-sm transition-colors" data-value="rest">Rest</button>
                            <button type="button" class="graph-focus-option w-full text-left px-4 py-3 hover:bg-[#F7F1E6] text-sm transition-colors" data-value="waste">Waste</button>
                            <div class="px-4 py-1 text-[11px] uppercase tracking-[0.2em] text-gray-400">Priority</div>
                            <button type="button" class="graph-focus-option w-full text-left px-4 py-3 hover:bg-[#F7F1E6] text-sm transition-colors" data-value="important">Important</button>
                            <button type="button" class="graph-focus-option w-full text-left px-4 py-3 hover:bg-[#F7F1E6] text-sm transition-colors" data-value="urgent">Urgent</button>
                            <div class="px-4 py-1 text-[11px] uppercase tracking-[0.2em] text-gray-400">Quadrants</div>
                            <button type="button" class="graph-focus-option w-full text-left px-4 py-3 hover:bg-[#F7F1E6] text-sm transition-colors" data-value="q1">Important & Urgent (Critical)</button>
                            <button type="button" class="graph-focus-option w-full text-left px-4 py-3 hover:bg-[#F7F1E6] text-sm transition-colors" data-value="q2">Important & Not Urgent (Growth)</button>
                            <button type="button" class="graph-focus-option w-full text-left px-4 py-3 hover:bg-[#F7F1E6] text-sm transition-colors" data-value="q3">Urgent & Not Important (Drudgery)</button>
                            <button type="button" class="graph-focus-option w-full text-left px-4 py-3 hover:bg-[#F7F1E6] text-sm transition-colors" data-value="q4">Not Urgent & Not Important (Waste)</button>
                            <div class="px-4 py-1 text-[11px] uppercase tracking-[0.2em] text-gray-400">All logs</div>
                            <button type="button" class="graph-focus-option w-full text-left px-4 py-3 hover:bg-[#F7F1E6] text-sm transition-colors" data-value="total">Total time</button>
                        </div>
                    </div>
                    <input id="graphSearchInput" type="text" class="flex-1 px-4 py-3 rounded-2xl bg-white/80 border border-[rgba(148,126,86,0.35)] text-sm md:text-base text-gray-900 focus:outline-none focus:ring-2 focus:ring-amber-300" placeholder="sleep, rest · work · important and not work · workout or yoga">
                </div>
                <div class="flex flex-col gap-3">
                    <div class="flex flex-wrap items-center gap-3">
                        <label class="inline-flex items-center gap-2 text-xs md:text-sm font-medium text-gray-600">
                            <input id="graphComboToggle" type="checkbox" class="h-4 w-4 text-amber-500 border-gray-300 focus:ring-amber-300">
                            Allow search with focus
                        </label>
                        <div class="relative" id="graphHelpWrapper">
                            <button id="graphHelpBtn" type="button" class="graph-help-btn" aria-label="Search syntax help">!</button>
                            <div id="graphHelpTooltip" class="graph-help-tooltip hidden absolute left-0 top-full mt-2">Default is mutually exclusive. Toggle “Allow search with focus” to combine. Use commas or “or” for alternatives, “and” for strict matches, and “not” to exclude.</div>
                        </div>
                    </div>
                    <div class="grid gap-2 sm:flex sm:flex-wrap sm:items-center">
                        <button id="graphSearchApply" class="primary-cta text-sm md:text-base w-full sm:w-auto">Apply</button>
                        <button id="graphSearchClear" class="secondary-cta text-sm md:text-base w-full sm:w-auto">Clear</button>
                        <button id="reviewGraphTasks" class="secondary-cta text-sm md:text-base w-full sm:w-auto hidden">Review tasks</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="luxury-card rounded-2xl md:rounded-3xl p-4 md:p-8 mb-6 md:mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 md:gap-4 mb-5 md:mb-6">
                <div>
                    <h3 class="text-lg md:text-xl font-semibold text-gray-900" id="chartTitle">Work</h3>
                    <p class="text-xs md:text-sm text-gray-500" id="chartSubtitle">Last 30 days · 7-day avg</p>
                </div>
            </div>
            <div class="relative" style="height: 280px;">
                <canvas id="graphCanvas"></canvas>
            </div>
        </div>

        <div class="luxury-card rounded-2xl md:rounded-3xl p-4 md:p-6 mb-6 md:mb-8">
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-5">
                <div>
                    <label class="block text-xs md:text-sm font-medium text-gray-700 mb-3">Time range</label>
                    <div class="flex flex-wrap gap-2 md:gap-3">
                        <button class="range-pill soft-pill px-3 md:px-4 py-2 rounded-full text-xs md:text-sm font-medium text-gray-700" data-range="7">7 days</button>
                        <button class="range-pill soft-pill px-3 md:px-4 py-2 rounded-full text-xs md:text-sm font-medium text-gray-700 active" data-range="30">30 days</button>
                        <button class="range-pill soft-pill px-3 md:px-4 py-2 rounded-full text-xs md:text-sm font-medium text-gray-700" data-range="90">90 days</button>
                        <button class="range-pill soft-pill px-3 md:px-4 py-2 rounded-full text-xs md:text-sm font-medium text-gray-700" data-range="180">180 days</button>
                    </div>
                </div>
                <div>
                    <label class="block text-xs md:text-sm font-medium text-gray-700 mb-3">Moving average window</label>
                    <div class="flex flex-wrap gap-2">
                        <button class="ma-pill soft-pill px-3 py-1.5 rounded-full text-xs font-medium text-gray-700 active" data-ma="7">7d</button>
                        <button class="ma-pill soft-pill px-3 py-1.5 rounded-full text-xs font-medium text-gray-700" data-ma="14">14d</button>
                        <button class="ma-pill soft-pill px-3 py-1.5 rounded-full text-xs font-medium text-gray-700" data-ma="30">30d</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid gap-3 md:gap-4 grid-cols-3">
            <div class="luxury-card rounded-xl md:rounded-2xl p-3 md:p-5 text-center">
                <p class="text-[10px] md:text-xs uppercase tracking-wider text-gray-500">Total Hours</p>
                <div class="text-xl md:text-2xl font-light text-gray-900 mt-1 md:mt-2" id="totalHours">0h</div>
            </div>
            <div class="luxury-card rounded-xl md:rounded-2xl p-3 md:p-5 text-center">
                <p class="text-[10px] md:text-xs uppercase tracking-wider text-gray-500">Avg/Day</p>
                <div class="text-xl md:text-2xl font-light text-gray-900 mt-1 md:mt-2" id="avgHours">0h</div>
            </div>
            <div class="luxury-card rounded-xl md:rounded-2xl p-3 md:p-5 text-center">
                <p class="text-[10px] md:text-xs uppercase tracking-wider text-gray-500">Best Day</p>
                <div class="text-xl md:text-2xl font-light text-gray-900 mt-1 md:mt-2" id="maxHours">0h</div>
            </div>
        </div>
    </main>

    <div id="graphTaskModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="graphTaskTitle">
        <div class="modal-content p-8" role="document">
            <div class="flex justify-between items-center mb-6">
                <h2 id="graphTaskTitle" class="text-2xl font-semibold text-gray-900">Tasks in this graph</h2>
                <button id="closeGraphTasks" class="text-gray-400 hover:text-gray-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div id="graphTaskTools" class="mb-4 flex items-center justify-end"></div>
            <div id="graphTaskStats" class="mb-6 grid grid-cols-3 gap-4"></div>
            <div id="graphTaskChart" class="mb-12 md:mb-6"></div>
            <div id="graphTasksList" class="mt-6 md:mt-0 space-y-3"></div>
        </div>
    </div>

    <script>
        const metricColors = {
            total: '#111827',
            important: '#2563EB',
            urgent: '#F97316',
            q1: '#F59E0B',
            q2: '#10B981',
            q3: '#94A3B8',
            q4: '#EF4444',
            work: '#10B981',
            necessity: '#F59E0B',
            soul: '#6366F1',
            rest: '#C4B5FD',
            waste: '#DC2626'
        };

        const metricLabels = {
            total: 'Total time',
            important: 'Important',
            urgent: 'Urgent',
            q1: 'Important & Urgent',
            q2: 'Important & Not Urgent',
            q3: 'Urgent & Not Important',
            q4: 'Not Urgent & Not Important',
            work: 'Work',
            necessity: 'Necessity',
            soul: 'Soul',
            rest: 'Rest',
            waste: 'Waste'
        };

        const TAG_COLOR_MAP = {
            Work: '#10B981',
            Necessity: '#F59E0B',
            Soul: '#6366F1',
            Rest: '#C4B5FD',
            Waste: '#DC2626'
        };

        let currentDays = 30;
        let chartInstance = null;
        let currentMetric = 'work';
        let graphFocusValue = 'work';
        let maWindow = 7;
        let graphSearchQuery = '';
        let graphExcludedIds = new Set();
        let graphTasks = [];
        let graphColorScheme = null;

        const chartTitle = document.getElementById('chartTitle');
        const chartSubtitle = document.getElementById('chartSubtitle');
        const totalHoursEl = document.getElementById('totalHours');
        const avgHoursEl = document.getElementById('avgHours');
        const maxHoursEl = document.getElementById('maxHours');
        const graphFocusBtn = document.getElementById('graphFocusBtn');
        const graphFocusLabel = document.getElementById('graphFocusLabel');
        const graphFocusMenu = document.getElementById('graphFocusMenu');
        const graphComboToggle = document.getElementById('graphComboToggle');
        const graphSearchInput = document.getElementById('graphSearchInput');
        const graphSearchApply = document.getElementById('graphSearchApply');
        const graphSearchClear = document.getElementById('graphSearchClear');
        const reviewGraphTasks = document.getElementById('reviewGraphTasks');
        const graphHelpBtn = document.getElementById('graphHelpBtn');
        const graphHelpTooltip = document.getElementById('graphHelpTooltip');
        const graphHelpWrapper = document.getElementById('graphHelpWrapper');
        const graphTaskModal = document.getElementById('graphTaskModal');
        const graphTasksList = document.getElementById('graphTasksList');
        const graphTaskStats = document.getElementById('graphTaskStats');
        const graphTaskChart = document.getElementById('graphTaskChart');
        const graphTaskTools = document.getElementById('graphTaskTools');
        const closeGraphTasks = document.getElementById('closeGraphTasks');
        let graphTaskChartInstance = null;
        let graphTaskQuery = '';
        let graphTaskSort = 'time_desc';
        let graphTaskSortLabel = 'Time ↓';
        let graphHiddenTags = {};

        function formatHours(value) {
            const num = Number(value) || 0;
            return `${num.toFixed(1)}h`;
        }

        const parseColor = (value) => {
            if (!value) return null;
            const raw = String(value).trim();
            const hex = raw.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
            if (hex) {
                const hexValue = hex[1];
                const full = hexValue.length === 3
                    ? hexValue.split('').map(c => c + c).join('')
                    : hexValue;
                const intVal = parseInt(full, 16);
                return [(intVal >> 16) & 255, (intVal >> 8) & 255, intVal & 255];
            }
            const rgb = raw.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
            if (rgb) return [Number(rgb[1]), Number(rgb[2]), Number(rgb[3])];
            return null;
        };

        const getContrastColor = (value, darkColor, lightColor) => {
            const rgb = parseColor(value);
            if (!rgb) return darkColor;
            const [r, g, b] = rgb;
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.62 ? darkColor : lightColor;
        };

        const percentLabelPlugin = {
            id: 'percentLabelPlugin',
            afterDraw(chart, args, pluginOptions) {
                if (!pluginOptions || pluginOptions.display === false) return;
                const dataset = chart.data.datasets[0];
                if (!dataset) return;
                const data = dataset.data || [];
                const total = data.reduce((sum, v, idx) => {
                    const visible = typeof chart.getDataVisibility === 'function'
                        ? chart.getDataVisibility(idx) !== false
                        : true;
                    return visible ? sum + (Number(v) || 0) : sum;
                }, 0);
                if (!total) return;
                const ctx = chart.ctx;
                const fontSize = pluginOptions.fontSize || 11;
                const fontFamily = pluginOptions.fontFamily || 'Inter';
                const fontWeight = pluginOptions.fontWeight || '600';
                const minPercent = typeof pluginOptions.minPercent === 'number'
                    ? pluginOptions.minPercent
                    : 0;
                const precision = Number.isFinite(pluginOptions.precision)
                    ? pluginOptions.precision
                    : 0;
                ctx.save();
                ctx.font = `${fontWeight} ${fontSize}px ${fontFamily}`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const meta = chart.getDatasetMeta(0);
                const darkColor = pluginOptions.color || '#111827';
                const lightColor = pluginOptions.lightColor || '#FFFFFF';
                const useAutoColor = pluginOptions.autoColor === true;
                const shadowEnabled = pluginOptions.shadow !== false;
                meta.data.forEach((element, idx) => {
                    if (!element) return;
                    if (typeof chart.getDataVisibility === 'function' && !chart.getDataVisibility(idx)) return;
                    const value = Number(data[idx] || 0);
                    if (!value) return;
                    const percent = (value / total) * 100;
                    if (percent < minPercent) return;
                    const position = element.tooltipPosition();
                    const bgColor = Array.isArray(dataset.backgroundColor)
                        ? dataset.backgroundColor[idx]
                        : dataset.backgroundColor;
                    ctx.fillStyle = useAutoColor
                        ? getContrastColor(bgColor, darkColor, lightColor)
                        : darkColor;
                    if (shadowEnabled) {
                        ctx.shadowColor = 'rgba(15, 23, 42, 0.35)';
                        ctx.shadowBlur = 6;
                        ctx.shadowOffsetY = 2;
                    }
                    ctx.fillText(`${percent.toFixed(precision)}%`, position.x, position.y);
                    ctx.shadowColor = 'transparent';
                });
                ctx.restore();
            }
        };

        function renderGraphTaskStats() {
            const activeTasks = graphTasks.filter(task => {
                const taskName = String(task.task || '').trim().toLowerCase();
                const query = graphTaskQuery.toLowerCase();
                if (query && !taskName.includes(query)) return false;
                return true;
            });
            const totalMinutes = activeTasks.reduce((sum, task) => sum + Number(task.duration_minutes || 0), 0);
            const taskCount = activeTasks.length;
            const uniqueTasks = new Set(activeTasks.map(t => String(t.task || 'Untitled').trim())).size;
            const avgMinutes = uniqueTasks ? totalMinutes / uniqueTasks : 0;
            const statItem = (value, label) => `
                <div class="rounded-xl border border-slate-100 bg-white/80 px-3 py-3 text-center">
                    <div class="text-xl md:text-2xl font-light text-gray-900">${value}</div>
                    <div class="text-[10px] md:text-xs text-gray-500 mt-1 uppercase tracking-wider">${label}</div>
                </div>
            `;
            const stats = [
                statItem(uniqueTasks, 'Unique tasks'),
                statItem(formatHours(totalMinutes / 60), 'Total hours'),
                statItem(formatHours(avgMinutes / 60), 'Avg/task')
            ];
            if (graphTaskStats) {
                graphTaskStats.innerHTML = stats.join('');
            }
        }

        function renderGraphTaskChart() {
            if (!graphTaskChart) return;
            const activeTasks = graphTasks.filter(task => {
                const taskName = String(task.task || '').trim().toLowerCase();
                const query = graphTaskQuery.toLowerCase();
                if (query && !taskName.includes(query)) return false;
                return true;
            });
            if (!activeTasks.length) {
                graphTaskChart.innerHTML = '';
                return;
            }
            const taskGroups = {};
            activeTasks.forEach(task => {
                let key = String(task.task || '').trim();
                if (!key || /^(undefined|null|none|nan)$/i.test(key)) key = 'Unspecified';
                const hours = Number(task.duration_hours || 0);
                taskGroups[key] = (taskGroups[key] || 0) + hours;
            });
            const entries = Object.entries(taskGroups).sort((a, b) => b[1] - a[1]);
            const top = entries.slice(0, 6);
            const rest = entries.slice(6);
            let labels = top.map(e => e[0]);
            let values = top.map(e => e[1]);
            if (rest.length) {
                labels.push('Other');
                values.push(rest.reduce((s, e) => s + e[1], 0));
            }
            const baseColor = (graphColorScheme && graphColorScheme.primary) || metricColors[currentMetric] || '#111827';
            const accentColor = (graphColorScheme && graphColorScheme.secondary) || null;
            const palette = [baseColor, accentColor].filter(Boolean).concat(['#16A34A', '#A16207', '#7C3AED', '#0EA5A4', '#9F1239', '#9CA3AF', '#F59E0B']);
            const colors = labels.map((_, idx) => palette[idx % palette.length]);
            const isModalMobile = window.matchMedia('(max-width: 767px)').matches;
            graphTaskChart.innerHTML = '<div class="relative w-full px-4 md:px-8" style="height: 300px;"><canvas id="graphTaskChartCanvas" class="w-full h-full"></canvas></div><div id="graphTaskMobileLegend" class="mt-6 mb-2 md:hidden flex flex-wrap gap-2 justify-center text-[11px] text-gray-700 px-2"></div>';
            const mobileLegendEl = document.getElementById('graphTaskMobileLegend');
            if (mobileLegendEl && isModalMobile) {
                mobileLegendEl.innerHTML = labels.map((label, idx) => {
                    const color = colors[idx] || '#9CA3AF';
                    return `<span class="inline-flex items-center gap-1">
                        <span class="inline-block w-2.5 h-2.5 rounded-full" style="background:${color}"></span>
                        ${label}
                    </span>`;
                }).join('');
            }
            const legendGenerateLabels = (chart) => {
                const labels = chart.data.labels || [];
                const values = chart.data.datasets[0]?.data || [];
                const meta = chart.getDatasetMeta(0);
                return labels.map((rawLabel, idx) => {
                    const style = meta?.controller?.getStyle ? meta.controller.getStyle(idx) : {};
                    const baseText = String(rawLabel ?? '').trim();
                    const safeText = baseText && !/^(undefined|null|none|nan)$/i.test(baseText) ? baseText : 'Unspecified';
                    return {
                        text: safeText,
                        fillStyle: style.backgroundColor,
                        strokeStyle: style.borderColor,
                        lineWidth: style.borderWidth,
                        hidden: !chart.getDataVisibility(idx),
                        index: idx,
                        datasetIndex: 0
                    };
                });
            };
            const ctx = document.getElementById('graphTaskChartCanvas').getContext('2d');
            if (graphTaskChartInstance) {
                graphTaskChartInstance.destroy();
            }
            graphTaskChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#FFFFFF',
                        hoverOffset: 10,
                        hoverBorderWidth: 3
                    }]
                },
                plugins: [percentLabelPlugin],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    spacing: 3,
                    plugins: {
                        percentLabelPlugin: {
                            display: true,
                            fontSize: isModalMobile ? 10 : 11,
                            fontFamily: 'Inter',
                            fontWeight: '600',
                            color: '#111827',
                            lightColor: '#FFFFFF',
                            autoColor: true,
                            shadow: true,
                            minPercent: 3,
                            precision: 0
                        },
                        legend: {
                            display: !isModalMobile,
                            position: 'bottom',
                            labels: {
                                font: { family: 'Inter', size: 11, weight: '500' },
                                padding: 16,
                                color: '#374151',
                                usePointStyle: true,
                                pointStyle: 'circle',
                                boxWidth: 8,
                                boxHeight: 8
                            },
                            generateLabels: legendGenerateLabels,
                            onClick: function(e, legendItem, legend) {
                                const ci = legend.chart;
                                const index = legendItem.index;
                                const label = ci.data.labels[index];
                                const currentlyVisible = ci.getDataVisibility(index) !== false;
                                ci.toggleDataVisibility(index);
                                ci.update();
                                if (currentlyVisible) {
                                    graphHiddenTags[label] = true;
                                } else {
                                    delete graphHiddenTags[label];
                                }
                                renderGraphTaskList();
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(17, 24, 39, 0.96)',
                            padding: 14,
                            titleFont: { family: 'Inter', size: 13, weight: '600' },
                            bodyFont: { family: 'Inter', size: 12, weight: '400' },
                            cornerRadius: 10,
                            displayColors: true,
                            boxWidth: 10,
                            boxHeight: 10,
                            boxPadding: 6,
                            callbacks: {
                                label: function(context) {
                                    const raw = context.label;
                                    const label = String(raw ?? '').trim() || 'Unspecified';
                                    const value = Number(context.parsed || 0);
                                    const total = context.dataset.data.reduce((sum, v, idx) => {
                                        const visible = typeof context.chart.getDataVisibility === 'function'
                                            ? context.chart.getDataVisibility(idx) !== false
                                            : true;
                                        return visible ? sum + (Number(v) || 0) : sum;
                                    }, 0);
                                    const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value.toFixed(1)}h (${percent}%)`;
                                }
                            }
                        }
                    },
                    onClick: function(evt, elements) {
                        if (!elements || !elements.length) return;
                        const index = elements[0].index;
                        const label = graphTaskChartInstance.data.labels[index];
                        const currentlyVisible = graphTaskChartInstance.getDataVisibility(index) !== false;
                        graphTaskChartInstance.toggleDataVisibility(index);
                        graphTaskChartInstance.update();
                        if (currentlyVisible) {
                            graphHiddenTags[label] = true;
                        } else {
                            delete graphHiddenTags[label];
                        }
                        renderGraphTaskList();
                    }
                }
            });
        }

        function renderGraphTaskList() {
            if (!graphTasksList) return;
            let filteredTasks = graphTasks.filter(task => {
                const taskName = String(task.task || '').trim().toLowerCase();
                const query = graphTaskQuery.toLowerCase();
                if (query && !taskName.includes(query)) return false;
                if (graphHiddenTags[String(task.task || '').trim()]) return false;
                return true;
            });
            const sortKey = graphTaskSort || 'time_desc';
            if (sortKey === 'time_desc') {
                filteredTasks.sort((a, b) => {
                    const aTime = `${a.date} ${a.start_time}`;
                    const bTime = `${b.date} ${b.start_time}`;
                    return bTime.localeCompare(aTime);
                });
            } else if (sortKey === 'time_asc') {
                filteredTasks.sort((a, b) => {
                    const aTime = `${a.date} ${a.start_time}`;
                    const bTime = `${b.date} ${b.start_time}`;
                    return aTime.localeCompare(bTime);
                });
            } else if (sortKey === 'duration_desc') {
                filteredTasks.sort((a, b) => Number(b.duration_hours || 0) - Number(a.duration_hours || 0));
            } else if (sortKey === 'duration_asc') {
                filteredTasks.sort((a, b) => Number(a.duration_hours || 0) - Number(b.duration_hours || 0));
            } else if (sortKey === 'task_az') {
                filteredTasks.sort((a, b) => String(a.task || '').localeCompare(String(b.task || '')));
            } else if (sortKey === 'task_za') {
                filteredTasks.sort((a, b) => String(b.task || '').localeCompare(String(a.task || '')));
            }
            const html = filteredTasks.map(task => {
                const dur = Number(task.duration_hours || 0);
                const durText = dur >= 1 ? `${dur.toFixed(1)}h` : `${Math.round(dur * 60)} min`;
                const badges = [];
                if (task.important) badges.push('<span class="px-2 py-1 bg-emerald-50 text-emerald-700 text-xs rounded-full">Important</span>');
                if (task.urgent) badges.push('<span class="px-2 py-1 bg-red-50 text-red-700 text-xs rounded-full">Urgent</span>');
                const displayTag = task.tag || task.raw_tag || '';
                let tagBadge = '';
                if (displayTag) {
                    const tagColor = TAG_COLOR_MAP[displayTag] || '#6B7280';
                    const tagStyle = `background-color: ${tagColor}15; color: ${tagColor}; border: 1px solid ${tagColor}30;`;
                    tagBadge = `<span class="px-2 py-0.5 rounded-full text-xs font-medium" style="${tagStyle}">${displayTag}</span>`;
                }
                return `
                    <div class="luxury-card rounded-2xl p-4 md:p-5 mb-3 shadow-lg">
                        <div class="flex items-center justify-between gap-3">
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-gray-900 mb-1 truncate">${task.task || 'Untitled task'}</div>
                                <div class="flex flex-wrap items-center gap-2 text-[13px] text-gray-600">
                                    <span class="text-gray-500">${task.date}</span>
                                    <span class="text-gray-500">${task.start_time} - ${task.end_time}</span>
                                    ${tagBadge}
                                    ${badges.join('')}
                                </div>
                            </div>
                            <div class="shrink-0">
                                <span class="inline-flex px-2.5 py-1 rounded-full bg-white border border-slate-200 text-xs font-semibold text-gray-700">${durText}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            graphTasksList.innerHTML = html.join('');
        }

        function getEndDate() {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function movingAverage(values, windowSize = 7) {
            const result = [];
            for (let i = 0; i < values.length; i++) {
                const start = Math.max(0, i - windowSize + 1);
                const slice = values.slice(start, i + 1);
                const sum = slice.reduce((acc, v) => acc + v, 0);
                const avg = slice.length ? sum / slice.length : 0;
                result.push(Number(avg.toFixed(2)));
            }
            return result;
        }

        function hexToRgba(hex, alpha) {
            if (!hex || typeof hex !== 'string' || !hex.startsWith('#')) {
                return `rgba(17, 24, 39, ${alpha})`;
            }
            const clean = hex.replace('#', '');
            const bigint = parseInt(clean, 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        function deriveSearchColors(tasks) {
            if (!Array.isArray(tasks) || !tasks.length) return null;
            const totals = {};
            const priorityTotals = { q1: 0, q2: 0, q3: 0, q4: 0 };
            tasks.forEach(task => {
                const duration = Number(task.duration_minutes || 0);
                const tags = String(task.tag || task.raw_tag || '')
                    .split(',')
                    .map(t => t.trim())
                    .filter(Boolean);
                const usableTags = tags.length ? tags : ['Waste'];
                usableTags.forEach(tag => {
                    if (TAG_COLOR_MAP[tag]) {
                        totals[tag] = (totals[tag] || 0) + duration;
                    }
                });
                if (task.urgent && task.important) {
                    priorityTotals.q1 += duration;
                } else if (task.important) {
                    priorityTotals.q2 += duration;
                } else if (task.urgent) {
                    priorityTotals.q3 += duration;
                } else {
                    priorityTotals.q4 += duration;
                }
            });
            const sortedTags = Object.entries(totals).sort((a, b) => b[1] - a[1]);
            if (sortedTags.length) {
                const primary = TAG_COLOR_MAP[sortedTags[0][0]];
                const secondary = sortedTags[1] ? TAG_COLOR_MAP[sortedTags[1][0]] : null;
                return { primary, secondary };
            }
            const priorityPick = Object.entries(priorityTotals).sort((a, b) => b[1] - a[1])[0];
            if (priorityPick && priorityPick[1] > 0) {
                return { primary: metricColors[priorityPick[0]] || '#111827', secondary: null };
            }
            return null;
        }

        function getFocusLabel(value) {
            if (value === 'search_only') return 'Search only';
            return metricLabels[value] || value;
        }

        function updateSearchInputState() {
            const isSearchOnly = graphFocusValue === 'search_only';
            const comboEnabled = graphComboToggle.checked;
            if (isSearchOnly || comboEnabled) {
                graphSearchInput.removeAttribute('disabled');
                graphSearchInput.classList.remove('opacity-60', 'cursor-not-allowed');
            } else {
                graphSearchInput.value = '';
                graphSearchInput.setAttribute('disabled', 'disabled');
                graphSearchInput.classList.add('opacity-60', 'cursor-not-allowed');
            }
        }

        function updateFocusMenuActive() {
            document.querySelectorAll('.graph-focus-option').forEach(option => {
                if ((option.dataset.value || '') === graphFocusValue) {
                    option.dataset.active = 'true';
                } else {
                    option.dataset.active = 'false';
                }
            });
        }

        function setFocus(value, { fetch = true } = {}) {
            graphFocusValue = value;
            currentMetric = value === 'search_only' ? 'total' : value;
            graphFocusLabel.textContent = getFocusLabel(value);
            if (!graphComboToggle.checked && value !== 'search_only') {
                graphSearchQuery = '';
            }
            updateSearchInputState();
            updateFocusMenuActive();
            if (fetch) {
                fetchGraphData({ includeTasks: graphSearchQuery.length > 0 });
            }
        }

        function updateChart({ labels, values, total_hours, avg_hours, max_hours }, metricKey) {
            const ctx = document.getElementById('graphCanvas').getContext('2d');
            const colors = graphColorScheme || { primary: metricColors[metricKey] || '#111827', secondary: null };
            const color = colors.primary;
            const gradient = ctx.createLinearGradient(0, 0, 0, 320);
            gradient.addColorStop(0, hexToRgba(colors.primary, 0.55));
            gradient.addColorStop(1, hexToRgba(colors.secondary || colors.primary, 0.05));
            const avgValues = movingAverage(values, maWindow);
            const avgColor = color.startsWith('#') && color.length === 7 ? `${color}99` : 'rgba(17,24,39,0.55)';

            const shortLabels = labels.map(label => {
                const d = new Date(label);
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            const avgDataset = {
                label: `Moving avg (${maWindow}d)`,
                data: avgValues,
                borderColor: avgColor,
                borderWidth: 2,
                borderDash: [6, 6],
                fill: false,
                tension: 0.35,
                pointRadius: 0,
                pointHoverRadius: 0
            };

            if (chartInstance) {
                chartInstance.data.labels = shortLabels;
                chartInstance.data.datasets[0].data = values;
                chartInstance.data.datasets[0].borderColor = color;
                chartInstance.data.datasets[0].backgroundColor = gradient;
                if (chartInstance.data.datasets[1]) {
                    chartInstance.data.datasets[1].data = avgValues;
                    chartInstance.data.datasets[1].borderColor = avgColor;
                } else {
                    chartInstance.data.datasets.push(avgDataset);
                }
                chartInstance.update();
            } else {
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: shortLabels,
                        datasets: [
                            {
                                label: metricLabels[metricKey] || 'Time',
                                data: values,
                                borderColor: color,
                                backgroundColor: gradient,
                                borderWidth: 3,
                                fill: true,
                                tension: 0.35,
                                pointRadius: 2,
                                pointHoverRadius: 5
                            },
                            avgDataset
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(17, 24, 39, 0.96)',
                                padding: 12,
                                titleFont: { family: 'Inter', size: 12, weight: '600' },
                                bodyFont: { family: 'Inter', size: 12, weight: '400' },
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}h`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: { color: '#6B7280', maxTicksLimit: 8 }
                            },
                            y: {
                                grid: { color: 'rgba(148,163,184,0.25)' },
                                ticks: { color: '#6B7280' }
                            }
                        }
                    }
                });
            }

            totalHoursEl.textContent = formatHours(total_hours);
            avgHoursEl.textContent = formatHours(avg_hours);
            maxHoursEl.textContent = formatHours(max_hours);

            const label = metricLabels[metricKey] || 'Total time';
            if (graphFocusValue === 'search_only' && graphSearchQuery) {
                chartTitle.textContent = `Search: ${graphSearchQuery}`;
            } else {
                chartTitle.textContent = label;
            }
            const subtitleParts = [`Last ${currentDays} days`, `${maWindow}-day avg`];
            if (graphSearchQuery || graphExcludedIds.size) {
                subtitleParts.push('Filtered');
            }
            chartSubtitle.textContent = subtitleParts.join(' · ');
        }

        function buildGraphUrl(includeTasks = false) {
            const params = new URLSearchParams();
            params.set('metric', currentMetric);
            params.set('days', String(currentDays));
            params.set('end', getEndDate());
            if (graphSearchQuery) {
                params.set('search', graphSearchQuery);
            }
            if (includeTasks) {
                params.set('include_tasks', 'true');
            }
            if (graphExcludedIds.size) {
                params.set('exclude', Array.from(graphExcludedIds).join(','));
            }
            return `/api/graph-data?${params.toString()}`;
        }

        function openGraphTaskModal() {
            if (!graphTaskModal) return;
            const sortLabels = {
                time_desc: 'Time ↓',
                time_asc: 'Time ↑',
                duration_desc: 'Duration ↓',
                duration_asc: 'Duration ↑',
                task_az: 'Task A→Z',
                task_za: 'Task Z→A',
                tag_az: 'Tag A→Z',
                tag_za: 'Tag Z→A',
                imp_desc: 'Important first',
                urg_desc: 'Urgent first'
            };
            const sortToggles = {
                time: ['time_desc', 'time_asc'],
                duration: ['duration_desc', 'duration_asc'],
                task: ['task_az', 'task_za'],
                tag: ['tag_az', 'tag_za']
            };
            const resolveSort = (base) => {
                const options = sortToggles[base];
                if (!options) {
                    const fallback = base === 'imp' ? 'imp_desc' : base === 'urg' ? 'urg_desc' : 'time_desc';
                    return { key: fallback, label: sortLabels[fallback] || 'Time ↓' };
                }
                const current = graphTaskSort;
                const next = options.includes(current)
                    ? (current === options[0] ? options[1] : options[0])
                    : options[0];
                return { key: next, label: sortLabels[next] || 'Time ↓' };
            };
            if (graphTaskTools) {
                graphTaskTools.innerHTML = `
                    <div class="w-full flex items-center justify-between gap-2">
                        <div class="flex-1 min-w-0">
                            <input id="graphTaskSearch" type="search" placeholder="Search tasks..." class="w-full px-3 py-1.5 rounded-full bg-white border border-slate-200 text-xs text-gray-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-amber-300" />
                        </div>
                        <div class="relative shrink-0">
                            <button id="graphTaskSortBtn" class="px-3 py-1.5 rounded-full bg-white border border-slate-200 text-xs text-gray-700 shadow-sm active:scale-[0.98] transition">
                                Sort: <span id="graphTaskSortLabel">${sortLabels[graphTaskSort] || graphTaskSortLabel || 'Time ↓'}</span>
                            </button>
                            <div id="graphTaskSortMenu" class="absolute right-0 mt-2 w-44 bg-white rounded-xl shadow-2xl border border-slate-200 hidden">
                                <div class="dropdown-item" data-key="time">Time</div>
                                <div class="dropdown-item" data-key="duration">Duration</div>
                                <div class="dropdown-item" data-key="task">Task</div>
                                <div class="dropdown-item" data-key="tag">Tag</div>
                                <div class="dropdown-item" data-key="imp">Important first</div>
                                <div class="dropdown-item" data-key="urg">Urgent first</div>
                            </div>
                        </div>
                    </div>
                `;
                const btn = document.getElementById('graphTaskSortBtn');
                const menu = document.getElementById('graphTaskSortMenu');
                const label = document.getElementById('graphTaskSortLabel');
                const search = document.getElementById('graphTaskSearch');
                if (search) {
                    search.value = String(graphTaskQuery || '');
                    search.oninput = () => {
                        graphTaskQuery = search.value;
                        renderGraphTaskStats();
                        renderGraphTaskChart();
                        renderGraphTaskList();
                    };
                }
                if (btn && menu && label) {
                    btn.onclick = () => menu.classList.toggle('hidden');
                    menu.querySelectorAll('.dropdown-item').forEach(item => {
                        item.onclick = () => {
                            const base = item.getAttribute('data-key');
                            const next = resolveSort(base);
                            graphTaskSort = next.key;
                            graphTaskSortLabel = next.label;
                            label.textContent = next.label;
                            menu.classList.add('hidden');
                            renderGraphTaskList();
                        };
                    });
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('#graphTaskSortBtn') && !e.target.closest('#graphTaskSortMenu')) {
                            menu.classList.add('hidden');
                        }
                    });
                }
            }
            renderGraphTaskStats();
            renderGraphTaskChart();
            renderGraphTaskList();
            graphTaskModal.classList.add('active');
        }

        function closeGraphTaskModal() {
            if (!graphTaskModal) return;
            graphTaskModal.classList.remove('active');
        }

        function updateReviewButton() {
            const showButton = graphSearchQuery.length > 0 || graphExcludedIds.size > 0;
            if (showButton) {
                reviewGraphTasks.classList.remove('hidden');
                const countLabel = graphTasks.length ? ` (${graphTasks.length})` : '';
                reviewGraphTasks.textContent = `Review tasks${countLabel}`;
            } else {
                reviewGraphTasks.classList.add('hidden');
                reviewGraphTasks.textContent = 'Review tasks';
            }
        }


        async function fetchGraphData({ includeTasks = false, openModal = false } = {}) {
            const metricKey = currentMetric;
            const shouldIncludeTasks = includeTasks || graphSearchQuery.length > 0 || graphExcludedIds.size > 0;
            const url = buildGraphUrl(shouldIncludeTasks);
            try {
                const response = await fetch(url, { credentials: 'include' });
                if (response.status === 401) {
                    const nextUrl = encodeURIComponent(window.location.pathname + window.location.search);
                    window.location.href = `/login?next=${nextUrl}`;
                    return;
                }
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                updateChart(data, metricKey);
                if (shouldIncludeTasks) {
                    graphTasks = Array.isArray(data.tasks) ? data.tasks : [];
                    graphColorScheme = graphSearchQuery ? deriveSearchColors(graphTasks) : null;
                    updateReviewButton();
                } else {
                    graphTasks = [];
                    graphColorScheme = null;
                    updateReviewButton();
                }
                if (openModal && shouldIncludeTasks) {
                    openGraphTaskModal();
                }
            } catch (e) {
                console.error('Failed to load graph data', e);
            }
        }

        graphFocusBtn.addEventListener('click', () => {
            graphFocusMenu.classList.toggle('hidden');
        });

        document.querySelectorAll('.graph-focus-option').forEach(option => {
            option.addEventListener('click', () => {
                graphFocusMenu.classList.add('hidden');
                graphExcludedIds = new Set();
                setFocus(option.dataset.value || 'work');
            });
        });

        document.addEventListener('click', (event) => {
            if (!event.target.closest('#graphFocusBtn') && !event.target.closest('#graphFocusMenu')) {
                graphFocusMenu.classList.add('hidden');
            }
            if (graphHelpWrapper && !event.target.closest('#graphHelpWrapper')) {
                graphHelpTooltip.classList.add('hidden');
            }
        });

        if (graphHelpBtn && graphHelpTooltip) {
            graphHelpBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                graphHelpTooltip.classList.toggle('hidden');
            });
        }

        graphComboToggle.addEventListener('change', () => {
            updateSearchInputState();
            if (!graphComboToggle.checked && graphFocusValue !== 'search_only') {
                graphSearchQuery = '';
                graphExcludedIds = new Set();
                fetchGraphData();
            }
        });
        document.querySelectorAll('.range-pill').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.range-pill').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentDays = Number(btn.dataset.range || 30);
                fetchGraphData();
            });
        });

        document.querySelectorAll('.ma-pill').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.ma-pill').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                maWindow = Number(btn.dataset.ma || 7);
                fetchGraphData();
            });
        });

        graphSearchApply.addEventListener('click', () => {
            const query = (graphSearchInput.value || '').trim();
            graphExcludedIds = new Set();
            if (graphFocusValue === 'search_only') {
                graphSearchQuery = query;
                fetchGraphData({ includeTasks: true });
                return;
            }
            if (graphComboToggle.checked) {
                graphSearchQuery = query;
                fetchGraphData({ includeTasks: Boolean(query) });
                return;
            }
            graphSearchQuery = '';
            fetchGraphData();
        });

        graphSearchInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                graphSearchApply.click();
            }
        });

        graphSearchClear.addEventListener('click', () => {
            graphExcludedIds = new Set();
            graphSearchQuery = '';
            if (graphFocusValue === 'search_only' || graphComboToggle.checked) {
                graphSearchInput.value = '';
            }
            fetchGraphData();
        });

        reviewGraphTasks.addEventListener('click', () => {
            if (!graphTasks.length) {
                fetchGraphData({ includeTasks: true, openModal: true });
            } else {
                openGraphTaskModal();
            }
        });

        closeGraphTasks.addEventListener('click', closeGraphTaskModal);

        graphTaskModal.addEventListener('click', (event) => {
            if (event.target === graphTaskModal) {
                closeGraphTaskModal();
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && graphTaskModal.classList.contains('active')) {
                closeGraphTaskModal();
            }
        });

        setFocus('work');
    </script>
</body>
</html>
