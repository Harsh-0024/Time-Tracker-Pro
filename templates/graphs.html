<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#F7CF6B">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Time Tracker Pro">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="{{ pwa_manifest_url }}">
    <link rel="icon" href="{{ pwa_icon_url }}" type="image/png">
    <link rel="apple-touch-icon" href="{{ pwa_icon_url }}">
    <title>Graphs - Time Tracker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #F7F1E6 0%, #F2E6D5 40%, #E9DDCB 100%);
            color: #111827;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }
        .luxury-card {
            background: linear-gradient(135deg, #FEFCF8, #F5EDE1);
            border: 1px solid rgba(148, 126, 86, 0.18);
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.06);
        }
        .primary-cta {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.7rem 1.6rem;
            border-radius: 9999px;
            background: #111827;
            color: #F8D574;
            font-size: 0.9rem;
            letter-spacing: 0.03em;
            font-weight: 600;
            box-shadow: 0 14px 32px rgba(17, 24, 39, 0.55);
            border: 1px solid rgba(248, 213, 116, 0.4);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
        }
        .primary-cta:hover {
            transform: translateY(-1px);
            box-shadow: 0 20px 40px rgba(17, 24, 39, 0.7);
            filter: brightness(1.03);
        }
        .secondary-cta {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.55rem 1.4rem;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.75);
            color: #111827;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            border: 1px solid rgba(148, 126, 86, 0.35);
            box-shadow: 0 12px 24px rgba(148, 126, 86, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        }
        .secondary-cta:hover {
            background: #F7F1E6;
            transform: translateY(-1px);
            box-shadow: 0 16px 28px rgba(148, 126, 86, 0.3);
        }
        .soft-pill {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(148, 126, 86, 0.28);
        }
        .range-pill.active, .ma-pill.active {
            background: linear-gradient(135deg, #F8D574, #F5B826);
            color: #111827;
            box-shadow: 0 12px 26px rgba(185, 132, 40, 0.35);
        }
        .modal-backdrop {
            background: rgba(15, 23, 42, 0.55);
            backdrop-filter: blur(6px);
        }
    </style>
</head>
<body class="antialiased">
    <header class="bg-white/90 backdrop-blur border-b border-slate-200 shadow-sm" role="banner">
        <div class="max-w-6xl mx-auto px-6 md:px-8 py-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-semibold text-gray-900 tracking-tight">Time Tracker Pro</h1>
                    <p class="text-sm text-gray-500 mt-1">Trends and patterns over time</p>
                </div>
                <div class="flex items-center gap-3">
                    <a href="{{ url_for('main.dashboard') }}" class="px-4 py-2 rounded-full bg-white/80 border border-[rgba(148,126,86,0.35)] text-sm text-gray-700 hover:bg-[#F7F1E6] transition-all">Back to Dashboard</a>
                    {% if is_admin %}
                        <a href="{{ url_for('admin.admin_users') }}" class="md:hidden px-3 py-2 rounded-full bg-white/80 border border-[rgba(148,126,86,0.35)] text-xs font-semibold text-gray-700 hover:bg-[#F7F1E6] transition-all">Admin</a>
                    {% endif %}
                    {% if current_user and current_user.display_name %}
                        <div class="hidden md:flex items-center gap-2">
                            <div class="px-3 py-2 rounded-full bg-white/80 border border-[rgba(148,126,86,0.35)] text-xs font-semibold text-gray-800">
                                {{ current_user.display_name }}
                            </div>
                            {% if is_admin %}
                                <a href="{{ url_for('admin.admin_users') }}" class="px-3 py-2 rounded-full bg-white/80 border border-[rgba(148,126,86,0.35)] text-xs font-semibold text-gray-700 hover:bg-[#F7F1E6] transition-all">Admin</a>
                            {% endif %}
                            <a href="{{ url_for('auth.logout') }}" class="px-3 py-2 rounded-full bg-gray-900 text-amber-300 text-xs font-semibold shadow-lg">Logout</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 md:px-8 py-6 md:py-12 pb-20 md:pb-12">
        <div class="mb-6 md:mb-8">
            <h2 class="text-2xl md:text-4xl font-light text-gray-900 mb-1 md:mb-2">Time Trends</h2>
            <p class="text-sm md:text-base text-gray-600">Pick a focus and see how it moves across days.</p>
        </div>

        <div class="luxury-card rounded-2xl md:rounded-3xl p-4 md:p-8 mb-6 md:mb-8">
            <div class="space-y-5 md:space-y-0 md:grid md:gap-6 md:grid-cols-[1.2fr_1fr]">
                <div>
                    <label class="block text-xs md:text-sm font-medium text-gray-700 mb-3">Graph focus</label>
                    <div class="space-y-3">
                        <div class="flex flex-col lg:flex-row gap-3">
                            <input id="graphSearchInput" type="text" class="flex-1 px-4 py-3 rounded-2xl bg-white/80 border border-[rgba(148,126,86,0.35)] text-sm md:text-base text-gray-900 focus:outline-none focus:ring-2 focus:ring-amber-300" placeholder="sleep, rest · work · important and not work · workout or yoga">
                            <select id="graphFocusSelect" class="px-4 py-3 rounded-2xl bg-white/80 border border-[rgba(148,126,86,0.35)] text-sm md:text-base text-gray-900 font-medium focus:outline-none focus:ring-2 focus:ring-amber-300">
                                <option value="work" selected>Work</option>
                                <option value="necessity">Necessity</option>
                                <option value="soul">Soul</option>
                                <option value="rest">Rest</option>
                                <option value="waste">Waste</option>
                                <option value="important">Important</option>
                                <option value="urgent">Urgent</option>
                                <option value="q1">Important & Urgent (Critical)</option>
                                <option value="q2">Important & Not Urgent (Growth)</option>
                                <option value="q3">Urgent & Not Important (Drudgery)</option>
                                <option value="q4">Not Urgent & Not Important (Waste)</option>
                                <option value="total">Total time</option>
                                <option value="custom">Custom search</option>
                            </select>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button id="graphSearchApply" class="primary-cta text-sm md:text-base">Apply</button>
                            <button id="graphSearchClear" class="secondary-cta text-sm md:text-base">Clear</button>
                        </div>
                        <p class="text-xs text-gray-500">Pick a preset focus or switch to Custom search to type your own. Use commas or "or" for alternatives, "and" for strict matches, and "not" to exclude.</p>
                    </div>
                </div>
                <div>
                    <label class="block text-xs md:text-sm font-medium text-gray-700 mb-3">Time range</label>
                    <div class="flex flex-wrap gap-2 md:gap-3">
                        <button class="range-pill soft-pill px-3 md:px-4 py-2 rounded-full text-xs md:text-sm font-medium text-gray-700" data-range="7">7 days</button>
                        <button class="range-pill soft-pill px-3 md:px-4 py-2 rounded-full text-xs md:text-sm font-medium text-gray-700 active" data-range="30">30 days</button>
                        <button class="range-pill soft-pill px-3 md:px-4 py-2 rounded-full text-xs md:text-sm font-medium text-gray-700" data-range="90">90 days</button>
                        <button class="range-pill soft-pill px-3 md:px-4 py-2 rounded-full text-xs md:text-sm font-medium text-gray-700" data-range="180">180 days</button>
                    </div>
                    <div class="mt-3">
                        <label class="block text-xs text-gray-500 mb-2">Moving average window</label>
                        <div class="flex gap-2">
                            <button class="ma-pill soft-pill px-3 py-1.5 rounded-full text-xs font-medium text-gray-700 active" data-ma="7">7d</button>
                            <button class="ma-pill soft-pill px-3 py-1.5 rounded-full text-xs font-medium text-gray-700" data-ma="14">14d</button>
                            <button class="ma-pill soft-pill px-3 py-1.5 rounded-full text-xs font-medium text-gray-700" data-ma="30">30d</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="luxury-card rounded-2xl md:rounded-3xl p-4 md:p-8 mb-6 md:mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 md:gap-4 mb-5 md:mb-6">
                <div>
                    <h3 class="text-lg md:text-xl font-semibold text-gray-900" id="chartTitle">Work</h3>
                    <p class="text-xs md:text-sm text-gray-500" id="chartSubtitle">Last 30 days · 7-day avg</p>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                    <button id="reviewGraphTasks" class="secondary-cta text-sm md:text-base hidden">Review tasks</button>
                    <button id="refreshGraph" class="primary-cta text-sm md:text-base px-4 md:px-6 py-2 md:py-3">Refresh</button>
                </div>
            </div>
            <div class="relative" style="height: 280px;">
                <canvas id="graphCanvas"></canvas>
            </div>
        </div>

        <div class="grid gap-3 md:gap-4 grid-cols-3">
            <div class="luxury-card rounded-xl md:rounded-2xl p-3 md:p-5 text-center">
                <p class="text-[10px] md:text-xs uppercase tracking-wider text-gray-500">Total Hours</p>
                <div class="text-xl md:text-2xl font-light text-gray-900 mt-1 md:mt-2" id="totalHours">0h</div>
            </div>
            <div class="luxury-card rounded-xl md:rounded-2xl p-3 md:p-5 text-center">
                <p class="text-[10px] md:text-xs uppercase tracking-wider text-gray-500">Avg/Day</p>
                <div class="text-xl md:text-2xl font-light text-gray-900 mt-1 md:mt-2" id="avgHours">0h</div>
            </div>
            <div class="luxury-card rounded-xl md:rounded-2xl p-3 md:p-5 text-center">
                <p class="text-[10px] md:text-xs uppercase tracking-wider text-gray-500">Best Day</p>
                <div class="text-xl md:text-2xl font-light text-gray-900 mt-1 md:mt-2" id="maxHours">0h</div>
            </div>
        </div>
    </main>

    <div id="graphTaskModal" class="fixed inset-0 z-50 hidden items-center justify-center px-4">
        <div class="modal-backdrop absolute inset-0"></div>
        <div class="relative w-full max-w-3xl rounded-3xl border border-[rgba(148,126,86,0.25)] bg-[#FFFDF8] p-6 md:p-8 shadow-2xl">
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
                <div>
                    <h4 class="text-lg md:text-xl font-semibold text-gray-900">Tasks in this graph</h4>
                    <p class="text-xs md:text-sm text-gray-500 mt-1" id="graphTasksSubtitle">Review and exclude any tasks you don’t want included.</p>
                </div>
                <button id="closeGraphTasks" class="secondary-cta text-xs md:text-sm">Close</button>
            </div>
            <div id="graphTasksList" class="mt-5 space-y-3 max-h-[55vh] overflow-y-auto pr-1"></div>
            <div id="graphTasksEmpty" class="mt-5 text-sm text-gray-500 hidden">No tasks match this search.</div>
        </div>
    </div>

    <script>
        const metricColors = {
            total: '#111827',
            important: '#2563EB',
            urgent: '#F97316',
            q1: '#F59E0B',
            q2: '#10B981',
            q3: '#94A3B8',
            q4: '#EF4444',
            work: '#10B981',
            necessity: '#F59E0B',
            soul: '#6366F1',
            rest: '#C4B5FD',
            waste: '#DC2626'
        };

        const metricLabels = {
            total: 'Total time',
            important: 'Important',
            urgent: 'Urgent',
            q1: 'Important & Urgent',
            q2: 'Important & Not Urgent',
            q3: 'Urgent & Not Important',
            q4: 'Not Urgent & Not Important',
            work: 'Work',
            necessity: 'Necessity',
            soul: 'Soul',
            rest: 'Rest',
            waste: 'Waste'
        };

        let currentDays = 30;
        let chartInstance = null;
        let currentMetric = 'work';
        let maWindow = 7;
        let graphSearchQuery = '';
        let graphExcludedIds = new Set();
        let graphTasks = [];

        const chartTitle = document.getElementById('chartTitle');
        const chartSubtitle = document.getElementById('chartSubtitle');
        const totalHoursEl = document.getElementById('totalHours');
        const avgHoursEl = document.getElementById('avgHours');
        const maxHoursEl = document.getElementById('maxHours');
        const graphSearchInput = document.getElementById('graphSearchInput');
        const graphSearchApply = document.getElementById('graphSearchApply');
        const graphSearchClear = document.getElementById('graphSearchClear');
        const graphFocusSelect = document.getElementById('graphFocusSelect');
        const reviewGraphTasks = document.getElementById('reviewGraphTasks');
        const graphTaskModal = document.getElementById('graphTaskModal');
        const graphTasksList = document.getElementById('graphTasksList');
        const graphTasksEmpty = document.getElementById('graphTasksEmpty');
        const graphTasksSubtitle = document.getElementById('graphTasksSubtitle');
        const closeGraphTasks = document.getElementById('closeGraphTasks');

        function formatHours(value) {
            const num = Number(value) || 0;
            return `${num.toFixed(1)}h`;
        }

        function getEndDate() {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        function movingAverage(values, windowSize = 7) {
            const result = [];
            for (let i = 0; i < values.length; i++) {
                const start = Math.max(0, i - windowSize + 1);
                const slice = values.slice(start, i + 1);
                const sum = slice.reduce((acc, v) => acc + v, 0);
                const avg = slice.length ? sum / slice.length : 0;
                result.push(Number(avg.toFixed(2)));
            }
            return result;
        }

        function updateChart({ labels, values, total_hours, avg_hours, max_hours }, metricKey) {
            const ctx = document.getElementById('graphCanvas').getContext('2d');
            const color = metricColors[metricKey] || '#111827';
            const gradient = ctx.createLinearGradient(0, 0, 0, 320);
            gradient.addColorStop(0, `${color}55`);
            gradient.addColorStop(1, `${color}05`);
            const avgValues = movingAverage(values, maWindow);
            const avgColor = color.startsWith('#') && color.length === 7 ? `${color}99` : 'rgba(17,24,39,0.55)';

            const shortLabels = labels.map(label => {
                const d = new Date(label);
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            const avgDataset = {
                label: `Moving avg (${maWindow}d)`,
                data: avgValues,
                borderColor: avgColor,
                borderWidth: 2,
                borderDash: [6, 6],
                fill: false,
                tension: 0.35,
                pointRadius: 0,
                pointHoverRadius: 0
            };

            if (chartInstance) {
                chartInstance.data.labels = shortLabels;
                chartInstance.data.datasets[0].data = values;
                chartInstance.data.datasets[0].borderColor = color;
                chartInstance.data.datasets[0].backgroundColor = gradient;
                if (chartInstance.data.datasets[1]) {
                    chartInstance.data.datasets[1].data = avgValues;
                    chartInstance.data.datasets[1].borderColor = avgColor;
                } else {
                    chartInstance.data.datasets.push(avgDataset);
                }
                chartInstance.update();
            } else {
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: shortLabels,
                        datasets: [
                            {
                                label: metricLabels[metricKey] || 'Time',
                                data: values,
                                borderColor: color,
                                backgroundColor: gradient,
                                borderWidth: 3,
                                fill: true,
                                tension: 0.35,
                                pointRadius: 2,
                                pointHoverRadius: 5
                            },
                            avgDataset
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(17, 24, 39, 0.96)',
                                padding: 12,
                                titleFont: { family: 'Inter', size: 12, weight: '600' },
                                bodyFont: { family: 'Inter', size: 12, weight: '400' },
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}h`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: { color: '#6B7280', maxTicksLimit: 8 }
                            },
                            y: {
                                grid: { color: 'rgba(148,163,184,0.25)' },
                                ticks: { color: '#6B7280' }
                            }
                        }
                    }
                });
            }

            totalHoursEl.textContent = formatHours(total_hours);
            avgHoursEl.textContent = formatHours(avg_hours);
            maxHoursEl.textContent = formatHours(max_hours);

            const label = metricLabels[metricKey] || 'Total time';
            if (graphFocusSelect.value === 'custom' && graphSearchQuery) {
                chartTitle.textContent = `Search: ${graphSearchQuery}`;
            } else {
                chartTitle.textContent = label;
            }
            const subtitleParts = [`Last ${currentDays} days`, `${maWindow}-day avg`];
            if (graphSearchQuery || graphExcludedIds.size) {
                subtitleParts.push('Filtered');
            }
            chartSubtitle.textContent = subtitleParts.join(' · ');
        }

        function buildGraphUrl(includeTasks = false) {
            const params = new URLSearchParams();
            params.set('metric', currentMetric);
            params.set('days', String(currentDays));
            params.set('end', getEndDate());
            if (graphSearchQuery) {
                params.set('search', graphSearchQuery);
            }
            if (includeTasks) {
                params.set('include_tasks', 'true');
            }
            if (graphExcludedIds.size) {
                params.set('exclude', Array.from(graphExcludedIds).join(','));
            }
            return `/api/graph-data?${params.toString()}`;
        }

        function openGraphTaskModal() {
            graphTaskModal.classList.remove('hidden');
            graphTaskModal.classList.add('flex');
        }

        function closeGraphTaskModal() {
            graphTaskModal.classList.add('hidden');
            graphTaskModal.classList.remove('flex');
        }

        function updateReviewButton() {
            const showButton = graphSearchQuery.length > 0 || graphExcludedIds.size > 0;
            if (showButton) {
                reviewGraphTasks.classList.remove('hidden');
                const countLabel = graphTasks.length ? ` (${graphTasks.length})` : '';
                reviewGraphTasks.textContent = `Review tasks${countLabel}`;
            } else {
                reviewGraphTasks.classList.add('hidden');
                reviewGraphTasks.textContent = 'Review tasks';
            }
        }

        function renderGraphTasks() {
            graphTasksList.innerHTML = '';
            if (!graphTasks.length) {
                graphTasksEmpty.classList.remove('hidden');
                graphTasksSubtitle.textContent = 'No tasks match this search.';
                return;
            }
            graphTasksEmpty.classList.add('hidden');
            const excludedText = graphExcludedIds.size ? ` · ${graphExcludedIds.size} removed` : '';
            graphTasksSubtitle.textContent = `Showing ${graphTasks.length} tasks${excludedText}.`;
            graphTasks.forEach(task => {
                const row = document.createElement('div');
                row.className = 'flex flex-col md:flex-row md:items-center md:justify-between gap-3 rounded-2xl border border-[rgba(148,126,86,0.2)] bg-white/80 px-4 py-3 shadow-sm';
                const tags = task.tag || task.raw_tag || 'No tags';
                const flags = [];
                if (task.important) flags.push('Important');
                if (task.urgent) flags.push('Urgent');
                row.innerHTML = `
                    <div>
                        <div class="text-sm font-semibold text-gray-900">${task.task || 'Untitled task'}</div>
                        <div class="text-xs text-gray-500 mt-1">${task.date} · ${task.start_time} - ${task.end_time} · ${Number(task.duration_hours || 0).toFixed(2)}h</div>
                        <div class="text-xs text-gray-500 mt-1">Tags: ${tags}</div>
                        ${flags.length ? `<div class="flex flex-wrap gap-2 mt-2">${flags.map(flag => `<span class="px-2 py-0.5 rounded-full text-[10px] font-semibold bg-amber-50 text-amber-700 border border-amber-200">${flag}</span>`).join('')}</div>` : ''}
                    </div>
                    <button class="secondary-cta text-xs md:text-sm" data-task-id="${task.id}">Remove</button>
                `;
                const removeBtn = row.querySelector('button');
                if (removeBtn) {
                    removeBtn.addEventListener('click', () => {
                        if (task.id) {
                            graphExcludedIds.add(task.id);
                            fetchGraphData({ includeTasks: true, openModal: true });
                        }
                    });
                }
                graphTasksList.appendChild(row);
            });
        }

        async function fetchGraphData({ includeTasks = false, openModal = false } = {}) {
            const metricKey = currentMetric;
            const shouldIncludeTasks = includeTasks || graphSearchQuery.length > 0 || graphExcludedIds.size > 0;
            const url = buildGraphUrl(shouldIncludeTasks);
            try {
                const response = await fetch(url, { credentials: 'include' });
                if (response.status === 401) {
                    const nextUrl = encodeURIComponent(window.location.pathname + window.location.search);
                    window.location.href = `/login?next=${nextUrl}`;
                    return;
                }
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                updateChart(data, metricKey);
                if (shouldIncludeTasks) {
                    graphTasks = Array.isArray(data.tasks) ? data.tasks : [];
                    updateReviewButton();
                    renderGraphTasks();
                } else {
                    graphTasks = [];
                    updateReviewButton();
                }
                if (openModal && shouldIncludeTasks) {
                    openGraphTaskModal();
                }
            } catch (e) {
                console.error('Failed to load graph data', e);
            }
        }

        function applyPresetFocus(value) {
            currentMetric = value;
            graphSearchQuery = '';
            graphExcludedIds = new Set();
            graphSearchInput.value = metricLabels[value] || value;
            graphSearchInput.setAttribute('disabled', 'disabled');
            graphSearchInput.classList.add('opacity-60', 'cursor-not-allowed');
            fetchGraphData();
        }

        function applyCustomFocus() {
            currentMetric = 'total';
            graphSearchQuery = '';
            graphExcludedIds = new Set();
            graphSearchInput.removeAttribute('disabled');
            graphSearchInput.classList.remove('opacity-60', 'cursor-not-allowed');
            graphSearchInput.value = '';
            graphSearchInput.focus();
            fetchGraphData();
        }

        graphFocusSelect.addEventListener('change', () => {
            if (graphFocusSelect.value === 'custom') {
                applyCustomFocus();
            } else {
                applyPresetFocus(graphFocusSelect.value);
            }
        });
        document.querySelectorAll('.range-pill').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.range-pill').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentDays = Number(btn.dataset.range || 30);
                fetchGraphData();
            });
        });

        document.querySelectorAll('.ma-pill').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.ma-pill').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                maWindow = Number(btn.dataset.ma || 7);
                fetchGraphData();
            });
        });

        document.getElementById('refreshGraph').addEventListener('click', fetchGraphData);

        graphSearchApply.addEventListener('click', () => {
            if (graphFocusSelect.value === 'custom') {
                graphSearchQuery = (graphSearchInput.value || '').trim();
                graphExcludedIds = new Set();
                fetchGraphData({ includeTasks: true });
            } else {
                applyPresetFocus(graphFocusSelect.value);
            }
        });

        graphSearchInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                graphSearchApply.click();
            }
        });

        graphSearchClear.addEventListener('click', () => {
            graphExcludedIds = new Set();
            if (graphFocusSelect.value === 'custom') {
                graphSearchInput.value = '';
                graphSearchQuery = '';
                fetchGraphData();
            } else {
                graphSearchQuery = '';
                applyPresetFocus(graphFocusSelect.value);
            }
        });

        reviewGraphTasks.addEventListener('click', () => {
            if (!graphTasks.length) {
                fetchGraphData({ includeTasks: true, openModal: true });
            } else {
                openGraphTaskModal();
            }
        });

        closeGraphTasks.addEventListener('click', closeGraphTaskModal);

        graphTaskModal.addEventListener('click', (event) => {
            if (event.target === graphTaskModal || event.target.classList.contains('modal-backdrop')) {
                closeGraphTaskModal();
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && !graphTaskModal.classList.contains('hidden')) {
                closeGraphTaskModal();
            }
        });

        if (graphFocusSelect.value === 'custom') {
            applyCustomFocus();
        } else {
            applyPresetFocus(graphFocusSelect.value);
        }
    </script>
</body>
</html>
