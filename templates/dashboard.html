<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#F7F1E6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Time Tracker Pro">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="{{ pwa_manifest_url }}">
    <link rel="icon" href="{{ pwa_icon_url }}" type="image/png">
    <link rel="apple-touch-icon" href="{{ pwa_icon_url }}">
    <title>Time Tracker Pro</title>
    <script src="https://cdn.tailwindcss.com" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #F7F1E6 0%, #F2E6D5 40%, #E9DDCB 100%);
            color: #111827;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }
        .luxury-card {
            background: linear-gradient(135deg, #FEFCF8, #F5EDE1);
            border: 1px solid rgba(148, 126, 86, 0.18);
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .luxury-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 26px 65px rgba(15, 23, 42, 0.14);
        }
        .matrix-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .matrix-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px 0 rgba(0, 0, 0, 0.08);
        }
        input[type="date"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            top: 0;
            left: 0;
        }
        .yellow-accent {
            background: linear-gradient(135deg, #F7CF6B 0%, #F5B826 45%, #FCE7A2 100%);
        }
        .selected-day {
            background: linear-gradient(135deg, #F7CF6B 0%, #F5B826 45%, #FCE7A2 100%);
            box-shadow: 0 16px 40px rgba(180, 136, 48, 0.45);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: radial-gradient(circle at top left, #FFFFFF 0%, #F9FAFB 55%, #E5E7EB 100%);
            border-radius: 24px;
            max-width: 900px;
            max-height: 90vh;
            width: 90%;
            overflow-y: auto;
            border: 1px solid rgba(15,23,42,0.08);
            box-shadow: 0 30px 80px rgba(15,23,42,0.32);
        }
        .dropdown {
            position: relative;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: rgba(255,255,255,0.98);
            border-radius: 12px;
            box-shadow: 0 20px 45px rgba(15,23,42,0.18);
            min-width: 240px;
            z-index: 50;
            border: 1px solid rgba(148,163,184,0.28);
        }
        .dropdown-menu.active {
            display: block;
        }
        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .dropdown-item:hover {
            background: #F9FAFB;
        }
        .period-selector {
            display: flex;
            gap: 4px;
            background: rgba(255, 255, 255, 0.45);
            padding: 4px;
            border-radius: 12px;
            border: 1px solid rgba(148, 126, 86, 0.32);
        }
        .period-btn {
            padding: 8px 16px;
            border-radius: 9999px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
            color: #6B7280;
        }
        .period-btn.active {
            background: linear-gradient(135deg, #F8D574, #F5B826);
            color: #111827;
            box-shadow: 0 10px 24px rgba(185, 132, 40, 0.35);
        }
        .primary-cta {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.8rem 1.9rem;
            border-radius: 9999px;
            background: #111827;
            color: #F8D574;
            font-size: 0.9rem;
            letter-spacing: 0.03em;
            font-weight: 600;
            box-shadow: 0 14px 32px rgba(17, 24, 39, 0.55);
            border: 1px solid rgba(248, 213, 116, 0.4);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
        }
        .primary-cta:hover {
            transform: translateY(-1px);
            box-shadow: 0 20px 40px rgba(17, 24, 39, 0.7);
            filter: brightness(1.03);
        }
        .water-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0.1) 100%);
            transition: height 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            --tilt-x: 0%;
            --tilt-rotate: 0deg;
        }
        .water-fill::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(ellipse at center, rgba(255,255,255,0.4) 0%, transparent 70%);
            animation: wave 8s ease-in-out infinite;
            transform: translate(var(--tilt-x), 0) rotate(var(--tilt-rotate));
            transition: transform 0.3s ease-out;
        }
        .water-fill::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(ellipse at center, rgba(255,255,255,0.3) 0%, transparent 70%);
            animation: wave 10s ease-in-out infinite reverse;
            transform: translate(calc(var(--tilt-x) * -1), 0) rotate(calc(var(--tilt-rotate) * -1));
            transition: transform 0.3s ease-out;
        }
        @keyframes wave {
            0%, 100% {
                transform: translate(var(--tilt-x, 0%), 0) rotate(var(--tilt-rotate, 0deg));
            }
            25% {
                transform: translate(calc(5% + var(--tilt-x, 0%)), -5%) rotate(calc(1deg + var(--tilt-rotate, 0deg)));
            }
            50% {
                transform: translate(calc(-5% + var(--tilt-x, 0%)), -10%) rotate(calc(-1deg + var(--tilt-rotate, 0deg)));
            }
            75% {
                transform: translate(calc(-5% + var(--tilt-x, 0%)), -5%) rotate(calc(0.5deg + var(--tilt-rotate, 0deg)));
            }
        }
        .primary-cta:active {
            transform: translateY(0);
            box-shadow: 0 10px 22px rgba(17, 24, 39, 0.5);
            filter: brightness(0.98);
        }
        .hover-swap {
            transition: opacity 0.2s ease-in-out;
        }
    </style>
    <style>
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>
<body class="antialiased overflow-x-hidden">

    <div id="globalLoading" class="fixed bottom-4 right-4 z-50 hidden">
        <div class="px-4 py-2 rounded-full bg-gray-900/90 text-xs text-gray-100 shadow-lg flex items-center gap-2">
            <span class="h-2 w-2 rounded-full bg-amber-400 animate-pulse"></span>
            <span>Loading insights…</span>
        </div>
    </div>

    <div id="globalError" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 hidden">
        <div class="px-4 py-2 rounded-full bg-red-600 text-xs text-white shadow-lg">
            <span id="globalErrorText"></span>
        </div>
    </div>

    <!-- Minimal Header -->
    <header class="bg-white/90 backdrop-blur border-b border-slate-200 shadow-sm" role="banner">
        <div class="max-w-7xl mx-auto px-4 md:px-8 py-4 md:py-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 md:gap-0">
                <div class="flex items-center justify-between md:block">
                    <div>
                        <h1 id="appTitleBtn" class="text-xl md:text-2xl font-semibold text-gray-900 tracking-tight cursor-pointer" aria-label="Sync and reload">Time Tracker Pro</h1>
                        <p class="text-xs md:text-sm text-gray-500 mt-0.5 md:mt-1">Personal productivity analytics</p>
                    </div>
                    <div class="flex items-center gap-2 md:hidden">
                        {% if is_admin %}
                            <a href="{{ url_for('admin.admin_users') }}" class="px-3 py-1.5 rounded-full bg-white/80 border border-[rgba(148,126,86,0.35)] text-xs font-semibold text-gray-700 hover:bg-[#F7F1E6] transition-all">Admin</a>
                        {% endif %}
                        {% if current_user and current_user.display_name %}
                            <a href="{{ url_for('main.settings') }}" class="px-3 py-1.5 rounded-full bg-white/80 border border-[rgba(148,126,86,0.35)] text-xs font-semibold text-gray-700 hover:bg-[#F7F1E6] transition-all">Settings</a>
                        {% endif %}
                    </div>
                </div>
                <div class="flex items-center gap-2 md:gap-4">
                    <!-- Period Selector -->
                    <div class="period-selector hidden md:flex">
                        <button class="period-btn {% if period == 'day' %}active{% endif %}" onclick="changePeriod('day')">Day</button>
                        <button class="period-btn {% if period == 'week' %}active{% endif %}" onclick="changePeriod('week')">Week</button>
                        <button class="period-btn {% if period == 'month' %}active{% endif %}" onclick="changePeriod('month')">Month</button>
                    </div>
                    <div id="datePicker" class="relative flex-1 md:flex-none">
                        <button type="button" onclick="toggleDatePicker()" class="w-full md:w-auto inline-flex items-center justify-center gap-1.5 md:gap-2 px-3 md:px-4 py-2 rounded-full bg-white/80 border border-[rgba(148,126,86,0.35)] text-xs md:text-sm text-gray-700 shadow-sm hover:bg-[#F7F1E6] transition-all duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-700 md:w-4 md:h-4">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            <span class="text-xs md:text-xs font-medium tracking-wide text-gray-700">
                                <span class="hidden sm:inline">{{ selected_date.strftime("%b %-d, %Y") if selected_date else "" }}</span>
                                <span class="sm:hidden">{{ selected_date.strftime("%b %-d") if selected_date else "" }}</span>
                            </span>
                        </button>
                        <div id="dateDropdown" class="hidden absolute left-1/2 -translate-x-1/2 md:left-auto md:translate-x-0 md:right-0 mt-3 w-72 rounded-2xl bg-[#FEFCF8] border border-[rgba(148,126,86,0.35)] shadow-2xl shadow-[rgba(15,23,42,0.18)] p-4 z-50">
                            <div class="flex items-center justify-between mb-4 text-sm text-gray-700">
                                <button type="button" onclick="navigateMonth(-1)" class="px-2 py-1 rounded-full hover:bg-[#F5EDE1]">&lsaquo;</button>
                                <div id="dateDropdownLabel" class="font-medium"></div>
                                <button type="button" onclick="navigateMonth(1)" class="px-2 py-1 rounded-full hover:bg-[#F5EDE1]">&rsaquo;</button>
                            </div>
                            <div class="grid grid-cols-7 gap-1 text-[11px] text-gray-400 mb-1">
                                <div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div>
                            </div>
                            <div id="dateGrid" class="grid grid-cols-7 gap-1 text-xs"></div>
                        </div>
                    </div>
                    {% if current_user and current_user.display_name %}
                        <div class="hidden md:flex items-center gap-2 pl-2">
                            <div class="px-3 py-2 rounded-full bg-white/80 border border-[rgba(148,126,86,0.35)] text-xs font-semibold text-gray-800">
                                {{ current_user.display_name }}
                            </div>
                            <a href="{{ url_for('main.graphs') }}" class="px-3 py-2 rounded-full bg-white/80 border border-[rgba(148,126,86,0.35)] text-xs font-semibold text-gray-700 hover:bg-[#F7F1E6] transition-all">Graphs</a>
                            {% if is_admin %}
                                <a href="{{ url_for('admin.admin_users') }}" class="px-3 py-2 rounded-full bg-white/80 border border-[rgba(148,126,86,0.35)] text-xs font-semibold text-gray-700 hover:bg-[#F7F1E6] transition-all">Admin</a>
                            {% endif %}
                            <a href="{{ url_for('main.settings') }}" class="px-3 py-2 rounded-full bg-white/80 border border-[rgba(148,126,86,0.35)] text-xs font-semibold text-gray-700 hover:bg-[#F7F1E6] transition-all">Settings</a>
                            <a href="{{ url_for('auth.logout') }}" class="px-3 py-2 rounded-full bg-gray-900 text-amber-300 text-xs font-semibold shadow-lg">Logout</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 md:px-8 pt-8 pb-24 md:py-12" role="main" id="top">

        <!-- Month Header & Controls -->
        <div class="mb-10 md:mb-12" id="monthHeader">
            <div class="md:hidden mb-6">
                <div class="flex w-full bg-white/80 border border-[rgba(148,126,86,0.35)] rounded-full p-1 shadow-sm">
                    <button onclick="changePeriod('day')" class="flex-1 py-2 rounded-full text-sm font-medium transition
                        {% if period == 'day' %} bg-amber-400 text-gray-900 shadow {% else %} text-gray-600 hover:bg-slate-50 {% endif %}">
                        Day
                    </button>
                    <button onclick="changePeriod('week')" class="flex-1 py-2 rounded-full text-sm font-medium transition
                        {% if period == 'week' %} bg-amber-400 text-gray-900 shadow {% else %} text-gray-600 hover:bg-slate-50 {% endif %}">
                        Week
                    </button>
                    <button onclick="changePeriod('month')" class="flex-1 py-2 rounded-full text-sm font-medium transition
                        {% if period == 'month' %} bg-amber-400 text-gray-900 shadow {% else %} text-gray-600 hover:bg-slate-50 {% endif %}">
                        Month
                    </button>
                </div>
            </div>
            <div class="flex items-center justify-between mb-6 md:mb-8">
                <div>
                    <h2 class="text-3xl md:text-4xl font-light text-gray-900 mb-1 md:mb-2 tracking-tight">{{ current_month }}</h2>
                    <p class="text-gray-700 md:text-gray-500 text-sm">Where did your day go?</p>
                </div>
                <div class="flex items-center gap-3 md:gap-4">
                    <!-- View Full Period Button -->
                    <button id="viewFullBtn" onclick="viewFullDay()" class="primary-cta hidden md:inline-flex">
                        View Full Day
                    </button>
                </div>
            </div>
            <div class="md:hidden flex items-center gap-3 mb-4">
                <button id="viewFullBtnMobile" onclick="viewFullDay()" class="px-5 py-3 rounded-full bg-gray-900 text-amber-300 text-sm font-semibold shadow-lg active:scale-[0.98] transition-transform">
                    View Full Day
                </button>
            </div>

            <!-- Week Selector (only show for day/week views) -->
            {% if period == 'day' or period == 'week' %}
            <div class="flex justify-start gap-6 overflow-x-auto pb-2">
                {% for day in week_days %}
                <a href="/?date={{ day.full_str }}&period={{ period }}" class="flex flex-col items-center min-w-[56px] group">
                    <span class="text-xs font-medium uppercase mb-3 tracking-wider
                        {% if day.is_selected %} text-gray-900 {% else %} text-gray-400 group-hover:text-gray-600 {% endif %}">
                        {{ day.day_name }}
                    </span>
                    <div class="w-14 h-14 flex items-center justify-center rounded-xl text-base font-semibold transition-all duration-200
                        {% if day.is_selected %}
                            selected-day text-white
                        {% else %}
                            bg-white text-gray-600 hover:bg-gray-50 luxury-card
                        {% endif %}">
                        {{ day.day_num }}
                    </div>
                </a>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        {% set top_tag_label = tags.labels[0] if tags.labels else 'No tags' %}
        {% set top_tag_hours = tags.data[0] if tags.data else 0 %}
        {% set total_tag_hours = (tags.data | sum) if tags.data else 0 %}
        {% set top_tag_pct = ((top_tag_hours / total_tag_hours) * 100) | round(1) if total_tag_hours else 0 %}
        {% set top_quad_label = 'Critical' %}
        {% set top_quad_sub = 'Important & Urgent' %}
        {% set top_quad_pct = matrix.q1.pct %}
        {% set top_quad_hours = matrix.q1.hours %}
        {% set top_quad_key = 'q1' %}
        {% if matrix.q2.pct > top_quad_pct %}
            {% set top_quad_label = 'Growth' %}
            {% set top_quad_sub = 'Important & Not Urgent' %}
            {% set top_quad_pct = matrix.q2.pct %}
            {% set top_quad_hours = matrix.q2.hours %}
            {% set top_quad_key = 'q2' %}
        {% endif %}
        {% if matrix.q3.pct > top_quad_pct %}
            {% set top_quad_label = 'Drudgery' %}
            {% set top_quad_sub = 'Urgent & Not Important' %}
            {% set top_quad_pct = matrix.q3.pct %}
            {% set top_quad_hours = matrix.q3.hours %}
            {% set top_quad_key = 'q3' %}
        {% endif %}
        {% if matrix.q4.pct > top_quad_pct %}
            {% set top_quad_label = 'Waste' %}
            {% set top_quad_sub = 'Not Urgent & Not Important' %}
            {% set top_quad_pct = matrix.q4.pct %}
            {% set top_quad_hours = matrix.q4.hours %}
            {% set top_quad_key = 'q4' %}
        {% endif %}
        <div class="md:hidden mb-6">
            <div class="luxury-card rounded-2xl p-5 flex items-center justify-between cursor-pointer" data-filter="{{ top_quad_key }}" data-title="{{ top_quad_label }}" data-chart="tasks" role="button">
                <div>
                    <div class="text-xs font-semibold tracking-[0.16em] text-gray-400 uppercase">Dominant quadrant</div>
                    <div class="mt-2 text-2xl font-light text-gray-900"><span class="js-hover-hours js-summary-hours" data-summary-hours data-total-hours="{{ top_quad_hours }}" data-hours="{{ top_quad_hours }}">{{ top_quad_hours }}h</span></div>
                    <div class="text-[11px] text-gray-500 mt-1">{{ top_quad_sub }} · {{ top_quad_pct }}%</div>
                </div>
                <span class="inline-flex h-9 px-3 items-center rounded-full bg-[#ECFDF3] text-[11px] font-medium tracking-wide text-[#047857] border border-emerald-200">
                    {{ top_quad_label }}
                </span>
            </div>
        </div>
        <div class="hidden md:grid grid-cols-3 gap-6 mb-12">
            <div class="luxury-card rounded-2xl p-8 flex flex-col justify-between cursor-pointer" data-filter="all" data-title="Full {{ period | title }} Log" data-chart="tasks" role="button">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <div class="text-xs font-semibold tracking-[0.16em] text-gray-400 uppercase" id="summaryPeriodTitle" data-total-label="Period total" data-avg-label="Period avg">Period total</div>
                        <div class="mt-2 text-3xl font-light text-gray-900"><span class="js-hover-hours js-summary-hours" data-summary-hours data-total-hours="{{ matrix.total_hours }}" data-hours="{{ matrix.total_hours }}">{{ matrix.total_hours }}h</span></div>
                    </div>
                    <span class="inline-flex h-9 px-3 items-center rounded-full bg-[#111827] text-[11px] font-medium tracking-wide text-[#F8D574] border border-[rgba(248,213,116,0.35)]">
                        All logged
                    </span>
                </div>
                <div class="w-full h-2 rounded-full bg-[#E7D8C2] overflow-hidden">
                    <div class="h-full rounded-full bg-gradient-to-r from-[#111827] via-[#111827] to-[#F5B826]" style="width: 100%"></div>
                </div>
                <div class="mt-3 text-xs text-gray-500" id="summaryPeriodCaption" data-total-text="{{ current_month }} · {{ period | title }} view totals." data-avg-text="{{ current_month }} · {{ period | title }} avg/day.">{{ current_month }} · {{ period | title }} view totals.</div>
            </div>
            <div class="luxury-card rounded-2xl p-8 flex flex-col justify-between {% if tags.labels %}cursor-pointer{% endif %}" {% if tags.labels %}data-filter="tag" data-title="{{ top_tag_label }}" data-tag="{{ top_tag_label }}" data-chart="tasks" role="button"{% endif %}>
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <div class="text-xs font-semibold tracking-[0.16em] text-gray-400 uppercase">Top category</div>
                        <div class="mt-2 text-3xl font-light text-gray-900"><span class="js-hover-hours js-summary-hours" data-summary-hours data-total-hours="{{ top_tag_hours }}" data-hours="{{ top_tag_hours }}">{{ top_tag_hours | round(1) }}h</span></div>
                        <div class="mt-1 text-xs text-gray-500">{{ top_tag_pct }}% of period</div>
                    </div>
                    <span class="inline-flex h-9 px-3 items-center rounded-full bg-[#FDF3DF] text-[11px] font-medium tracking-wide text-[#92400E] border border-amber-200">
                        {{ top_tag_label }}
                    </span>
                </div>
                <div class="w-full h-2 rounded-full bg-[#E7D8C2] overflow-hidden">
                    <div class="h-full rounded-full bg-gradient-to-r from-[#F97316] via-[#F59E0B] to-[#FACC15]" style="width: {{ top_tag_pct }}%"></div>
                </div>
                <div class="mt-3 text-xs text-gray-500">{{ top_tag_pct }}% of logged time this period.</div>
            </div>
            <div class="luxury-card rounded-2xl p-8 flex flex-col justify-between cursor-pointer" data-filter="{{ top_quad_key }}" data-title="{{ top_quad_label }}" data-chart="tasks" role="button">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <div class="text-xs font-semibold tracking-[0.16em] text-gray-400 uppercase">Dominant quadrant</div>
                        <div class="mt-2 text-3xl font-light text-gray-900"><span class="js-hover-hours js-summary-hours" data-summary-hours data-total-hours="{{ top_quad_hours }}" data-hours="{{ top_quad_hours }}">{{ top_quad_hours }}h</span></div>
                    </div>
                    <span class="inline-flex h-9 px-3 items-center rounded-full bg-[#ECFDF3] text-[11px] font-medium tracking-wide text-[#047857] border border-emerald-200">
                        {{ top_quad_label }}
                    </span>
                </div>
                <div class="w-full h-2 rounded-full bg-[#E7D8C2] overflow-hidden">
                    <div class="h-full rounded-full bg-gradient-to-r from-[#22C55E] via-[#A3E635] to-[#FACC15]" style="width: {{ top_quad_pct }}%"></div>
                </div>
                <div class="mt-3 text-xs text-gray-500">{{ top_quad_sub }} · {{ top_quad_pct }}% share.</div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8 md:mt-0">

            <!-- Priority Matrix - Extended Eisenhower Matrix -->
            <div class="lg:col-span-2" id="matrix">
                <div class="mb-6">
                    <h3 class="text-2xl font-light text-gray-900 mb-1">Priority Breakdown</h3>
                    <p class="text-sm text-gray-500">Extended Eisenhower Matrix analysis</p>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-2 md:gap-4">
                    <!-- Desktop: 3x3 Grid - Row1(Q1,Q2,Important), Row2(Q3,Q4,NotImportant), Row3(Urgent,NotUrgent,Total) -->
                    <!-- Mobile: 2 columns, natural flow unchanged -->
                    
                    <!-- Q1: Critical - Important & Urgent (Desktop: Row 1, Col 1) -->
                    <div class="matrix-card luxury-card rounded-xl md:rounded-2xl p-3 md:p-5 bg-gradient-to-br from-amber-50/80 to-yellow-50/40 border-amber-200/60 hover:shadow-lg transition-all duration-300 relative overflow-hidden md:order-1" onclick="viewMatrixQuadrant('q1', 'Critical')">
                        <div class="water-fill" style="height: {{ matrix.q1.pct }}%; background: linear-gradient(180deg, rgba(251, 191, 36, 0.45) 0%, rgba(245, 158, 11, 0.35) 100%);"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-2 md:mb-4">
                                <div>
                                    <h4 class="text-amber-800 font-semibold text-sm md:text-base mb-0.5">Critical</h4>
                                    <p class="text-[8px] md:text-[10px] text-amber-700/80 font-medium uppercase tracking-wider">Important & Urgent</p>
                                </div>
                                <div class="text-lg md:text-xl text-amber-400/70">◆</div>
                            </div>
                            <div class="text-2xl md:text-3xl font-light text-gray-900 mb-1"><span class="js-hover-hours matrix-hours" data-matrix-key="q1" data-total-hours="{{ matrix.q1.hours }}" data-hours="{{ matrix.q1.hours }}">{{ matrix.q1.hours }}h</span></div>
                            <div class="text-[10px] md:text-xs font-medium text-amber-700/70">{{ matrix.q1.pct }}%</div>
                        </div>
                    </div>

                    <!-- Q2: Growth - Important & Not Urgent (Desktop: Row 1, Col 2) -->
                    <div class="matrix-card luxury-card rounded-xl md:rounded-2xl p-3 md:p-5 bg-gradient-to-br from-green-100/70 to-emerald-50/50 border-green-200/60 hover:shadow-lg transition-all duration-300 relative overflow-hidden md:order-2" onclick="viewMatrixQuadrant('q2', 'Growth')">
                        <div class="water-fill" style="height: {{ matrix.q2.pct }}%; background: linear-gradient(180deg, rgba(52, 211, 153, 0.45) 0%, rgba(16, 185, 129, 0.35) 100%);"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-2 md:mb-4">
                                <div>
                                    <h4 class="text-green-800 font-semibold text-sm md:text-base mb-0.5">Growth</h4>
                                    <p class="text-[8px] md:text-[10px] text-green-700/90 font-medium uppercase tracking-wider">Important & Not Urgent</p>
                                </div>
                                <div class="text-lg md:text-xl text-green-400/80">★</div>
                            </div>
                            <div class="text-2xl md:text-3xl font-light text-gray-900 mb-1"><span class="js-hover-hours matrix-hours" data-matrix-key="q2" data-total-hours="{{ matrix.q2.hours }}" data-hours="{{ matrix.q2.hours }}">{{ matrix.q2.hours }}h</span></div>
                            <div class="text-[10px] md:text-xs font-medium text-green-700/80">{{ matrix.q2.pct }}%</div>
                        </div>
                    </div>

                    <!-- Q3: Drudgery - Urgent & Not Important (Desktop: Row 2, Col 1) -->
                    <div class="matrix-card luxury-card rounded-xl md:rounded-2xl p-3 md:p-5 bg-gradient-to-br from-slate-200/70 to-zinc-100/50 border-slate-300/60 hover:shadow-lg transition-all duration-300 relative overflow-hidden md:order-4" onclick="viewMatrixQuadrant('q3', 'Drudgery')">
                        <div class="water-fill" style="height: {{ matrix.q3.pct }}%; background: linear-gradient(180deg, rgba(148, 163, 184, 0.45) 0%, rgba(100, 116, 139, 0.35) 100%);"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-2 md:mb-4">
                                <div>
                                    <h4 class="text-slate-600 font-semibold text-sm md:text-base mb-0.5">Drudgery</h4>
                                    <p class="text-[8px] md:text-[10px] text-slate-500/80 font-medium uppercase tracking-wider">Urgent & Not Important</p>
                                </div>
                                <div class="text-lg md:text-xl text-slate-400/70">⛓</div>
                            </div>
                            <div class="text-2xl md:text-3xl font-light text-slate-700 mb-1"><span class="js-hover-hours matrix-hours" data-matrix-key="q3" data-total-hours="{{ matrix.q3.hours }}" data-hours="{{ matrix.q3.hours }}">{{ matrix.q3.hours }}h</span></div>
                            <div class="text-[10px] md:text-xs font-medium text-slate-500/70">{{ matrix.q3.pct }}%</div>
                        </div>
                    </div>

                    <!-- Q4: Waste - Not Important & Not Urgent (Desktop: Row 2, Col 2) -->
                    <div class="matrix-card luxury-card rounded-xl md:rounded-2xl p-3 md:p-5 bg-gradient-to-br from-red-100/60 to-rose-50/40 border-red-200/50 hover:shadow-lg transition-all duration-300 relative overflow-hidden md:order-5" onclick="viewMatrixQuadrant('q4', 'Waste')">
                        <div class="water-fill" style="height: {{ matrix.q4.pct }}%; background: linear-gradient(180deg, rgba(248, 113, 113, 0.45) 0%, rgba(239, 68, 68, 0.35) 100%);"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-2 md:mb-4">
                                <div>
                                    <h4 class="text-red-700 font-semibold text-sm md:text-base mb-0.5">Waste</h4>
                                    <p class="text-[8px] md:text-[10px] text-red-600/80 font-medium uppercase tracking-wider">Not Important & Not Urgent</p>
                                </div>
                                <div class="text-lg md:text-xl text-red-300/70">×</div>
                            </div>
                            <div class="text-2xl md:text-3xl font-light text-gray-900 mb-1"><span class="js-hover-hours matrix-hours" data-matrix-key="q4" data-total-hours="{{ matrix.q4.hours }}" data-hours="{{ matrix.q4.hours }}">{{ matrix.q4.hours }}h</span></div>
                            <div class="text-[10px] md:text-xs font-medium text-red-600/70">{{ matrix.q4.pct }}%</div>
                        </div>
                    </div>

                    <!-- Important (All) - Blue (Desktop: Row 1, Col 3) -->
                    <div class="matrix-card luxury-card rounded-xl md:rounded-2xl p-3 md:p-5 bg-gradient-to-br from-blue-50/70 to-indigo-50/40 border-blue-200/60 hover:shadow-lg transition-all duration-300 relative overflow-hidden md:order-3" onclick="viewMatrixQuadrant('important', 'Important')">
                        <div class="water-fill" style="height: {{ matrix.important.pct }}%; background: linear-gradient(180deg, rgba(96, 165, 250, 0.45) 0%, rgba(59, 130, 246, 0.35) 100%);"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-2 md:mb-4">
                                <div>
                                    <h4 class="text-blue-800 font-semibold text-sm md:text-base mb-0.5">Important</h4>
                                    <p class="text-[8px] md:text-[10px] text-blue-700/80 font-medium uppercase tracking-wider">All Important</p>
                                </div>
                                <div class="text-lg md:text-xl text-blue-400/70">●</div>
                            </div>
                            <div class="text-2xl md:text-3xl font-light text-gray-900 mb-1"><span class="js-hover-hours matrix-hours" data-matrix-key="important" data-total-hours="{{ matrix.important.hours }}" data-hours="{{ matrix.important.hours }}">{{ matrix.important.hours }}h</span></div>
                            <div class="text-[10px] md:text-xs font-medium text-blue-700/70">{{ matrix.important.pct }}%</div>
                        </div>
                    </div>

                    <!-- Not Important (All) - Very Light Neutral (Desktop: Row 2, Col 3) -->
                    <div class="matrix-card luxury-card rounded-xl md:rounded-2xl p-3 md:p-5 bg-gradient-to-br from-neutral-100/50 to-stone-50/30 border-neutral-200/50 hover:shadow-lg transition-all duration-300 relative overflow-hidden md:order-6" onclick="viewMatrixQuadrant('not_important', 'Not Important')">
                        <div class="water-fill" style="height: {{ matrix.not_important.pct }}%; background: linear-gradient(180deg, rgba(163, 163, 163, 0.45) 0%, rgba(115, 115, 115, 0.35) 100%);"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-2 md:mb-4">
                                <div>
                                    <h4 class="text-neutral-500 font-semibold text-sm md:text-base mb-0.5">Not Important</h4>
                                    <p class="text-[8px] md:text-[10px] text-neutral-400/80 font-medium uppercase tracking-wider">All Not Important</p>
                                </div>
                                <div class="text-lg md:text-xl text-neutral-300/70">○</div>
                            </div>
                            <div class="text-2xl md:text-3xl font-light text-neutral-600 mb-1"><span class="js-hover-hours matrix-hours" data-matrix-key="not_important" data-total-hours="{{ matrix.not_important.hours }}" data-hours="{{ matrix.not_important.hours }}">{{ matrix.not_important.hours }}h</span></div>
                            <div class="text-[10px] md:text-xs font-medium text-neutral-400/70">{{ matrix.not_important.pct }}%</div>
                        </div>
                    </div>

                    <!-- Urgent (All) - Orange/Amber (Desktop: Row 3, Col 1) -->
                    <div class="matrix-card luxury-card rounded-xl md:rounded-2xl p-3 md:p-5 bg-gradient-to-br from-orange-100/70 to-amber-50/40 border-orange-200/60 hover:shadow-lg transition-all duration-300 relative overflow-hidden md:order-7" onclick="viewMatrixQuadrant('urgent', 'Urgent')">
                        <div class="water-fill" style="height: {{ matrix.urgent.pct }}%; background: linear-gradient(180deg, rgba(251, 146, 60, 0.45) 0%, rgba(249, 115, 22, 0.35) 100%);"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-2 md:mb-4">
                                <div>
                                    <h4 class="text-orange-800 font-semibold text-sm md:text-base mb-0.5">Urgent</h4>
                                    <p class="text-[8px] md:text-[10px] text-orange-700/80 font-medium uppercase tracking-wider">All Urgent</p>
                                </div>
                                <div class="text-lg md:text-xl text-orange-400/70">⚡</div>
                            </div>
                            <div class="text-2xl md:text-3xl font-light text-gray-900 mb-1"><span class="js-hover-hours matrix-hours" data-matrix-key="urgent" data-total-hours="{{ matrix.urgent.hours }}" data-hours="{{ matrix.urgent.hours }}">{{ matrix.urgent.hours }}h</span></div>
                            <div class="text-[10px] md:text-xs font-medium text-orange-700/70">{{ matrix.urgent.pct }}%</div>
                        </div>
                    </div>

                    <!-- Not Urgent (All) - Soft Teal/Green (Desktop: Row 3, Col 2) -->
                    <div class="matrix-card luxury-card rounded-xl md:rounded-2xl p-3 md:p-5 bg-gradient-to-br from-teal-50/70 to-green-50/40 border-teal-200/60 hover:shadow-lg transition-all duration-300 relative overflow-hidden md:order-8" onclick="viewMatrixQuadrant('not_urgent', 'Not Urgent')">
                        <div class="water-fill" style="height: {{ matrix.not_urgent.pct }}%; background: linear-gradient(180deg, rgba(45, 212, 191, 0.45) 0%, rgba(20, 184, 166, 0.35) 100%);"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-2 md:mb-4">
                                <div>
                                    <h4 class="text-teal-800 font-semibold text-sm md:text-base mb-0.5">Not Urgent</h4>
                                    <p class="text-[8px] md:text-[10px] text-teal-700/80 font-medium uppercase tracking-wider">All Not Urgent</p>
                                </div>
                                <div class="text-lg md:text-xl text-teal-400/70">◇</div>
                            </div>
                            <div class="text-2xl md:text-3xl font-light text-gray-900 mb-1"><span class="js-hover-hours matrix-hours" data-matrix-key="not_urgent" data-total-hours="{{ matrix.not_urgent.hours }}" data-hours="{{ matrix.not_urgent.hours }}">{{ matrix.not_urgent.hours }}h</span></div>
                            <div class="text-[10px] md:text-xs font-medium text-teal-700/70">{{ matrix.not_urgent.pct }}%</div>
                        </div>
                    </div>

                    <!-- Total - Neutral Grey/Beige (Desktop: Row 3, Col 3) -->
                    <div class="matrix-card luxury-card rounded-xl md:rounded-2xl p-3 md:p-5 bg-gradient-to-br from-stone-100/50 to-neutral-50/30 border-stone-200/40 hover:shadow-lg transition-all duration-300 relative overflow-hidden col-span-2 md:col-span-1 md:order-9 cursor-pointer" id="matrixTotalCard" onclick="window.toggleMatrixMode()">
                        <div class="water-fill" style="height: 100%; background: linear-gradient(180deg, rgba(168, 162, 158, 0.45) 0%, rgba(120, 113, 108, 0.35) 100%);"></div>
                        <div class="relative z-10">
                            <div class="flex justify-between items-start mb-2 md:mb-4">
                                <div>
                                    <h4 class="text-stone-600 font-semibold text-sm md:text-base mb-0.5" id="matrixTotalTitle">Total</h4>
                                    <p class="text-[8px] md:text-[10px] text-stone-500/80 font-medium uppercase tracking-wider" id="matrixTotalSubtitle">All Time Logged</p>
                                </div>
                                <div class="text-lg md:text-xl text-stone-400/70">∑</div>
                            </div>
                            <div class="text-2xl md:text-3xl font-light text-stone-700 mb-1"><span class="js-hover-hours matrix-hours" data-matrix-key="total" data-total-hours="{{ matrix.total_hours }}" data-hours="{{ matrix.total_hours }}">{{ matrix.total_hours }}h</span></div>
                            <div class="text-[10px] md:text-xs font-medium text-stone-500/70" id="matrixTotalPct">100%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-8">
                <div class="luxury-card rounded-2xl p-6 md:p-8 h-full flex flex-col {% if tags.labels %}cursor-pointer{% endif %}" id="tags" {% if tags.labels %}onclick="window.applyFilter('all', 'By Category')"{% endif %}>
                    <div class="mb-4 md:mb-6">
                        <h3 class="text-xl font-light text-gray-900 mb-1">Time by Category</h3>
                        <p class="text-xs text-gray-500">Tag distribution</p>
                    </div>
                    <div class="relative w-full flex-1 flex flex-col items-center justify-center min-h-0" role="img" aria-label="Time spent by tag category">
                        {% if tags.labels %}
                        <div class="w-full h-[14rem] md:h-auto md:flex-1 md:min-h-[18rem] lg:min-h-[22rem] flex items-center justify-center">
                            <canvas id="tagChart" aria-hidden="true"></canvas>
                        </div>
                        <div id="mobileTagLegend" class="mt-3 md:hidden flex flex-wrap gap-2 justify-center text-[11px] text-gray-700 px-2"></div>
                        {% else %}
                        <div class="text-center py-12">
                            <div class="text-5xl text-gray-200 mb-3">∅</div>
                            <p class="text-sm text-gray-400">No data for<br>{{ selected_date }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Mobile-only Focus Time card removed as requested -->

                <!-- Weekly Progress removed for visual consistency -->
            </div>
        </div>

    </main>

    <nav class="fixed bottom-0 inset-x-0 md:hidden z-40">
        <div class="mx-auto max-w-7xl">
            <div class="flex items-center justify-around bg-white/95 backdrop-blur border-t border-slate-200 shadow-lg px-2 py-2" style="padding-bottom: env(safe-area-inset-bottom);">
                <button id="navHome" class="flex flex-col items-center gap-1 px-3 py-1 rounded-xl text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.6" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l9-9 9 9M5 10v10h14V10" />
                    </svg>
                    <span class="text-[10px] font-medium">Home</span>
                </button>
                <button id="navMatrix" class="flex flex-col items-center gap-1 px-3 py-1 rounded-xl text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.6" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4h7v7H4zM13 4h7v7h-7zM4 13h7v7H4zM13 13h7v7h-7z" />
                    </svg>
                    <span class="text-[10px] font-medium">Matrix</span>
                </button>
                <button id="navTags" class="flex flex-col items-center gap-1 px-3 py-1 rounded-xl text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.6" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 7h9.5a2.5 2.5 0 012.5 2.5V19L13 15H5a2 2 0 01-2-2V9a2 2 0 012-2z" />
                    </svg>
                    <span class="text-[10px] font-medium">Tags</span>
                </button>
                <button id="navGraphs" class="flex flex-col items-center gap-1 px-3 py-1 rounded-xl text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.6" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 18V6m0 12h16M8 14l3-3 3 2 4-5" />
                    </svg>
                    <span class="text-[10px] font-medium">Graphs</span>
                </button>
            </div>
        </div>
    </nav>


    <!-- Modal for Task Details -->
    <div id="taskModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-content p-8" role="document">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-2xl font-semibold text-gray-900"></h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div id="modalTools" class="mb-4 flex items-center justify-end"></div>
            <div id="modalStats" class="mb-6 grid grid-cols-3 gap-4"></div>
            <div id="modalChart" class="mb-12 md:mb-6"></div>
            <div id="modalTasks" class="mt-6 md:mt-0 space-y-3"></div>
        </div>
    </div>

    <script>
        // Global variables
        window.currentDate = '{{ selected_date }}';
        window.currentPeriod = '{{ period }}';
        window.periodStart = '{{ start_date }}';
        window.periodEnd = '{{ end_date }}';
        window.avgStart = '{{ avg_start_date }}';
        window.avgEnd = '{{ avg_end_date }}';

        // Define functions globally
        window.changePeriod = function(period) {
            window.location.href = `/?date=${window.currentDate}&period=${period}`;
        };

        window.changeDate = function(date) {
            window.location.href = `/?date=${date}&period=${window.currentPeriod}`;
        };

        window.toggleDatePicker = function() {
            const dropdown = document.getElementById('dateDropdown');
            if (!dropdown) return;
            dropdown.classList.toggle('hidden');
        };

        window.navigateMonth = function(offset) {
            if (!window.dateCursor) {
                window.dateCursor = new Date(window.currentDate);
            }
            window.dateCursor.setMonth(window.dateCursor.getMonth() + offset);
            window.renderDateGrid();
        };

        window.renderDateGrid = function() {
            const grid = document.getElementById('dateGrid');
            const label = document.getElementById('dateDropdownLabel');
            if (!grid || !label) return;

            const base = window.dateCursor ? new Date(window.dateCursor) : new Date(window.currentDate);
            const year = base.getFullYear();
            const month = base.getMonth();

            const first = new Date(year, month, 1);
            const startDay = first.getDay();
            const last = new Date(year, month + 1, 0);
            const totalDays = last.getDate();

            label.textContent = base.toLocaleString('default', { month: 'long', year: 'numeric' });

            grid.innerHTML = '';
            for (let i = 0; i < startDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'h-8';
                grid.appendChild(empty);
            }

            const selected = new Date(window.currentDate);
            for (let day = 1; day <= totalDays; day++) {
                const d = new Date(year, month, day);
                const btn = document.createElement('button');
                const isSelected = d.toDateString() === selected.toDateString();
                btn.textContent = day;
                btn.className = [
                    'h-8 w-8 flex items-center justify-center rounded-full text-xs',
                    isSelected
                        ? 'bg-[#111827] text-[#F8D574] shadow'
                        : 'text-gray-700 hover:bg-[#F5EDE1]'
                ].join(' ');
                btn.onclick = function() {
                    const iso = d.toISOString().slice(0, 10);
                    window.changeDate(iso);
                };
                grid.appendChild(btn);
            }
        };

        window.viewFullDay = function() {
            const period = window.currentPeriod || 'day';
            const periodMap = { 'day': 'Day', 'week': 'Week', 'month': 'Month' };
            const periodLabel = periodMap[period] || 'Day';
            console.log('View Full ' + periodLabel + ' clicked');
            window.applyFilter('all', 'Full ' + periodLabel + ' Log', '', 'tags');
        };

        window.toggleDropdown = function() {};

        window.closeDropdown = function() {};

        window.viewMatrixQuadrant = function(quadrant, name) {
            console.log('Matrix quadrant clicked:', quadrant, name);
            window.applyFilter(quadrant, name, '', 'tags');
        };

        window.getPeriodDays = function() {
            try {
                const start = new Date(window.periodStart);
                const end = new Date(window.periodEnd);
                const avgStart = window.avgStart ? new Date(window.avgStart) : start;
                const avgEnd = window.avgEnd ? new Date(window.avgEnd) : end;
                if (
                    Number.isNaN(start.valueOf())
                    || Number.isNaN(end.valueOf())
                    || Number.isNaN(avgStart.valueOf())
                    || Number.isNaN(avgEnd.valueOf())
                ) {
                    return 1;
                }
                const effectiveStart = avgStart > start ? avgStart : start;
                const effectiveEnd = avgEnd < end ? avgEnd : end;
                if (effectiveEnd < effectiveStart) {
                    return 1;
                }
                const diff = Math.round((effectiveEnd - effectiveStart) / (1000 * 60 * 60 * 24));
                return Math.max(1, diff + 1);
            } catch (e) {
                return 1;
            }
        };

        window.updateMatrixDisplay = function() {
            const period = window.currentPeriod || 'day';
            const isMultiDay = period === 'week' || period === 'month';
            const mode = isMultiDay ? (window.matrixMode || 'avg') : 'total';
            const days = isMultiDay ? window.getPeriodDays() : 1;
            const useAverage = mode === 'avg' && days > 0;
            const formatHours = (h) => {
                const val = Number(h);
                return Number.isFinite(val) ? val.toFixed(1) : '0.0';
            };

            document.querySelectorAll('.matrix-hours').forEach(el => {
                const total = Number(el.getAttribute('data-total-hours') || 0);
                const display = useAverage ? (total / days) : total;
                el.setAttribute('data-hours', display);
                el.textContent = `${formatHours(display)}h`;
            });

            document.querySelectorAll('[data-summary-hours]').forEach(el => {
                const total = Number(el.getAttribute('data-total-hours') || 0);
                const display = useAverage ? (total / days) : total;
                el.setAttribute('data-hours', display);
                el.textContent = `${formatHours(display)}h`;
            });

            const summaryTitle = document.getElementById('summaryPeriodTitle');
            if (summaryTitle) {
                const totalLabel = summaryTitle.getAttribute('data-total-label') || 'Period total';
                const avgLabel = summaryTitle.getAttribute('data-avg-label') || 'Period avg';
                summaryTitle.textContent = useAverage && isMultiDay ? avgLabel : totalLabel;
            }
            const summaryCaption = document.getElementById('summaryPeriodCaption');
            if (summaryCaption) {
                const totalText = summaryCaption.getAttribute('data-total-text');
                const avgText = summaryCaption.getAttribute('data-avg-text');
                summaryCaption.textContent = useAverage && isMultiDay
                    ? (avgText || summaryCaption.textContent)
                    : (totalText || summaryCaption.textContent);
            }

            const titleEl = document.getElementById('matrixTotalTitle');
            const subtitleEl = document.getElementById('matrixTotalSubtitle');
            if (titleEl && subtitleEl) {
                if (useAverage && isMultiDay) {
                    titleEl.textContent = 'Average';
                    subtitleEl.textContent = 'Per Day';
                } else if (isMultiDay) {
                    titleEl.textContent = 'Total';
                    subtitleEl.textContent = 'Period Total';
                } else {
                    titleEl.textContent = 'Total';
                    subtitleEl.textContent = 'All Time Logged';
                }
            }
            if (window.attachHoverSwap) window.attachHoverSwap();
        };

        window.toggleMatrixMode = function() {
            const period = window.currentPeriod || 'day';
            if (period !== 'week' && period !== 'month') return;
            window.matrixMode = window.matrixMode === 'avg' ? 'total' : 'avg';
            window.updateMatrixDisplay();
        };

        // Decimal helpers (global) used by modal and charts
        window.ensureFinite = function(n) {
            const v = Number(n);
            return Number.isFinite(v) ? v : 0;
        };
        window.minutesFromHours = function(h) {
            return Math.round(window.ensureFinite(h) * 60);
        };
        window.formatHours = function(h, decimals = 1) {
            return window.ensureFinite(h).toFixed(decimals);
        };

        const parseColor = (value) => {
            if (!value) return null;
            const raw = String(value).trim();
            const hex = raw.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
            if (hex) {
                const hexValue = hex[1];
                const full = hexValue.length === 3
                    ? hexValue.split('').map(c => c + c).join('')
                    : hexValue;
                const intVal = parseInt(full, 16);
                return [(intVal >> 16) & 255, (intVal >> 8) & 255, intVal & 255];
            }
            const rgb = raw.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
            if (rgb) return [Number(rgb[1]), Number(rgb[2]), Number(rgb[3])];
            return null;
        };

        const getContrastColor = (value, darkColor, lightColor) => {
            const rgb = parseColor(value);
            if (!rgb) return darkColor;
            const [r, g, b] = rgb;
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.62 ? darkColor : lightColor;
        };

        const percentLabelPlugin = {
            id: 'percentLabelPlugin',
            afterDraw(chart, args, pluginOptions) {
                if (!pluginOptions || pluginOptions.display === false) return;
                const dataset = chart.data.datasets[0];
                if (!dataset) return;
                const data = dataset.data || [];
                const total = data.reduce((sum, v, idx) => {
                    const visible = typeof chart.getDataVisibility === 'function'
                        ? chart.getDataVisibility(idx) !== false
                        : true;
                    return visible ? sum + (Number(v) || 0) : sum;
                }, 0);
                if (!total) return;
                const ctx = chart.ctx;
                const fontSize = pluginOptions.fontSize || 11;
                const fontFamily = pluginOptions.fontFamily || 'Inter';
                const fontWeight = pluginOptions.fontWeight || '600';
                const minPercent = typeof pluginOptions.minPercent === 'number'
                    ? pluginOptions.minPercent
                    : 0;
                const precision = Number.isFinite(pluginOptions.precision)
                    ? pluginOptions.precision
                    : 1;
                ctx.save();
                ctx.font = `${fontWeight} ${fontSize}px ${fontFamily}`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const meta = chart.getDatasetMeta(0);
                const darkColor = pluginOptions.color || '#111827';
                const lightColor = pluginOptions.lightColor || '#FFFFFF';
                const useAutoColor = pluginOptions.autoColor === true;
                const shadowEnabled = pluginOptions.shadow !== false;
                meta.data.forEach((element, idx) => {
                    if (!element) return;
                    if (typeof chart.getDataVisibility === 'function' && !chart.getDataVisibility(idx)) return;
                    const value = Number(data[idx] || 0);
                    if (!value) return;
                    const pct = (value / total) * 100;
                    if (pct < minPercent) return;
                    const bg = Array.isArray(dataset.backgroundColor)
                        ? dataset.backgroundColor[idx]
                        : dataset.backgroundColor;
                    const textColor = useAutoColor
                        ? getContrastColor(bg, darkColor, lightColor)
                        : darkColor;
                    ctx.fillStyle = textColor;
                    if (shadowEnabled && textColor === lightColor) {
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.35)';
                        ctx.shadowBlur = 3;
                        ctx.shadowOffsetY = 1;
                    } else {
                        ctx.shadowColor = 'transparent';
                        ctx.shadowBlur = 0;
                        ctx.shadowOffsetY = 0;
                    }
                    const pos = element.tooltipPosition();
                    ctx.fillText(`${pct.toFixed(precision)}%`, pos.x, pos.y);
                });
                ctx.restore();
            }
        };

        const TAG_COLOR_MAP = {
            'Work': '#10B981',
            'Necessity': '#F59E0B',
            'Soul': '#6366F1',
            'Rest': '#C4B5FD',
            'Waste': '#DC2626'
        };

        const SPECIAL_TAGS = Object.keys(TAG_COLOR_MAP);

        function extractSpecialTags(tag) {
            if (!tag) return [];
            return String(tag)
                .split(',')
                .map(part => {
                    let clean = String(part || '').trim();
                    clean = clean.replace(/[^A-Za-z\s]+$/g, '').replace(/\s+/g, ' ').trim();
                    if (!clean || /^(undefined|null|none|nan|urg|urgent|imp|important)$/i.test(clean)) return '';
                    return clean.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
                })
                .filter(Boolean)
                .filter(tagName => SPECIAL_TAGS.includes(tagName));
        }

        function normalizeTagName(tag) {
            const tags = extractSpecialTags(tag);
            return tags[0] || 'Waste';
        }

        function formatTagNames(tag) {
            const tags = extractSpecialTags(tag);
            return tags.length ? tags.join(', ') : 'Waste';
        }

        function hoursToHuman(h) {
            const total = Math.max(0, Math.round(Number(h || 0) * 60));
            const hrs = Math.floor(total / 60);
            const mins = total % 60;
            if (hrs === 0) return `${mins} min`;
            if (mins === 0) return `${hrs} hr`;
            if (mins === 30) return `${hrs}.5 hr`;
            return `${hrs} hr ${mins} min`;
        }
        window.attachHoverSwap = function() {
            document.querySelectorAll('.js-hover-hours').forEach(el => {
                if (el.__hoverBound) return;
                const raw = el.getAttribute('data-hours') || el.textContent;
                const h = Number(raw);
                if (isNaN(h)) return;
                const decimalText = `${window.formatHours(h, 1)}h`;
                const humanText = hoursToHuman(h);
                el.classList.add('hover-swap', 'cursor-default');
                el.addEventListener('mouseenter', () => {
                    el.style.opacity = '0';
                    el.style.transform = 'scale(0.98)';
                    setTimeout(() => {
                        el.textContent = humanText;
                        el.style.opacity = '1';
                        el.style.transform = 'scale(1)';
                    }, 100);
                });
                el.addEventListener('mouseleave', () => {
                    el.style.opacity = '0';
                    el.style.transform = 'scale(0.98)';
                    setTimeout(() => {
                        el.textContent = decimalText;
                        el.style.opacity = '1';
                        el.style.transform = 'scale(1)';
                    }, 100);
                });
                el.__hoverBound = true;
            });
        };

        function setGlobalLoading(isLoading, errorMessage = '') {
            const loadingEl = document.getElementById('globalLoading');
            const errorEl = document.getElementById('globalError');
            const errorText = document.getElementById('globalErrorText');
            if (!loadingEl || !errorEl || !errorText) return;
            if (isLoading) {
                loadingEl.classList.remove('hidden');
                errorEl.classList.add('hidden');
                errorText.textContent = '';
            } else {
                loadingEl.classList.add('hidden');
                if (errorMessage) {
                    errorText.textContent = errorMessage;
                    errorEl.classList.remove('hidden');
                    setTimeout(() => {
                        errorEl.classList.add('hidden');
                    }, 4000);
                }
            }
        }

        window.applyFilter = function(filterType, title, tagName = '', chartMode = 'auto') {
            console.log('applyFilter called:', filterType, title, tagName, chartMode);
            window.closeDropdown();
            const url = `/api/tasks?date=${window.currentDate}&period=${window.currentPeriod}&filter=${filterType}${tagName ? '&tag=' + encodeURIComponent(tagName) : ''}`;

            console.log('Fetching:', url);
            setGlobalLoading(true);
            fetch(url)
                .then(r => {
                    console.log('Response status:', r.status);
                    if (r.status === 401) {
                        const nextUrl = encodeURIComponent(window.location.pathname + window.location.search);
                        window.location.href = `/login?next=${nextUrl}`;
                        throw new Error('Unauthorized');
                    }
                    if (!r.ok) {
                        throw new Error(`HTTP error! status: ${r.status}`);
                    }
                    return r.json();
                })
                .then(data => {
                    console.log('Data received:', data);
                    setGlobalLoading(false);
                    window.modalSort = 'time_desc';
                    window.modalSortLabel = 'Time ↓';
                    window.showModal(title, data, filterType, chartMode);
                })
                .catch(error => {
                    console.error('Error fetching tasks:', error);
                    setGlobalLoading(false, 'Error loading tasks: ' + error.message);
                    try {
                        const fallback = { tasks: [], total_hours: 0, total_minutes: 0, count: 0 };
                        window.showModal(title, fallback, filterType, chartMode);
                    } catch (e) {
                        console.error('Failed to open modal fallback', e);
                    }
                });
        };

        window.renderModalTasks = function() {
            const container = document.getElementById('modalTasks');
            if (!container || !window.modalData) return;
            const hidden = window.hiddenTags || {};
            const tasks = window.modalData.tasks || [];
            const filterType = window.modalFilterType || 'all';
            const sortKey = window.modalSort || 'time_desc';
            const query = String(window.modalQuery || '').trim().toLowerCase();
            const queryParts = query
                ? query.split(',').map(s => String(s || '').trim().toLowerCase()).filter(Boolean)
                : [];
            const parsedTerms = queryParts
                .map(part => {
                    const match = part.match(/^(?:if\s+not|not)\s+(.+)$/);
                    if (match && match[1]) {
                        return { term: match[1].trim(), negate: true };
                    }
                    return { term: part, negate: false };
                })
                .filter(item => item.term);
            const includeTerms = parsedTerms.filter(item => !item.negate).map(item => item.term);
            const excludeTerms = parsedTerms.filter(item => item.negate).map(item => item.term);
            const timeToMinutes = (value) => {
                if (!value) return 0;
                const parts = String(value).trim().match(/(\d{1,2})(?::(\d{2}))?\s*(AM|PM)?/i);
                if (!parts) return 0;
                let hour = Number(parts[1] || 0);
                const minute = Number(parts[2] || 0);
                const meridian = (parts[3] || '').toUpperCase();
                if (meridian === 'PM' && hour < 12) hour += 12;
                if (meridian === 'AM' && hour === 12) hour = 0;
                return (hour * 60) + minute;
            };
            const getKey = (task) => {
                if (filterType === 'tag') {
                    let key = String(task.task || '').trim();
                    if (!key || /^(undefined|null|none|nan)$/i.test(key)) key = 'Unspecified';
                    return key;
                }
                return normalizeTagName(task.tag);
            };
            const active = Object.keys(hidden).length
                ? tasks.filter(t => !hidden[getKey(t)])
                : tasks.slice();
            window.modalActiveTasks = active;
            const matchesTerm = (t, term) => {
                const clean = String(term || '').trim().toLowerCase();
                if (!clean) return true;
                if (clean === 'imp' || clean === 'important') {
                    return Number(t.important) > 0;
                }
                if (clean === 'urg' || clean === 'urgent') {
                    return Number(t.urgent) > 0;
                }
                const taskText = String(t.task || '').toLowerCase();
                const tagText = String(formatTagNames(t.tag) || '').toLowerCase();
                const rawTag = String(t.tag || '').toLowerCase();
                return taskText.includes(clean) || tagText.includes(clean) || rawTag.includes(clean);
            };
            const searched = parsedTerms.length
                ? active.filter(t => {
                    const matchesInclude = includeTerms.length
                        ? includeTerms.some(part => matchesTerm(t, part))
                        : true;
                    if (!matchesInclude) return false;
                    if (excludeTerms.length && excludeTerms.some(part => matchesTerm(t, part))) return false;
                    return true;
                })
                : active;
            const sorters = {
                time_asc: (a, b) => timeToMinutes(a.start_time) - timeToMinutes(b.start_time),
                time_desc: (a, b) => timeToMinutes(b.start_time) - timeToMinutes(a.start_time),
                duration_desc: (a, b) => (b.duration || 0) - (a.duration || 0),
                duration_asc: (a, b) => (a.duration || 0) - (b.duration || 0),
                task_az: (a, b) => String(a.task || '').localeCompare(String(b.task || '')),
                task_za: (a, b) => String(b.task || '').localeCompare(String(a.task || '')),
                tag_az: (a, b) => normalizeTagName(a.tag).localeCompare(normalizeTagName(b.tag)),
                tag_za: (a, b) => normalizeTagName(b.tag).localeCompare(normalizeTagName(a.tag)),
                imp_desc: (a, b) => Number(b.important) - Number(a.important),
                urg_desc: (a, b) => Number(b.urgent) - Number(a.urgent)
            };
            searched.sort(sorters[sortKey] || sorters.time_desc);
            if (searched.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-400">No tasks found</div>';
                if (window.renderModalStats) window.renderModalStats();
                return;
            }
            let html = '';
            searched.forEach(task => {
                const dur = Number(task.duration || 0);
                const durText = hoursToHuman(isNaN(dur) ? 0 : dur);
                const badges = [];
                if (task.important) badges.push('<span class="px-2 py-1 bg-emerald-50 text-emerald-700 text-xs rounded-full">Important</span>');
                if (task.urgent) badges.push('<span class="px-2 py-1 bg-red-50 text-red-700 text-xs rounded-full">Urgent</span>');
                const displayTag = formatTagNames(task.tag);
                const primaryTag = normalizeTagName(task.tag);
                let tagBadge = '';
                if (displayTag) {
                    const tagColor = TAG_COLOR_MAP[primaryTag] || '#6B7280';
                    const tagStyle = `background-color: ${tagColor}15; color: ${tagColor}; border: 1px solid ${tagColor}30;`;
                    tagBadge = `<span class="px-2 py-0.5 rounded-full text-xs font-medium" style="${tagStyle}">${displayTag}</span>`;
                }
                html += `
                    <div class="luxury-card rounded-2xl p-4 md:p-5 mb-3 shadow-lg">
                        <div class="flex items-center justify-between gap-3">
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-gray-900 mb-1 truncate">${task.task}</div>
                                <div class="flex flex-wrap items-center gap-2 text-[13px] text-gray-600">
                                    <span class="text-gray-500">${task.date}</span>
                                    <span class="text-gray-500">${task.start_time} - ${task.end_time}</span>
                                    ${tagBadge}
                                    ${badges.join('')}
                                </div>
                            </div>
                            <div class="shrink-0">
                                <span class="inline-flex px-2.5 py-1 rounded-full bg-white border border-slate-200 text-xs font-semibold text-gray-700 js-hover-hours hover-swap" data-hours="${dur}">${durText}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            window.attachHoverSwap();
            if (window.renderModalStats) window.renderModalStats();
        };

        window.showModal = function(title, data, filterType, chartMode = 'auto') {
            const modal = document.getElementById('taskModal');
            if (!modal) return;
            window.modalData = data;
            window.modalFilterType = filterType;
            window.modalChartMode = chartMode || 'auto';
            window.modalQuery = '';
            window.hiddenTags = window.hiddenTags || {};
            document.getElementById('modalTitle').textContent = title;

            const periodMinutes = ensureFinite(data.period_minutes || data.total_minutes || 0);
            const period = window.currentPeriod || 'day';
            const isMultiDay = period === 'week' || period === 'month';
            const dayCount = isMultiDay ? window.getPeriodDays() : 1;
            window.modalStatsMode = isMultiDay ? 'avg' : 'total';

            const periodMatrix = data.period_matrix_minutes || {};
            const pct = (num, den) => (den ? Math.round((num / den) * 100) : 0);
            const parentShareForQuadrant = (qType, viewMinutes) => {
                if (!qType) return { label: '', pct: 0 };
                if (qType === 'q2') {
                    return { label: 'Of Important time', pct: pct(viewMinutes, periodMatrix.important || 0) };
                }
                if (qType === 'q4') {
                    return { label: 'Of Not Urgent time', pct: pct(viewMinutes, periodMatrix.not_urgent || 0) };
                }
                if (qType === 'q1' || qType === 'q3') {
                    return { label: 'Of Urgent time', pct: pct(viewMinutes, periodMatrix.urgent || 0) };
                }
                return { label: '', pct: 0 };
            };

            const statItem = (value, label) => `
                <div class="rounded-xl border border-slate-100 bg-white/80 px-3 py-3 text-center">
                    <div class="text-xl md:text-2xl font-light text-gray-900">${value}</div>
                    <div class="text-[10px] md:text-xs text-gray-500 mt-1 uppercase tracking-wider">${label}</div>
                </div>
            `;

            const isQuadrant = ['q1', 'q2', 'q3', 'q4'].includes(filterType);
            const isTag = filterType === 'tag';
            const renderStats = () => {
                const activeTasks = Array.isArray(window.modalActiveTasks) ? window.modalActiveTasks : (data.tasks || []);
                const totalMinutes = activeTasks.reduce((sum, task) => sum + minutesFromHours(task.duration || 0), 0);
                const taskCount = activeTasks.length;
                const sharePct = periodMinutes ? Math.round((totalMinutes / periodMinutes) * 100) : 0;
                let importantMinutes = 0;
                let urgentMinutes = 0;
                const quadrantMinutes = { Critical: 0, Growth: 0, Drudgery: 0, Waste: 0 };

                activeTasks.forEach(task => {
                    const dMin = minutesFromHours(task.duration || 0);
                    if (task.important) importantMinutes += dMin;
                    if (task.urgent) urgentMinutes += dMin;
                    if (task.urgent && task.important) {
                        quadrantMinutes.Critical += dMin;
                    } else if (task.important && !task.urgent) {
                        quadrantMinutes.Growth += dMin;
                    } else if (task.urgent && !task.important) {
                        quadrantMinutes.Drudgery += dMin;
                    } else {
                        quadrantMinutes.Waste += dMin;
                    }
                });

                const topQuadrantEntry = Object.entries(quadrantMinutes).sort((a, b) => b[1] - a[1])[0];
                const topQuadrantName = topQuadrantEntry && topQuadrantEntry[1] ? topQuadrantEntry[0] : '';
                const topQuadrantPct = topQuadrantName ? pct(topQuadrantEntry[1], totalMinutes) : 0;

                const maxSessionMin = activeTasks.reduce((m, t) => {
                    const d = minutesFromHours(t.duration || 0);
                    return d > m ? d : m;
                }, 0);

                const useAverage = isMultiDay && window.modalStatsMode === 'avg';
                const divisor = useAverage ? Math.max(dayCount, 1) : 1;
                const toHours = (minutes) => (ensureFinite(minutes) / 60) / divisor;
                const modeLabel = useAverage ? 'Avg/day' : 'Total';
                const hoursValue = (minutes) => {
                    const hours = toHours(minutes);
                    return `<span class="js-hover-hours hover-swap" data-hours="${hours}">${formatHours(hours, 1)}h</span>`;
                };

                const stats = [];
                const totalValue = hoursValue(totalMinutes);

                if (filterType === 'all') {
                    const base = totalMinutes || 1;
                    const gMin = quadrantMinutes.Growth || 0;
                    const dMin = quadrantMinutes.Drudgery || 0;
                    const wMin = quadrantMinutes.Waste || 0;
                    const gVal = hoursValue(gMin);
                    const dVal = hoursValue(dMin);
                    const wVal = hoursValue(wMin);
                    stats.push(statItem(gVal, `${pct(gMin, base)}% discipline (imp, not urgent)`));
                    stats.push(statItem(dVal, `${pct(dMin, base)}% reactive (urg, not important)`));
                    stats.push(statItem(wVal, `${pct(wMin, base)}% waste (neither)`));
                } else if (isTag) {
                    stats.push(statItem(totalValue, `${modeLabel} in view · ${sharePct}% of period`));
                    stats.push(statItem(`${pct(importantMinutes, totalMinutes)}%`, 'Important share'));
                    stats.push(statItem(`${pct(urgentMinutes, totalMinutes)}%`, 'Urgent share'));
                } else if (isQuadrant) {
                    stats.push(statItem(totalValue, `${modeLabel} in view · ${sharePct}% of period`));
                    const parent = parentShareForQuadrant(filterType, totalMinutes);
                    stats.push(statItem(`${parent.pct}%`, parent.label || 'Share of parent'));
                    const longestVal = maxSessionMin ? hoursToHuman(maxSessionMin / 60) : '0 min';
                    stats.push(statItem(longestVal, 'Longest session'));
                } else if (filterType === 'important') {
                    stats.push(statItem(totalValue, `Important · ${modeLabel} · ${sharePct}% of period`));
                    stats.push(statItem(`${pct(quadrantMinutes.Growth, totalMinutes)}%`, 'Growth (not urgent)'));
                    stats.push(statItem(`${pct(quadrantMinutes.Critical, totalMinutes)}%`, 'Critical (urgent)'));
                } else if (filterType === 'not_important') {
                    stats.push(statItem(totalValue, `Not Important · ${modeLabel} · ${sharePct}% of period`));
                    stats.push(statItem(`${pct(quadrantMinutes.Drudgery, totalMinutes)}%`, 'Drudgery (urgent)'));
                    stats.push(statItem(`${pct(quadrantMinutes.Waste, totalMinutes)}%`, 'Waste (not urgent)'));
                } else if (filterType === 'urgent') {
                    stats.push(statItem(totalValue, `Urgent · ${modeLabel} · ${sharePct}% of period`));
                    stats.push(statItem(`${pct(quadrantMinutes.Critical, totalMinutes)}%`, 'Critical (important)'));
                    stats.push(statItem(`${pct(quadrantMinutes.Drudgery, totalMinutes)}%`, 'Drudgery (not important)'));
                } else if (filterType === 'not_urgent') {
                    stats.push(statItem(totalValue, `Not Urgent · ${modeLabel} · ${sharePct}% of period`));
                    stats.push(statItem(`${pct(quadrantMinutes.Growth, totalMinutes)}%`, 'Growth (important)'));
                    stats.push(statItem(`${pct(quadrantMinutes.Waste, totalMinutes)}%`, 'Waste (not important)'));
                } else {
                    stats.push(statItem(totalValue, `${modeLabel} in view · ${sharePct}% of period`));
                    const longestVal = maxSessionMin ? hoursToHuman(maxSessionMin / 60) : '0 min';
                    stats.push(statItem(longestVal, 'Longest session'));
                    stats.push(statItem(`${topQuadrantPct}%`, topQuadrantName ? `Dominant · ${topQuadrantName}` : 'Dominant quadrant'));
                }

                const statsHtml = stats.join('');
                const statsEl = document.getElementById('modalStats');
                if (statsEl) {
                    statsEl.innerHTML = statsHtml;
                }
                window.attachHoverSwap();
            };
            window.renderModalStats = renderStats;
            renderStats();
            const statsContainer = document.getElementById('modalStats');
            if (statsContainer && isMultiDay) {
                statsContainer.classList.add('cursor-pointer');
                statsContainer.title = 'Click to toggle avg/total';
                statsContainer.onclick = () => {
                    window.modalStatsMode = window.modalStatsMode === 'avg' ? 'total' : 'avg';
                    renderStats();
                };
            }
            const chartContainer = document.getElementById('modalChart');
            chartContainer.innerHTML = '<div class="relative w-full" style="height: 280px;"><canvas id="filterChart" class="w-full h-full"></canvas></div><div id="mobileModalLegend" class="mt-4 mb-4 md:hidden flex flex-wrap gap-2 justify-center text-[11px] text-gray-700 px-2"></div>';
            const sortLabels = {
                time_desc: 'Time ↓',
                time_asc: 'Time ↑',
                duration_desc: 'Duration ↓',
                duration_asc: 'Duration ↑',
                task_az: 'Task A→Z',
                task_za: 'Task Z→A',
                tag_az: 'Tag A→Z',
                tag_za: 'Tag Z→A',
                imp_desc: 'Important first',
                urg_desc: 'Urgent first'
            };
            const sortToggles = {
                time: ['time_desc', 'time_asc'],
                duration: ['duration_desc', 'duration_asc'],
                task: ['task_az', 'task_za'],
                tag: ['tag_az', 'tag_za']
            };
            const resolveSort = (base) => {
                const options = sortToggles[base];
                if (!options) {
                    const fallback = base === 'imp' ? 'imp_desc' : base === 'urg' ? 'urg_desc' : 'time_desc';
                    return { key: fallback, label: sortLabels[fallback] || 'Time ↓' };
                }
                const current = window.modalSort;
                const next = options.includes(current)
                    ? (current === options[0] ? options[1] : options[0])
                    : options[0];
                return { key: next, label: sortLabels[next] || 'Time ↓' };
            };
            const tools = document.getElementById('modalTools');
            if (tools) {
                tools.innerHTML = `
                    <div class="w-full flex items-center justify-between gap-2">
                        <div class="flex-1 min-w-0">
                            <input id="modalSearch" type="search" placeholder="Search tasks..." class="w-full px-3 py-1.5 rounded-full bg-white border border-slate-200 text-xs text-gray-700 shadow-sm focus:outline-none focus:ring-2 focus:ring-amber-300" />
                        </div>
                        <div class="relative shrink-0">
                            <button id="modalSortBtn" class="px-3 py-1.5 rounded-full bg-white border border-slate-200 text-xs text-gray-700 shadow-sm active:scale-[0.98] transition">
                                Sort: <span id="modalSortLabel">${sortLabels[window.modalSort] || window.modalSortLabel || 'Time ↓'}</span>
                            </button>
                            <div id="modalSortMenu" class="absolute right-0 mt-2 w-44 bg-white rounded-xl shadow-2xl border border-slate-200 hidden">
                                <div class="dropdown-item" data-key="time">Time</div>
                                <div class="dropdown-item" data-key="duration">Duration</div>
                                <div class="dropdown-item" data-key="task">Task</div>
                                <div class="dropdown-item" data-key="tag">Tag</div>
                                <div class="dropdown-item" data-key="imp">Important first</div>
                                <div class="dropdown-item" data-key="urg">Urgent first</div>
                            </div>
                        </div>
                    </div>
                `;
                const btn = document.getElementById('modalSortBtn');
                const menu = document.getElementById('modalSortMenu');
                const label = document.getElementById('modalSortLabel');
                const search = document.getElementById('modalSearch');
                if (search) {
                    search.value = String(window.modalQuery || '');
                    search.oninput = () => {
                        window.modalQuery = search.value;
                        window.renderModalTasks();
                    };
                }
                if (btn && menu && label) {
                    btn.onclick = () => menu.classList.toggle('hidden');
                    menu.querySelectorAll('.dropdown-item').forEach(item => {
                        item.onclick = () => {
                            const base = item.getAttribute('data-key');
                            const next = resolveSort(base);
                            window.modalSort = next.key;
                            window.modalSortLabel = next.label;
                            label.textContent = next.label;
                            menu.classList.add('hidden');
                            window.renderModalTasks();
                        };
                    });
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('#modalSortBtn') && !e.target.closest('#modalSortMenu')) {
                            menu.classList.add('hidden');
                        }
                    });
                }
            }
            if (data.tasks.length > 0) {
                const ctx = document.getElementById('filterChart').getContext('2d');
                let labels = [];
                let values = [];
                let colors = [];

                const chartMode = window.modalChartMode || 'auto';
                const showTaskBreakdown = chartMode === 'tasks'
                    || (chartMode === 'auto' && window.modalFilterType === 'tag');

                if (showTaskBreakdown) {
                    const taskGroups = {};
                    data.tasks.forEach(task => {
                        let key = String(task.task || '').trim();
                        if (!key || /^(undefined|null|none|nan)$/i.test(key)) key = 'Unspecified';
                        taskGroups[key] = (taskGroups[key] || 0) + (task.duration || 0);
                    });
                    const entries = Object.entries(taskGroups).sort((a, b) => b[1] - a[1]);
                    const top = entries.slice(0, 6);
                    const rest = entries.slice(6);
                    labels = top.map(e => e[0]);
                    values = top.map(e => e[1]);
                    if (rest.length) {
                        labels.push('Other');
                        values.push(rest.reduce((s, e) => s + e[1], 0));
                    }
                    const palette = ['#111827', '#16A34A', '#A16207', '#7C3AED', '#0EA5A4', '#9F1239', '#9CA3AF', '#F59E0B'];
                    colors = labels.map((label, idx) => palette[idx % palette.length]);
                } else {
                    const tagGroups = {};
                    data.tasks.forEach(task => {
                        const key = normalizeTagName(task.tag) || 'Waste';
                        tagGroups[key] = (tagGroups[key] || 0) + (task.duration || 0);
                    });
                    labels = Object.keys(tagGroups);
                    values = Object.values(tagGroups);
                    const palette = ['#111827', '#16A34A', '#A16207', '#7C3AED', '#0EA5A4', '#9F1239', '#9CA3AF', '#F59E0B'];
                    colors = labels.map((label, idx) => TAG_COLOR_MAP[label] || palette[idx % palette.length]);
                }

                const modalFallbackLabel = window.modalFilterType === 'tag' ? 'Unspecified' : 'Waste';
                labels = labels.map(l => {
                    const s = String(l ?? '').trim();
                    if (!s || /^(undefined|null|none|nan)$/i.test(s)) return modalFallbackLabel;
                    return s;
                });
                const isModalMobile = window.matchMedia('(max-width: 767px)').matches;
                const showPercentInChart = true;
                const showMobileLegend = isModalMobile;

                const mobileLegendEl = document.getElementById('mobileModalLegend');
                if (mobileLegendEl) {
                    if (showMobileLegend) {
                        mobileLegendEl.innerHTML = labels.map((label, idx) => {
                            const color = colors[idx] || '#9CA3AF';
                            return `<span class="inline-flex items-center gap-1">
                                <span class="inline-block w-2.5 h-2.5 rounded-full" style="background:${color}"></span>
                                ${label}
                            </span>`;
                        }).join('');
                    } else {
                        mobileLegendEl.innerHTML = '';
                    }
                }
                const legendLabelOptions = {
                    font: { family: 'Inter', size: 11, weight: '500' },
                    padding: 14,
                    color: '#374151',
                    usePointStyle: true,
                    pointStyle: 'circle'
                };
                const legendGenerateLabels = (chart) => {
                    const labels = chart.data.labels || [];
                    const values = chart.data.datasets[0]?.data || [];
                    const meta = chart.getDatasetMeta(0);
                    const total = values.reduce((sum, v) => sum + (Number(v) || 0), 0);
                    return labels.map((rawLabel, idx) => {
                        const style = meta?.controller?.getStyle
                            ? meta.controller.getStyle(idx)
                            : {};
                        const baseText = String(rawLabel ?? '').trim();
                        const safeText = baseText && !/^(undefined|null|none|nan)$/i.test(baseText)
                            ? baseText
                            : (window.modalFilterType === 'tag' ? 'Unspecified' : 'Waste');
                        const labelText = safeText;
                        return {
                            text: labelText,
                            fillStyle: style.backgroundColor,
                            strokeStyle: style.borderColor,
                            lineWidth: style.borderWidth,
                            hidden: !chart.getDataVisibility(idx),
                            index: idx,
                            datasetIndex: 0
                        };
                    });
                };
                const chart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#FFFFFF',
                            hoverOffset: 10,
                            hoverBorderWidth: 3
                        }]
                    },
                    plugins: [percentLabelPlugin],
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        spacing: 3,
                        plugins: {
                            percentLabelPlugin: {
                                display: showPercentInChart,
                                fontSize: isModalMobile ? 10 : 11,
                                fontFamily: 'Inter',
                                fontWeight: '600',
                                color: '#111827',
                                lightColor: '#FFFFFF',
                                autoColor: true,
                                shadow: true,
                                minPercent: 3,
                                precision: 0
                            },
                            legend: {
                                display: !isModalMobile,
                                position: 'bottom',
                                labels: {
                                    ...legendLabelOptions,
                                    pointStyle: 'circle'
                                },
                                generateLabels: legendGenerateLabels,
                                onClick: function(e, legendItem, legend) {
                                    const ci = legend.chart;
                                    const index = legendItem.index;
                                    const label = ci.data.labels[index];
                                    const currentlyVisible = ci.getDataVisibility(index) !== false;
                                    ci.toggleDataVisibility(index);
                                    ci.update();
                                    if (!window.hiddenTags) window.hiddenTags = {};
                                    if (currentlyVisible) {
                                        window.hiddenTags[label] = true;
                                    } else {
                                        delete window.hiddenTags[label];
                                    }
                                    window.renderModalTasks();
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(17, 24, 39, 0.96)',
                                padding: 14,
                                titleFont: { family: 'Inter', size: 13, weight: '600' },
                                bodyFont: { family: 'Inter', size: 12, weight: '400' },
                                cornerRadius: 10,
                                displayColors: true,
                                boxWidth: 10,
                                boxHeight: 10,
                                boxPadding: 6,
                                callbacks: {
                                    label: function(context) {
                                        const raw = context.label;
                                        const label = String(raw ?? '').trim() || (window.modalFilterType === 'tag' ? 'Unspecified' : 'Waste');
                                        const value = Number(context.parsed || 0);
                                        const total = context.dataset.data.reduce((sum, v, idx) => {
                                            const visible = typeof context.chart.getDataVisibility === 'function'
                                                ? context.chart.getDataVisibility(idx) !== false
                                                : true;
                                            return visible ? sum + (Number(v) || 0) : sum;
                                        }, 0);
                                        const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${value.toFixed(1)}h (${percent}%)`;
                                    }
                                }
                            }
                        },
                        onClick: function(evt, elements) {
                            if (!elements || !elements.length) return;
                            const index = elements[0].index;
                            const label = chart.data.labels[index];
                            const currentlyVisible = chart.getDataVisibility(index) !== false;
                            chart.toggleDataVisibility(index);
                            chart.update();
                            if (!window.hiddenTags) window.hiddenTags = {};
                            if (currentlyVisible) {
                                window.hiddenTags[label] = true;
                            } else {
                                delete window.hiddenTags[label];
                            }
                            window.renderModalTasks();
                        }
                    }
                });
            }
            window.renderModalTasks();
            document.getElementById('taskModal').classList.add('active');
        };

        window.closeModal = function() {
            document.getElementById('taskModal').classList.remove('active');
        };

        // Initialize on DOM load
        document.addEventListener('DOMContentLoaded', function() {
            function setActiveNav(id) {
                ['navHome','navMatrix','navTags','navGraphs','navFilter'].forEach(k => {
                    const el = document.getElementById(k);
                    if (!el) return;
                    if (k === id) {
                        el.className = 'flex flex-col items-center gap-1 px-3 py-1 rounded-xl text-gray-900 bg-slate-100';
                    } else {
                        el.className = 'flex flex-col items-center gap-1 px-3 py-1 rounded-xl text-gray-600';
                    }
                });
            }

            function smoothScrollTo(targetId) {
                const el = document.getElementById(targetId);
                if (!el) return;
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            const homeBtn = document.getElementById('navHome');
            const matrixBtn = document.getElementById('navMatrix');
            const tagsBtn = document.getElementById('navTags');
            const graphsBtn = document.getElementById('navGraphs');
            const filterBtn = document.getElementById('navFilter');
            if (homeBtn) homeBtn.onclick = () => { smoothScrollTo('top'); setActiveNav('navHome'); };
            if (matrixBtn) matrixBtn.onclick = () => { smoothScrollTo('matrix'); setActiveNav('navMatrix'); };
            if (tagsBtn) tagsBtn.onclick = () => { smoothScrollTo('tags'); setActiveNav('navTags'); };
            if (graphsBtn) graphsBtn.onclick = () => {
                setActiveNav('navGraphs');
                window.location.href = "{{ url_for('main.graphs') }}";
            };
            if (filterBtn) {
                filterBtn.onclick = () => {
                    openMobileFilter();
                    setActiveNav('navFilter');
                };
                ['touchstart','mousedown'].forEach(evt => {
                    filterBtn.addEventListener(evt, () => filterBtn.classList.add('bg-slate-100'));
                });
                ['touchend','mouseup','mouseleave'].forEach(evt => {
                    filterBtn.addEventListener(evt, () => filterBtn.classList.remove('bg-slate-100'));
                });
            }

            function openMobileFilter() {
                try {
                    const sheet = document.getElementById('mobileFilterSheet');
                    const backdrop = document.getElementById('mobileFilterBackdrop');
                    if (!sheet || !backdrop) return;
                    backdrop.classList.remove('pointer-events-none');
                    backdrop.classList.add('opacity-100');
                    sheet.classList.remove('translate-y-full');
                } catch (e) {
                    setGlobalLoading(false, 'Unable to open filters');
                    console.error(e);
                }
            }
            function closeMobileFilter() {
                try {
                    const sheet = document.getElementById('mobileFilterSheet');
                    const backdrop = document.getElementById('mobileFilterBackdrop');
                    if (!sheet || !backdrop) return;
                    sheet.classList.add('translate-y-full');
                    backdrop.classList.remove('opacity-100');
                    backdrop.classList.add('pointer-events-none');
                } catch (e) {
                    setGlobalLoading(false, 'Unable to close filters');
                    console.error(e);
                }
            }
            const mobileFilterClose = document.getElementById('mobileFilterClose');
            const mobileBackdrop = document.getElementById('mobileFilterBackdrop');
            if (mobileFilterClose) mobileFilterClose.onclick = closeMobileFilter;
            if (mobileBackdrop) mobileBackdrop.onclick = closeMobileFilter;

            const observerTargets = [
                { id: 'top', btn: 'navHome' },
                { id: 'matrix', btn: 'navMatrix' },
                { id: 'tags', btn: 'navTags' }
            ].map(({ id, btn }) => ({ el: document.getElementById(id), btn }));

            const io = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const t = observerTargets.find(x => x.el === entry.target);
                        if (t) setActiveNav(t.btn);
                    }
                });
            }, { root: null, threshold: 0.4 });

            observerTargets.forEach(t => { if (t.el) io.observe(t.el); });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.dropdown')) {
                    window.closeDropdown();
                }
                if (!e.target.closest('#datePicker')) {
                    const dd = document.getElementById('dateDropdown');
                    if (dd) dd.classList.add('hidden');
                }
            });

            const summaryCards = document.querySelectorAll('[data-filter], [data-action]');
            summaryCards.forEach(card => {
                card.addEventListener('click', () => {
                    const action = card.dataset.action;
                    if (action === 'full-period') {
                        viewFullDay();
                        return;
                    }
                    const filter = card.dataset.filter;
                    const title = card.dataset.title || '';
                    const tag = card.dataset.tag || '';
                    const chart = card.dataset.chart || 'auto';
                    if (filter) {
                        window.applyFilter(filter, title, tag, chart);
                    }
                });
            });

            // Close modal on outside click
            document.getElementById('taskModal').addEventListener('click', (e) => {
                if (e.target.id === 'taskModal') {
                    window.closeModal();
                }
            });

            // Update button text based on period
            const period = window.currentPeriod || 'day';
            const periodMap = { 'day': 'Day', 'week': 'Week', 'month': 'Month' };
            const periodLabel = periodMap[period] || 'Day';
            const viewFullBtn = document.getElementById('viewFullBtn');
            const viewFullBtnMobile = document.getElementById('viewFullBtnMobile');
            if (viewFullBtn) viewFullBtn.textContent = 'View Full ' + periodLabel;
            if (viewFullBtnMobile) viewFullBtnMobile.textContent = 'View Full ' + periodLabel;

            window.dateCursor = new Date(window.currentDate);
            window.renderDateGrid();

            const isMultiDayPeriod = period === 'week' || period === 'month';
            window.matrixMode = isMultiDayPeriod ? 'avg' : 'total';
            window.updateMatrixDisplay();

            const tagCanvas = document.getElementById('tagChart');
            const tagCtx = tagCanvas ? tagCanvas.getContext('2d') : null;
            const isMobile = window.matchMedia('(max-width: 767px)').matches;
            const tagPalette = ['#111827', '#16A34A', '#F59E0B', '#E11D48', '#64748B', '#0369A1', '#7C3AED', '#F97316'];
            const tagLabels = JSON.parse('{{ (tags.labels or []) | tojson }}');
            const tagData = JSON.parse('{{ (tags.data or []) | tojson }}');
            if (tagCtx && tagLabels.length) {
                const tagColors = tagLabels.map((label, idx) => TAG_COLOR_MAP[label] || tagPalette[idx % tagPalette.length]);
                const tagTotal = tagData.reduce((sum, v) => sum + Number(v || 0), 0);
                try {
                    const tagChart = new Chart(tagCtx, {
                        type: 'doughnut',
                        data: {
                            labels: tagLabels,
                            datasets: [{
                                data: tagData,
                                backgroundColor: tagColors,
                                borderWidth: 2,
                                borderColor: '#FFFFFF',
                                hoverOffset: 12,
                                hoverBorderWidth: 3
                            }]
                        },
                        plugins: [percentLabelPlugin],
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: isMobile ? '58%' : '64%',
                            spacing: 3,
                            plugins: {
                                percentLabelPlugin: {
                                    display: true,
                                    fontSize: isMobile ? 11 : 12,
                                    fontFamily: 'Inter',
                                    fontWeight: '600',
                                    color: '#111827',
                                    lightColor: '#FFFFFF',
                                    autoColor: true,
                                    shadow: true,
                                    minPercent: 0
                                },
                                legend: {
                                    display: !isMobile,
                                    position: 'bottom',
                                    maxWidth: 280,
                                    labels: {
                                        usePointStyle: true,
                                        pointStyle: 'circle',
                                        font: { family: 'Inter', size: 11, weight: '500' },
                                        padding: 14,
                                        color: '#374151',
                                        boxWidth: 10,
                                        boxHeight: 10
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(17, 24, 39, 0.96)',
                                    padding: 14,
                                    titleFont: { family: 'Inter', size: 13, weight: '600' },
                                    bodyFont: { family: 'Inter', size: 12, weight: '400' },
                                    cornerRadius: 10,
                                    displayColors: true,
                                    boxWidth: 10,
                                    boxHeight: 10,
                                    boxPadding: 6,
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const total = context.dataset.data.reduce((sum, v, idx) => {
                                                const visible = typeof context.chart.getDataVisibility === 'function'
                                                    ? context.chart.getDataVisibility(idx) !== false
                                                    : true;
                                                return visible ? sum + Number(v || 0) : sum;
                                            }, 0);
                                            const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                            return label + ': ' + value.toFixed(1) + 'h (' + percent + '%)';
                                        }
                                    }
                                }
                            }
                        }
                    });
                    tagChart.options.onClick = function(evt, elements) {
                        if (!elements || !elements.length) return;
                        const index = elements[0].index;
                        const label = tagChart.data.labels[index];
                        window.applyFilter('tag', label, label);
                    };
                    tagChart.update();
                    const mobileLegend = document.getElementById('mobileTagLegend');
                    if (isMobile && mobileLegend) {
                        tagChart.options.plugins.legend.display = false;
                        tagChart.update();
                        mobileLegend.innerHTML = tagLabels.map((label, idx) => {
                            return `<span class="inline-flex items-center gap-1">
                                <span class="inline-block w-2.5 h-2.5 rounded-full" style="background:${tagColors[idx]}"></span>
                                ${label}
                            </span>`;
                        }).join('');
                    }
                } catch (e) {
                    const wrap = document.getElementById('tags');
                    if (wrap) {
                        const holder = wrap.querySelector('[aria-label="Time spent by tag category"]');
                        if (holder) {
                            holder.innerHTML = '<div class="text-center text-xs text-gray-400">Unable to render chart</div>';
                        }
                    }
                }
            }

            // Decimal handling helpers: sum in minutes to avoid float drift, format using fixed decimals
            function ensureFinite(n) {
                const v = Number(n);
                return Number.isFinite(v) ? v : 0;
            }
            function minutesFromHours(h) {
                return Math.round(ensureFinite(h) * 60);
            }
            function formatHours(h, decimals = 1) {
                return ensureFinite(h).toFixed(decimals);
            }
            function hoursToHM(h) {
                const total = Math.max(0, Math.round(Number(h || 0) * 60));
                const hrs = Math.floor(total / 60);
                const mins = total % 60;
                if (hrs === 0) return `${mins} min`;
                if (mins === 0) return `${hrs} hr`;
                return `${hrs} hr ${mins} min`;
            }
            async function runManualSync({ reload = true, showLoading = true } = {}) {
                try {
                    if (showLoading) {
                        setGlobalLoading(true, '');
                    }
                    const r = await fetch('/sync-now', { method: 'GET', credentials: 'include' });
                    if (r.status === 401) {
                        const nextUrl = encodeURIComponent(window.location.pathname + window.location.search);
                        window.location.href = `/login?next=${nextUrl}`;
                        return;
                    }
                    if (!r.ok) throw new Error(`HTTP ${r.status}`);
                    await r.json();
                    if (showLoading) {
                        setGlobalLoading(false, '');
                    }
                    if (reload) {
                        window.location.href = `/?date=${window.currentDate}&period=${window.currentPeriod}`;
                    }
                } catch (e) {
                    console.error('Manual sync failed', e);
                    if (showLoading) {
                        setGlobalLoading(false, 'Failed to sync from cloud');
                    }
                }
            }
            const titleBtn = document.getElementById('appTitleBtn');
            if (titleBtn) {
                titleBtn.addEventListener('click', () => runManualSync());
            }
            setTimeout(() => {
                runManualSync({ reload: false, showLoading: false });
            }, 2000);
            function attachHoverSwap() {
                document.querySelectorAll('.js-hover-hours').forEach(el => {
                    if (el.__hoverBound) return;
                    const raw = el.getAttribute('data-hours') || el.textContent;
                    const h = Number(raw);
                    if (isNaN(h)) return;
                    const decimalText = `${window.formatHours(h, 1)}h`;
                    const humanText = hoursToHM(h);
                    el.classList.add('hover-swap', 'cursor-default');
                    el.addEventListener('mouseenter', () => {
                        el.style.opacity = '0';
                        el.style.transform = 'scale(0.98)';
                        setTimeout(() => {
                            el.textContent = humanText;
                            el.style.opacity = '1';
                            el.style.transform = 'scale(1)';
                        }, 100);
                    });
                    el.addEventListener('mouseleave', () => {
                        el.style.opacity = '0';
                        el.style.transform = 'scale(0.98)';
                        setTimeout(() => {
                            el.textContent = decimalText;
                            el.style.opacity = '1';
                            el.style.transform = 'scale(1)';
                        }, 100);
                    });
                    el.__hoverBound = true;
                });
            }
            attachHoverSwap();

            // Tilt-responsive water animation for mobile devices
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', function(event) {
                    const gamma = event.gamma; // Left-right tilt (-90 to 90)
                    if (gamma !== null) {
                        const waterElements = document.querySelectorAll('.water-fill');
                        waterElements.forEach(function(water) {
                            // Normalize gamma to -1 to 1 range (clamp to -30 to 30 degrees)
                            const clampedGamma = Math.max(-30, Math.min(30, gamma));
                            const tiltFactor = clampedGamma / 30;
                            
                            // Apply transform to water pseudo-elements via CSS custom property
                            water.style.setProperty('--tilt-x', (tiltFactor * 10) + '%');
                            water.style.setProperty('--tilt-rotate', (tiltFactor * 2) + 'deg');
                        });
                    }
                });
            }
        }); // End DOMContentLoaded
    </script>
</body>
</html>
