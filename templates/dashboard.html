<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tracker Pro</title>
    <script src="https://cdn.tailwindcss.com" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #F7F1E6 0%, #F2E6D5 40%, #E9DDCB 100%);
            color: #111827;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }
        .luxury-card {
            background: linear-gradient(135deg, #FEFCF8, #F5EDE1);
            border: 1px solid rgba(148, 126, 86, 0.18);
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .luxury-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 26px 65px rgba(15, 23, 42, 0.14);
        }
        .matrix-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .matrix-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px 0 rgba(0, 0, 0, 0.08);
        }
        input[type="date"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            top: 0;
            left: 0;
        }
        .yellow-accent {
            background: linear-gradient(135deg, #F7CF6B 0%, #F5B826 45%, #FCE7A2 100%);
        }
        .selected-day {
            background: linear-gradient(135deg, #F7CF6B 0%, #F5B826 45%, #FCE7A2 100%);
            box-shadow: 0 16px 40px rgba(180, 136, 48, 0.45);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: radial-gradient(circle at top left, #FFFFFF 0%, #F9FAFB 55%, #E5E7EB 100%);
            border-radius: 24px;
            max-width: 900px;
            max-height: 90vh;
            width: 90%;
            overflow-y: auto;
            border: 1px solid rgba(15,23,42,0.08);
            box-shadow: 0 30px 80px rgba(15,23,42,0.32);
        }
        .dropdown {
            position: relative;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: rgba(255,255,255,0.98);
            border-radius: 12px;
            box-shadow: 0 20px 45px rgba(15,23,42,0.18);
            min-width: 240px;
            z-index: 50;
            border: 1px solid rgba(148,163,184,0.28);
        }
        .dropdown-menu.active {
            display: block;
        }
        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .dropdown-item:hover {
            background: #F9FAFB;
        }
        .period-selector {
            display: flex;
            gap: 4px;
            background: rgba(255, 255, 255, 0.45);
            padding: 4px;
            border-radius: 12px;
            border: 1px solid rgba(148, 126, 86, 0.32);
        }
        .period-btn {
            padding: 8px 16px;
            border-radius: 9999px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
            color: #6B7280;
        }
        .period-btn.active {
            background: linear-gradient(135deg, #F8D574, #F5B826);
            color: #111827;
            box-shadow: 0 10px 24px rgba(185, 132, 40, 0.35);
        }
        .primary-cta {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.8rem 1.9rem;
            border-radius: 9999px;
            background: #111827;
            color: #F8D574;
            font-size: 0.9rem;
            letter-spacing: 0.03em;
            font-weight: 600;
            box-shadow: 0 14px 32px rgba(17, 24, 39, 0.55);
            border: 1px solid rgba(248, 213, 116, 0.4);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
        }
        .primary-cta:hover {
            transform: translateY(-1px);
            box-shadow: 0 20px 40px rgba(17, 24, 39, 0.7);
            filter: brightness(1.03);
        }
        .primary-cta:active {
            transform: translateY(0);
            box-shadow: 0 10px 22px rgba(17, 24, 39, 0.5);
            filter: brightness(0.98);
        }
        .hover-swap {
            transition: opacity 0.2s ease-in-out;
        }
    </style>
    <style>
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>
<body class="antialiased overflow-x-hidden">

    <div id="globalLoading" class="fixed bottom-4 right-4 z-50 hidden">
        <div class="px-4 py-2 rounded-full bg-gray-900/90 text-xs text-gray-100 shadow-lg flex items-center gap-2">
            <span class="h-2 w-2 rounded-full bg-amber-400 animate-pulse"></span>
            <span>Loading insights…</span>
        </div>
    </div>

    <div id="globalError" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 hidden">
        <div class="px-4 py-2 rounded-full bg-red-600 text-xs text-white shadow-lg">
            <span id="globalErrorText"></span>
        </div>
    </div>

    <!-- Minimal Header -->
    <header class="bg-white/90 backdrop-blur border-b border-slate-200 shadow-sm" role="banner">
        <div class="max-w-7xl mx-auto px-8 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 id="appTitleBtn" class="text-2xl font-semibold text-gray-900 tracking-tight cursor-pointer" aria-label="Sync and reload">Time Tracker Pro</h1>
                    <p class="text-sm text-gray-500 mt-1">Personal productivity analytics</p>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Period Selector -->
                    <div class="period-selector hidden md:flex">
                        <button class="period-btn {% if period == 'day' %}active{% endif %}" onclick="changePeriod('day')">Day</button>
                        <button class="period-btn {% if period == 'week' %}active{% endif %}" onclick="changePeriod('week')">Week</button>
                        <button class="period-btn {% if period == 'month' %}active{% endif %}" onclick="changePeriod('month')">Month</button>
                    </div>
                    <div id="datePicker" class="relative">
                        <button type="button" onclick="toggleDatePicker()" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/80 border border-[rgba(148,126,86,0.35)] text-sm text-gray-700 shadow-sm hover:bg-[#F7F1E6] transition-all duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-700">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            <span class="text-xs font-medium tracking-wide text-gray-700">
                                {{ selected_date.strftime("%b %-d, %Y") if selected_date else "" }}
                            </span>
                        </button>
                        <div id="dateDropdown" class="hidden absolute left-1/2 -translate-x-1/2 md:left-auto md:translate-x-0 md:right-0 mt-3 w-72 rounded-2xl bg-[#FEFCF8] border border-[rgba(148,126,86,0.35)] shadow-2xl shadow-[rgba(15,23,42,0.18)] p-4 z-50">
                            <div class="flex items-center justify-between mb-4 text-sm text-gray-700">
                                <button type="button" onclick="navigateMonth(-1)" class="px-2 py-1 rounded-full hover:bg-[#F5EDE1]">&lsaquo;</button>
                                <div id="dateDropdownLabel" class="font-medium"></div>
                                <button type="button" onclick="navigateMonth(1)" class="px-2 py-1 rounded-full hover:bg-[#F5EDE1]">&rsaquo;</button>
                            </div>
                            <div class="grid grid-cols-7 gap-1 text-[11px] text-gray-400 mb-1">
                                <div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div>
                            </div>
                            <div id="dateGrid" class="grid grid-cols-7 gap-1 text-xs"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 md:px-8 pt-8 pb-24 md:py-12" role="main" id="top">

        <!-- Month Header & Controls -->
        <div class="mb-10 md:mb-12" id="monthHeader">
            <div class="md:hidden mb-6">
                <div class="flex w-full bg-white/80 border border-[rgba(148,126,86,0.35)] rounded-full p-1 shadow-sm">
                    <button onclick="changePeriod('day')" class="flex-1 py-2 rounded-full text-sm font-medium transition
                        {% if period == 'day' %} bg-amber-400 text-gray-900 shadow {% else %} text-gray-600 hover:bg-slate-50 {% endif %}">
                        Day
                    </button>
                    <button onclick="changePeriod('week')" class="flex-1 py-2 rounded-full text-sm font-medium transition
                        {% if period == 'week' %} bg-amber-400 text-gray-900 shadow {% else %} text-gray-600 hover:bg-slate-50 {% endif %}">
                        Week
                    </button>
                    <button onclick="changePeriod('month')" class="flex-1 py-2 rounded-full text-sm font-medium transition
                        {% if period == 'month' %} bg-amber-400 text-gray-900 shadow {% else %} text-gray-600 hover:bg-slate-50 {% endif %}">
                        Month
                    </button>
                </div>
            </div>
            <div class="flex items-center justify-between mb-6 md:mb-8">
                <div>
                    <h2 class="text-3xl md:text-4xl font-light text-gray-900 mb-1 md:mb-2 tracking-tight">{{ current_month }}</h2>
                    <p class="text-gray-700 md:text-gray-500 text-sm">Where did your day go?</p>
                </div>
                <div class="flex items-center gap-3 md:gap-4">
                    <!-- View Full Day Button -->
                    <button onclick="viewFullDay()" class="primary-cta hidden md:inline-flex">
                        View Full Day
                    </button>
                    <!-- Filter Dropdown -->
                    <div class="dropdown">
                        <button id="headerFilterBtn" onclick="toggleDropdown()" class="hidden md:flex px-6 py-3 bg-white/90 text-slate-800 rounded-xl font-medium border border-slate-200 hover:bg-slate-50 transition-all duration-200 items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                            </svg>
                            Filter
                        </button>
                        <div id="filterDropdown" class="dropdown-menu">
                            <div class="dropdown-item" onclick="applyFilter('all', 'All Tasks')">All Tasks</div>
                            <div class="dropdown-item" onclick="applyFilter('imp', 'Important Work')">Important Work</div>
                            <div class="dropdown-item" onclick="applyFilter('urg', 'Urgent Work')">Urgent Work</div>
                            <div class="dropdown-item" onclick="applyFilter('imp_and_urg', 'Important & Urgent')">Important & Urgent</div>
                            <div class="dropdown-item" onclick="applyFilter('imp_not_urg', 'Important, Not Urgent')">Important, Not Urgent</div>
                            <div class="dropdown-item" onclick="applyFilter('urg_not_imp', 'Urgent, Not Important')">Urgent, Not Important</div>
                            <div class="dropdown-item" onclick="applyFilter('not_imp', 'Not Important')">Not Important</div>
                            <div class="border-t border-gray-200 my-1"></div>
                            <div class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">By Category</div>
                            <div id="tagFilters"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="md:hidden flex items-center gap-3 mb-4">
                <button onclick="viewFullDay()" class="px-5 py-3 rounded-full bg-gray-900 text-amber-300 text-sm font-semibold shadow-lg active:scale-[0.98] transition-transform">
                    View Full Day
                </button>
            </div>

            <!-- Week Selector (only show for day/week views) -->
            {% if period == 'day' or period == 'week' %}
            <div class="flex justify-start gap-6 overflow-x-auto pb-2">
                {% for day in week_days %}
                <a href="/?date={{ day.full_str }}&period={{ period }}" class="flex flex-col items-center min-w-[56px] group">
                    <span class="text-xs font-medium uppercase mb-3 tracking-wider
                        {% if day.is_selected %} text-gray-900 {% else %} text-gray-400 group-hover:text-gray-600 {% endif %}">
                        {{ day.day_name }}
                    </span>
                    <div class="w-14 h-14 flex items-center justify-center rounded-xl text-base font-semibold transition-all duration-200
                        {% if day.is_selected %}
                            selected-day text-white
                        {% else %}
                            bg-white text-gray-600 hover:bg-gray-50 luxury-card
                        {% endif %}">
                        {{ day.day_num }}
                    </div>
                </a>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
            <div class="luxury-card rounded-2xl p-8 flex flex-col justify-between">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <div class="text-xs font-semibold tracking-[0.16em] text-gray-400 uppercase">Focus Time</div>
                        <div class="mt-2 text-3xl font-light text-gray-900"><span class="js-hover-hours" data-hours="{{ matrix.q2.hours }}">{{ matrix.q2.hours }}h</span></div>
                    </div>
                    <span class="inline-flex h-9 px-3 items-center rounded-full bg-[#111827] text-[11px] font-medium tracking-wide text-[#F8D574] border border-[rgba(248,213,116,0.35)]">
                        Deep work
                    </span>
                </div>
                <div class="w-full h-2 rounded-full bg-[#E7D8C2] overflow-hidden">
                    <div class="h-full rounded-full bg-gradient-to-r from-[#111827] via-[#111827] to-[#F5B826]" style="width: {{ matrix.q2.pct }}%"></div>
                </div>
                <div class="mt-3 text-xs text-gray-500">You spent {{ matrix.q2.pct }}% of your time on important, non‑urgent work.</div>
            </div>
            <div class="luxury-card rounded-2xl p-8 flex flex-col justify-between">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <div class="text-xs font-semibold tracking-[0.16em] text-gray-400 uppercase">Critical Load</div>
                        <div class="mt-2 text-3xl font-light text-gray-900"><span class="js-hover-hours" data-hours="{{ matrix.q1.hours }}">{{ matrix.q1.hours }}h</span></div>
                    </div>
                    <span class="inline-flex h-9 px-3 items-center rounded-full bg-[#FDF3DF] text-[11px] font-medium tracking-wide text-[#92400E] border border-amber-200">
                        Urgent & important
                    </span>
                </div>
                <div class="w-full h-2 rounded-full bg-[#E7D8C2] overflow-hidden">
                    <div class="h-full rounded-full bg-gradient-to-r from-[#F97316] via-[#F59E0B] to-[#FACC15]" style="width: {{ matrix.q1.pct }}%"></div>
                </div>
                <div class="mt-3 text-xs text-gray-500">Represents {{ matrix.q1.pct }}% of your tracked time this period.</div>
            </div>
            <div class="luxury-card rounded-2xl p-8 flex flex-col justify-between">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <div class="text-xs font-semibold tracking-[0.16em] text-gray-400 uppercase">Aligned Time</div>
                        <div class="mt-2 text-3xl font-light text-gray-900">{{ ((matrix.q2.pct + matrix.q1.pct) / 2) | round(1) }}<span class="text-sm text-gray-400 font-normal ml-1">%</span></div>
                    </div>
                </div>
                <div class="w-full h-2 rounded-full bg-[#E7D8C2] overflow-hidden">
                    <div class="h-full rounded-full bg-gradient-to-r from-[#22C55E] via-[#A3E635] to-[#FACC15]" style="width: {{ ((matrix.q2.pct + matrix.q1.pct) / 2) | round(1) }}%"></div>
                </div>
                <div class="mt-3 text-xs text-gray-500">Average of growth and critical work share – closer to 100% means your calendar matches your priorities.</div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Priority Matrix - Extended Eisenhower Matrix -->
            <div class="lg:col-span-2" id="matrix">
                <div class="mb-6">
                    <h3 class="text-2xl font-light text-gray-900 mb-1">Priority Breakdown</h3>
                    <p class="text-sm text-gray-500">Extended Eisenhower Matrix analysis</p>
                </div>
                <div class="grid grid-cols-3 gap-4">
                    <!-- Row 1: Important & Urgent | Important & !Urgent | Important -->
                    
                    <!-- Critical: Important & Urgent - Yellow/Amber (matters but stressful) -->
                    <div class="matrix-card luxury-card rounded-2xl p-5 bg-gradient-to-br from-amber-50/80 to-yellow-50/40 border-amber-200/60 hover:shadow-lg transition-all duration-300" onclick="viewMatrixQuadrant('q1', 'Critical')">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-amber-800 font-semibold text-base mb-0.5">Critical</h4>
                                <p class="text-[10px] text-amber-700/80 font-medium uppercase tracking-wider">Important & Urgent</p>
                            </div>
                            <div class="text-xl text-amber-400/70">◆</div>
                        </div>
                        <div class="text-3xl font-light text-gray-900 mb-1"><span class="js-hover-hours" data-hours="{{ matrix.q1.hours }}">{{ matrix.q1.hours }}h</span></div>
                        <div class="text-xs font-medium text-amber-700/70">{{ matrix.q1.pct }}%</div>
                    </div>

                    <!-- Growth: Important & !Urgent - Soft Green/Mint (best time, calm growth, self-control) -->
                    <div class="matrix-card luxury-card rounded-2xl p-5 bg-gradient-to-br from-green-100/70 to-emerald-50/50 border-green-200/60 hover:shadow-lg transition-all duration-300" onclick="viewMatrixQuadrant('q2', 'Growth')">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-green-800 font-semibold text-base mb-0.5">Growth</h4>
                                <p class="text-[10px] text-green-700/90 font-medium uppercase tracking-wider">Important & !Urgent</p>
                            </div>
                            <div class="text-xl text-green-400/80">★</div>
                        </div>
                        <div class="text-3xl font-light text-gray-900 mb-1"><span class="js-hover-hours" data-hours="{{ matrix.q2.hours }}">{{ matrix.q2.hours }}h</span></div>
                        <div class="text-xs font-medium text-green-700/80">{{ matrix.q2.pct }}%</div>
                    </div>

                    <!-- Important (All) - Blue (neutral, trustworthy aggregate) -->
                    <div class="matrix-card luxury-card rounded-2xl p-5 bg-gradient-to-br from-blue-50/70 to-indigo-50/40 border-blue-200/60 hover:shadow-lg transition-all duration-300" onclick="viewMatrixQuadrant('important', 'Important')">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-blue-800 font-semibold text-base mb-0.5">Important</h4>
                                <p class="text-[10px] text-blue-700/80 font-medium uppercase tracking-wider">All Important</p>
                            </div>
                            <div class="text-xl text-blue-400/70">●</div>
                        </div>
                        <div class="text-3xl font-light text-gray-900 mb-1"><span class="js-hover-hours" data-hours="{{ matrix.important.hours }}">{{ matrix.important.hours }}h</span></div>
                        <div class="text-xs font-medium text-blue-700/70">{{ matrix.important.pct }}%</div>
                    </div>

                    <!-- Row 2: Urgent & !Important | !Important & !Urgent | !Important -->
                    
                    <!-- Drudgery: Urgent & !Important - Grey/Dull Steel (lifeless obligation) -->
                    <div class="matrix-card luxury-card rounded-2xl p-5 bg-gradient-to-br from-slate-200/70 to-zinc-100/50 border-slate-300/60 hover:shadow-lg transition-all duration-300" onclick="viewMatrixQuadrant('q3', 'Drudgery')">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-slate-600 font-semibold text-base mb-0.5">Drudgery</h4>
                                <p class="text-[10px] text-slate-500/80 font-medium uppercase tracking-wider">Urgent & !Important</p>
                            </div>
                            <div class="text-xl text-slate-400/70">⛓</div>
                        </div>
                        <div class="text-3xl font-light text-slate-700 mb-1"><span class="js-hover-hours" data-hours="{{ matrix.q3.hours }}">{{ matrix.q3.hours }}h</span></div>
                        <div class="text-xs font-medium text-slate-500/70">{{ matrix.q3.pct }}%</div>
                    </div>

                    <!-- Waste: !Important & !Urgent - Muted/Desaturated Red (time decay, subtle warning) -->
                    <div class="matrix-card luxury-card rounded-2xl p-5 bg-gradient-to-br from-red-100/60 to-rose-50/40 border-red-200/50 hover:shadow-lg transition-all duration-300" onclick="viewMatrixQuadrant('q4', 'Waste')">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-red-700 font-semibold text-base mb-0.5">Waste</h4>
                                <p class="text-[10px] text-red-600/80 font-medium uppercase tracking-wider">!Important & !Urgent</p>
                            </div>
                            <div class="text-xl text-red-300/70">×</div>
                        </div>
                        <div class="text-3xl font-light text-gray-900 mb-1"><span class="js-hover-hours" data-hours="{{ matrix.q4.hours }}">{{ matrix.q4.hours }}h</span></div>
                        <div class="text-xs font-medium text-red-600/70">{{ matrix.q4.pct }}%</div>
                    </div>

                    <!-- Not Important (All) - Very Light Neutral (quiet, low-value total) -->
                    <div class="matrix-card luxury-card rounded-2xl p-5 bg-gradient-to-br from-neutral-100/50 to-stone-50/30 border-neutral-200/50 hover:shadow-lg transition-all duration-300" onclick="viewMatrixQuadrant('not_important', 'Not Important')">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-neutral-500 font-semibold text-base mb-0.5">!Important</h4>
                                <p class="text-[10px] text-neutral-400/80 font-medium uppercase tracking-wider">All Not Important</p>
                            </div>
                            <div class="text-xl text-neutral-300/70">○</div>
                        </div>
                        <div class="text-3xl font-light text-neutral-600 mb-1"><span class="js-hover-hours" data-hours="{{ matrix.not_important.hours }}">{{ matrix.not_important.hours }}h</span></div>
                        <div class="text-xs font-medium text-neutral-400/70">{{ matrix.not_important.pct }}%</div>
                    </div>

                    <!-- Row 3: Urgent | !Urgent | (empty) -->
                    
                    <!-- Urgent (All) - Orange/Amber (pressure, energy drain) -->
                    <div class="matrix-card luxury-card rounded-2xl p-5 bg-gradient-to-br from-orange-100/70 to-amber-50/40 border-orange-200/60 hover:shadow-lg transition-all duration-300" onclick="viewMatrixQuadrant('urgent', 'Urgent')">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-orange-800 font-semibold text-base mb-0.5">Urgent</h4>
                                <p class="text-[10px] text-orange-700/80 font-medium uppercase tracking-wider">All Urgent</p>
                            </div>
                            <div class="text-xl text-orange-400/70">⚡</div>
                        </div>
                        <div class="text-3xl font-light text-gray-900 mb-1"><span class="js-hover-hours" data-hours="{{ matrix.urgent.hours }}">{{ matrix.urgent.hours }}h</span></div>
                        <div class="text-xs font-medium text-orange-700/70">{{ matrix.urgent.pct }}%</div>
                    </div>

                    <!-- Not Urgent (All) - Soft Teal/Green (calm, time freedom) -->
                    <div class="matrix-card luxury-card rounded-2xl p-5 bg-gradient-to-br from-teal-50/70 to-green-50/40 border-teal-200/60 hover:shadow-lg transition-all duration-300" onclick="viewMatrixQuadrant('not_urgent', 'Not Urgent')">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="text-teal-800 font-semibold text-base mb-0.5">!Urgent</h4>
                                <p class="text-[10px] text-teal-700/80 font-medium uppercase tracking-wider">All Not Urgent</p>
                            </div>
                            <div class="text-xl text-teal-400/70">◇</div>
                        </div>
                        <div class="text-3xl font-light text-gray-900 mb-1"><span class="js-hover-hours" data-hours="{{ matrix.not_urgent.hours }}">{{ matrix.not_urgent.hours }}h</span></div>
                        <div class="text-xs font-medium text-teal-700/70">{{ matrix.not_urgent.pct }}%</div>
                    </div>

                    <!-- Total - Neutral Grey/Beige (pure fact, no emotion) -->
                    <div class="luxury-card rounded-2xl p-5 bg-gradient-to-br from-stone-100/50 to-neutral-50/30 border-stone-200/40 flex flex-col justify-center items-center">
                        <div class="text-[10px] text-stone-500 font-medium uppercase tracking-wider mb-2">Total</div>
                        <div class="text-2xl font-light text-stone-700"><span class="js-hover-hours" data-hours="{{ matrix.total_hours }}">{{ matrix.total_hours }}h</span></div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-8">
                <div class="luxury-card rounded-2xl p-6 md:p-8 h-full flex flex-col overflow-hidden md:overflow-visible {% if tags.labels %}cursor-pointer{% endif %}" id="tags" {% if tags.labels %}onclick="window.applyFilter('all', 'By Category')"{% endif %}>
                    <div class="mb-6">
                        <h3 class="text-xl font-light text-gray-900 mb-1">Time by Category</h3>
                        <p class="text-xs text-gray-500">Tag distribution</p>
                    </div>
                    <div class="relative w-full h-[12rem] md:h-auto md:flex-1 md:min-h-[14rem] lg:min-h-[16rem] flex items-center justify-center overflow-hidden md:overflow-visible" role="img" aria-label="Time spent by tag category">
                        {% if tags.labels %}
                        <canvas id="tagChart" aria-hidden="true"></canvas>
                        <div id="mobileTagLegend" class="mt-3 md:hidden flex flex-wrap gap-3 justify-center text-xs text-gray-600"></div>
                        {% else %}
                        <div class="text-center">
                            <div class="text-5xl text-gray-200 mb-3">∅</div>
                            <p class="text-sm text-gray-400">No data for<br>{{ selected_date }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Mobile-only Focus Time card removed as requested -->

                <!-- Weekly Progress removed for visual consistency -->
            </div>
        </div>

    </main>

    <nav class="fixed bottom-0 inset-x-0 md:hidden z-40">
        <div class="mx-auto max-w-7xl">
            <div class="flex items-center justify-around bg-white/95 backdrop-blur border-t border-slate-200 shadow-lg px-2 py-2" style="padding-bottom: env(safe-area-inset-bottom);">
                <button id="navHome" class="flex flex-col items-center gap-1 px-3 py-1 rounded-xl text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.6" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l9-9 9 9M5 10v10h14V10" />
                    </svg>
                    <span class="text-[10px] font-medium">Home</span>
                </button>
                <button id="navMatrix" class="flex flex-col items-center gap-1 px-3 py-1 rounded-xl text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.6" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4h7v7H4zM13 4h7v7h-7zM4 13h7v7H4zM13 13h7v7h-7z" />
                    </svg>
                    <span class="text-[10px] font-medium">Matrix</span>
                </button>
                <button id="navTags" class="flex flex-col items-center gap-1 px-3 py-1 rounded-xl text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.6" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 7h9.5a2.5 2.5 0 012.5 2.5V19L13 15H5a2 2 0 01-2-2V9a2 2 0 012-2z" />
                    </svg>
                    <span class="text-[10px] font-medium">Tags</span>
                </button>
                <button id="navFilter" class="flex flex-col items-center gap-1 px-3 py-1 rounded-xl text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.6" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 5h18M6 12h12M10 19h4" />
                    </svg>
                    <span class="text-[10px] font-medium">Filter</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Mobile Filter Sheet -->
    <div id="mobileFilterBackdrop" class="fixed inset-0 bg-black/30 backdrop-blur-sm opacity-0 pointer-events-none md:hidden transition-opacity duration-200"></div>
    <div id="mobileFilterSheet" class="fixed inset-x-0 bottom-0 translate-y-full md:hidden transition-transform duration-300 z-50">
        <div class="mx-auto max-w-7xl">
            <div class="bg-[#FEFCF8] border-t border-[rgba(148,126,86,0.25)] rounded-t-2xl shadow-2xl p-4">
                <div class="flex items-center justify-between mb-3">
                    <div class="text-sm font-semibold text-gray-700">Filters</div>
                    <button id="mobileFilterClose" class="px-3 py-1 rounded-full text-xs text-gray-600 border border-slate-200 active:scale-[0.98] transition">
                        Close
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <button class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs text-gray-700 active:scale-[0.98] transition" onclick="applyFilter('all', 'All Tasks')">All Tasks</button>
                    <button class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs text-gray-700 active:scale-[0.98] transition" onclick="applyFilter('imp', 'Important Work')">Important</button>
                    <button class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs text-gray-700 active:scale-[0.98] transition" onclick="applyFilter('urg', 'Urgent Work')">Urgent</button>
                    <button class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs text-gray-700 active:scale-[0.98] transition" onclick="applyFilter('imp_and_urg', 'Important & Urgent')">Important & Urgent</button>
                    <button class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs text-gray-700 active:scale-[0.98] transition" onclick="applyFilter('imp_not_urg', 'Important, Not Urgent')">Important, Not Urgent</button>
                    <button class="px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs text-gray-700 active:scale-[0.98] transition" onclick="applyFilter('urg_not_imp', 'Urgent, Not Important')">Urgent, Not Important</button>
                </div>
                <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">By Category</div>
                <div id="mobileTagFilters" class="grid grid-cols-2 gap-2"></div>
            </div>
        </div>
    </div>

    <!-- Modal for Task Details -->
    <div id="taskModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-content p-8" role="document">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-2xl font-semibold text-gray-900"></h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div id="modalTools" class="mb-4 flex items-center justify-end"></div>
            <div id="modalStats" class="mb-6 grid grid-cols-3 gap-4"></div>
            <div id="modalChart" class="mb-6" style="height: 300px;"></div>
            <div id="modalTasks" class="space-y-3"></div>
        </div>
    </div>

    <script>
        // Global variables
        window.currentDate = '{{ selected_date }}';
        window.currentPeriod = '{{ period }}';

        // Define functions globally
        window.changePeriod = function(period) {
            window.location.href = `/?date=${window.currentDate}&period=${period}`;
        };

        window.changeDate = function(date) {
            window.location.href = `/?date=${date}&period=${window.currentPeriod}`;
        };

        window.toggleDatePicker = function() {
            const dropdown = document.getElementById('dateDropdown');
            if (!dropdown) return;
            dropdown.classList.toggle('hidden');
            const headerFilter = document.getElementById('headerFilterBtn');
            if (headerFilter) {
                const isOpen = !dropdown.classList.contains('hidden');
                headerFilter.classList.toggle('opacity-0', isOpen);
                headerFilter.classList.toggle('pointer-events-none', isOpen);
            }
        };

        window.navigateMonth = function(offset) {
            if (!window.dateCursor) {
                window.dateCursor = new Date(window.currentDate);
            }
            window.dateCursor.setMonth(window.dateCursor.getMonth() + offset);
            window.renderDateGrid();
        };

        window.renderDateGrid = function() {
            const grid = document.getElementById('dateGrid');
            const label = document.getElementById('dateDropdownLabel');
            if (!grid || !label) return;

            const base = window.dateCursor ? new Date(window.dateCursor) : new Date(window.currentDate);
            const year = base.getFullYear();
            const month = base.getMonth();

            const first = new Date(year, month, 1);
            const startDay = first.getDay();
            const last = new Date(year, month + 1, 0);
            const totalDays = last.getDate();

            label.textContent = base.toLocaleString('default', { month: 'long', year: 'numeric' });

            grid.innerHTML = '';
            for (let i = 0; i < startDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'h-8';
                grid.appendChild(empty);
            }

            const selected = new Date(window.currentDate);
            for (let day = 1; day <= totalDays; day++) {
                const d = new Date(year, month, day);
                const btn = document.createElement('button');
                const isSelected = d.toDateString() === selected.toDateString();
                btn.textContent = day;
                btn.className = [
                    'h-8 w-8 flex items-center justify-center rounded-full text-xs',
                    isSelected
                        ? 'bg-[#111827] text-[#F8D574] shadow'
                        : 'text-gray-700 hover:bg-[#F5EDE1]'
                ].join(' ');
                btn.onclick = function() {
                    const iso = d.toISOString().slice(0, 10);
                    window.changeDate(iso);
                };
                grid.appendChild(btn);
            }
        };

        window.toggleDropdown = function() {
            document.getElementById('filterDropdown').classList.toggle('active');
        };

        window.closeDropdown = function() {
            document.getElementById('filterDropdown').classList.remove('active');
        };

        window.viewFullDay = function() {
            console.log('View Full Day clicked');
            try {
                if (typeof closeMobileFilter === 'function') closeMobileFilter();
            } catch (e) {}
            window.applyFilter('all', 'Full Day Log');
        };

        window.viewMatrixQuadrant = function(quadrant, name) {
            console.log('Matrix quadrant clicked:', quadrant, name);
            window.applyFilter(quadrant, name);
        };

        // Decimal helpers (global) used by modal and charts
        window.ensureFinite = function(n) {
            const v = Number(n);
            return Number.isFinite(v) ? v : 0;
        };
        window.minutesFromHours = function(h) {
            return Math.round(window.ensureFinite(h) * 60);
        };
        window.formatHours = function(h, decimals = 1) {
            return window.ensureFinite(h).toFixed(decimals);
        };

        const TAG_COLOR_MAP = {
            'Work': '#16A34A',
            'Important': '#22C55E',
            'Necessity': '#A16207',
            'Urgent': '#DC2626',
            'Waste': '#9F1239'
        };

        function normalizeTagName(tag) {
            if (!tag) return 'Unlabeled';
            const trimmed = String(tag).trim();
            if (!trimmed) return 'Unlabeled';
            return trimmed.charAt(0).toUpperCase() + trimmed.slice(1).toLowerCase();
        }

        function hoursToHuman(h) {
            const total = Math.max(0, Math.round(Number(h || 0) * 60));
            const hrs = Math.floor(total / 60);
            const mins = total % 60;
            if (hrs === 0) return `${mins} min`;
            if (mins === 0) return `${hrs} hr`;
            if (mins === 30) return `${hrs}.5 hr`;
            return `${hrs} hr ${mins} min`;
        }
        window.attachHoverSwap = function() {
            document.querySelectorAll('.js-hover-hours').forEach(el => {
                if (el.__hoverBound) return;
                const raw = el.getAttribute('data-hours') || el.textContent;
                const h = Number(raw);
                if (isNaN(h)) return;
                const decimalText = `${window.formatHours(h, 1)}h`;
                const humanText = hoursToHuman(h);
                el.classList.add('hover-swap', 'cursor-default');
                el.addEventListener('mouseenter', () => {
                    el.style.opacity = '0';
                    el.style.transform = 'scale(0.98)';
                    setTimeout(() => {
                        el.textContent = humanText;
                        el.style.opacity = '1';
                        el.style.transform = 'scale(1)';
                    }, 100);
                });
                el.addEventListener('mouseleave', () => {
                    el.style.opacity = '0';
                    el.style.transform = 'scale(0.98)';
                    setTimeout(() => {
                        el.textContent = decimalText;
                        el.style.opacity = '1';
                        el.style.transform = 'scale(1)';
                    }, 100);
                });
                el.__hoverBound = true;
            });
        };

        function setGlobalLoading(isLoading, errorMessage = '') {
            const loadingEl = document.getElementById('globalLoading');
            const errorEl = document.getElementById('globalError');
            const errorText = document.getElementById('globalErrorText');
            if (!loadingEl || !errorEl || !errorText) return;
            if (isLoading) {
                loadingEl.classList.remove('hidden');
                errorEl.classList.add('hidden');
                errorText.textContent = '';
            } else {
                loadingEl.classList.add('hidden');
                if (errorMessage) {
                    errorText.textContent = errorMessage;
                    errorEl.classList.remove('hidden');
                    setTimeout(() => {
                        errorEl.classList.add('hidden');
                    }, 4000);
                }
            }
        }

        window.applyFilter = function(filterType, title, tagName = '') {
            console.log('applyFilter called:', filterType, title, tagName);
            window.closeDropdown();
            const url = `/api/tasks?date=${window.currentDate}&period=${window.currentPeriod}&filter=${filterType}${tagName ? '&tag=' + encodeURIComponent(tagName) : ''}`;

            console.log('Fetching:', url);
            setGlobalLoading(true);
            fetch(url)
                .then(r => {
                    console.log('Response status:', r.status);
                    if (!r.ok) {
                        throw new Error(`HTTP error! status: ${r.status}`);
                    }
                    return r.json();
                })
                .then(data => {
                    console.log('Data received:', data);
                    setGlobalLoading(false);
                    window.showModal(title, data, filterType);
                })
                .catch(error => {
                    console.error('Error fetching tasks:', error);
                    setGlobalLoading(false, 'Error loading tasks: ' + error.message);
                    try {
                        const fallback = { tasks: [], total_hours: 0, total_minutes: 0, count: 0 };
                        window.showModal(title, fallback, filterType);
                    } catch (e) {
                        console.error('Failed to open modal fallback', e);
                    }
                });
        };

        window.renderModalTasks = function() {
            const container = document.getElementById('modalTasks');
            if (!container || !window.modalData) return;
            const hidden = window.hiddenTags || {};
            const tasks = window.modalData.tasks || [];
            const filterType = window.modalFilterType || 'all';
            const sortKey = window.modalSort || 'duration_desc';
            const getKey = (task) => {
                if (filterType === 'tag') {
                    if (task.urgent && task.important) return 'Critical';
                    if (task.important && !task.urgent) return 'Growth';
                    if (task.urgent && !task.important) return 'Drudgery';
                    return 'Waste';
                }
                return normalizeTagName(task.tag);
            };
            const active = Object.keys(hidden).length
                ? tasks.filter(t => !hidden[getKey(t)])
                : tasks.slice();
            const sorters = {
                duration_desc: (a, b) => (b.duration || 0) - (a.duration || 0),
                duration_asc: (a, b) => (a.duration || 0) - (b.duration || 0),
                tag_az: (a, b) => normalizeTagName(a.tag).localeCompare(normalizeTagName(b.tag)),
                imp_desc: (a, b) => Number(b.important) - Number(a.important),
                urg_desc: (a, b) => Number(b.urgent) - Number(a.urgent)
            };
            active.sort(sorters[sortKey] || sorters.duration_desc);
            if (active.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-400">No tasks found</div>';
                return;
            }
            let html = '';
            active.forEach(task => {
                const dur = Number(task.duration || 0);
                const durText = hoursToHuman(isNaN(dur) ? 0 : dur);
                const badges = [];
                if (task.important) badges.push('<span class="px-2 py-1 bg-emerald-50 text-emerald-700 text-xs rounded-full">Important</span>');
                if (task.urgent) badges.push('<span class="px-2 py-1 bg-red-50 text-red-700 text-xs rounded-full">Urgent</span>');
                let displayTag = task.tag;
                let tagClass = 'px-2 py-0.5 bg-gray-100 rounded-full text-xs text-gray-700';
                if (!task.important && !task.urgent && task.tag === 'Waste') {
                    tagClass = 'px-2 py-0.5 bg-slate-100 rounded-full text-xs text-slate-700';
                } else if (task.tag === 'Necessity') {
                    tagClass = 'px-2 py-0.5 bg-amber-50 rounded-full text-xs text-amber-800';
                } else if (task.tag === 'Work') {
                    tagClass = 'px-2 py-0.5 bg-emerald-50 rounded-full text-xs text-emerald-700';
                }
                html += `
                    <div class="luxury-card rounded-2xl p-4 md:p-5 mb-3 shadow-lg">
                        <div class="flex items-center justify-between gap-3">
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-gray-900 mb-1 truncate">${task.task}</div>
                                <div class="flex flex-wrap items-center gap-2 text-[13px] text-gray-600">
                                    <span class="text-gray-500">${task.date}</span>
                                    <span class="text-gray-500">${task.start_time} - ${task.end_time}</span>
                                    <span class="${tagClass}">${displayTag}</span>
                                    ${badges.join('')}
                                </div>
                            </div>
                            <div class="shrink-0">
                                <span class="inline-flex px-2.5 py-1 rounded-full bg-white border border-slate-200 text-xs font-semibold text-gray-700 js-hover-hours hover-swap" data-hours="${dur}">${durText}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
            window.attachHoverSwap();
        };

        window.showModal = function(title, data, filterType) {
            const modal = document.getElementById('taskModal');
            if (!modal) return;
            window.modalData = data;
            window.modalFilterType = filterType;
            window.hiddenTags = window.hiddenTags || {};
            document.getElementById('modalTitle').textContent = title;

            const totalMinutes = ensureFinite(data.total_minutes || 0);
            let growthMinutes = 0;
            let drudgeryMinutes = 0;
            let wasteMinutes = 0;
            data.tasks.forEach(task => {
                const dMin = minutesFromHours(task.duration || 0);
                if (task.important && !task.urgent) {
                    growthMinutes += dMin;
                } else if (task.urgent && !task.important) {
                    drudgeryMinutes += dMin;
                } else if (!task.urgent && !task.important) {
                    wasteMinutes += dMin;
                }
            });
            const baseMinutes = totalMinutes || (growthMinutes + drudgeryMinutes + wasteMinutes) || 1;
            const growthPct = Math.round((growthMinutes / baseMinutes) * 100);
            const drudgeryPct = Math.round((drudgeryMinutes / baseMinutes) * 100);
            const wastePct = Math.round((wasteMinutes / baseMinutes) * 100);
            const growthHours = growthMinutes / 60;
            const drudgeryHours = drudgeryMinutes / 60;
            const wasteHours = wasteMinutes / 60;

            const statsHtml = `
                <div class="text-center">
                    <div class="text-2xl font-light text-gray-900"><span class="js-hover-hours hover-swap" data-hours="${(growthHours || 0)}">${formatHours(growthHours || 0, 1)}h</span></div>
                    <div class="text-xs text-gray-500 mt-1">${growthPct}% discipline (imp, not urgent)</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-light text-gray-900"><span class="js-hover-hours hover-swap" data-hours="${(drudgeryHours || 0)}">${formatHours(drudgeryHours || 0, 1)}h</span></div>
                    <div class="text-xs text-gray-500 mt-1">${drudgeryPct}% reactive (urg, not important)</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-light text-gray-900"><span class="js-hover-hours hover-swap" data-hours="${(wasteHours || 0)}">${formatHours(wasteHours || 0, 1)}h</span></div>
                    <div class="text-xs text-gray-500 mt-1">${wastePct}% waste (neither)</div>
                </div>
            `;
            document.getElementById('modalStats').innerHTML = statsHtml;
            window.attachHoverSwap();
            const chartContainer = document.getElementById('modalChart');
            chartContainer.innerHTML = '<canvas id="filterChart"></canvas>';
            const tools = document.getElementById('modalTools');
            if (tools) {
                tools.innerHTML = `
                    <div class="relative">
                        <button id="modalSortBtn" class="px-3 py-1.5 rounded-full bg-white border border-slate-200 text-xs text-gray-700 shadow-sm active:scale-[0.98] transition">
                            Sort: <span id="modalSortLabel">${window.modalSortLabel || 'Duration ↓'}</span>
                        </button>
                        <div id="modalSortMenu" class="absolute right-0 mt-2 w-40 bg-white rounded-xl shadow-2xl border border-slate-200 hidden">
                            <div class="dropdown-item" data-key="duration_desc">Duration ↓</div>
                            <div class="dropdown-item" data-key="duration_asc">Duration ↑</div>
                            <div class="dropdown-item" data-key="tag_az">Tag A→Z</div>
                            <div class="dropdown-item" data-key="imp_desc">Important first</div>
                            <div class="dropdown-item" data-key="urg_desc">Urgent first</div>
                        </div>
                    </div>
                `;
                const btn = document.getElementById('modalSortBtn');
                const menu = document.getElementById('modalSortMenu');
                const label = document.getElementById('modalSortLabel');
                if (btn && menu && label) {
                    btn.onclick = () => menu.classList.toggle('hidden');
                    menu.querySelectorAll('.dropdown-item').forEach(item => {
                        item.onclick = () => {
                            const key = item.getAttribute('data-key');
                            const text = item.textContent;
                            window.modalSort = key;
                            window.modalSortLabel = text;
                            label.textContent = text;
                            menu.classList.add('hidden');
                            window.renderModalTasks();
                        };
                    });
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('#modalSortBtn') && !e.target.closest('#modalSortMenu')) {
                            menu.classList.add('hidden');
                        }
                    });
                }
            }
            if (data.tasks.length > 0) {
                const ctx = document.getElementById('filterChart').getContext('2d');
                let labels = [];
                let values = [];
                let colors = [];

                if (window.modalFilterType === 'tag') {
                    const quadrantGroups = {
                        Growth: 0,
                        Critical: 0,
                        Drudgery: 0,
                        Waste: 0
                    };
                    data.tasks.forEach(task => {
                        const d = task.duration || 0;
                        if (task.urgent && task.important) {
                            quadrantGroups.Critical += d;
                        } else if (task.important && !task.urgent) {
                            quadrantGroups.Growth += d;
                        } else if (task.urgent && !task.important) {
                            quadrantGroups.Drudgery += d;
                        } else {
                            quadrantGroups.Waste += d;
                        }
                    });
                    labels = ['Growth', 'Critical', 'Drudgery', 'Waste'];
                    values = labels.map(label => quadrantGroups[label]);
                    const quadrantColors = {
                        Growth: '#16A34A',
                        Critical: '#F97316',
                        Drudgery: '#6B7280',
                        Waste: '#9F1239'
                    };
                    colors = labels.map(label => quadrantColors[label]);
                } else {
                    const tagGroups = {};
                    data.tasks.forEach(task => {
                        const key = normalizeTagName(task.tag);
                        if (!tagGroups[key]) {
                            tagGroups[key] = 0;
                        }
                        tagGroups[key] += task.duration;
                    });
                    labels = Object.keys(tagGroups);
                    values = Object.values(tagGroups);
                    const palette = ['#111827', '#16A34A', '#F59E0B', '#E11D48', '#64748B', '#0369A1', '#7C3AED', '#F97316'];
                    colors = labels.map((label, idx) => TAG_COLOR_MAP[label] || palette[idx % palette.length]);
                }
                const chart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                onClick: function(e, legendItem, legend) {
                                    const ci = legend.chart;
                                    const index = legendItem.index;
                                    const label = ci.data.labels[index];
                                    const currentlyVisible = ci.getDataVisibility(index) !== false;
                                    ci.toggleDataVisibility(index);
                                    ci.update();
                                    if (!window.hiddenTags) window.hiddenTags = {};
                                    if (currentlyVisible) {
                                        window.hiddenTags[label] = true;
                                    } else {
                                        delete window.hiddenTags[label];
                                    }
                                    window.renderModalTasks();
                                }
                            }
                        },
                        onClick: function(evt, elements) {
                            if (!elements || !elements.length) return;
                            const index = elements[0].index;
                            const label = chart.data.labels[index];
                            const currentlyVisible = chart.getDataVisibility(index) !== false;
                            chart.toggleDataVisibility(index);
                            chart.update();
                            if (!window.hiddenTags) window.hiddenTags = {};
                            if (currentlyVisible) {
                                window.hiddenTags[label] = true;
                            } else {
                                delete window.hiddenTags[label];
                            }
                            window.renderModalTasks();
                        }
                    }
                });
            }
            window.renderModalTasks();
            document.getElementById('taskModal').classList.add('active');
        };

        window.closeModal = function() {
            document.getElementById('taskModal').classList.remove('active');
        };

        // Initialize on DOM load
        document.addEventListener('DOMContentLoaded', function() {
            function setActiveNav(id) {
                ['navHome','navMatrix','navTags','navFilter'].forEach(k => {
                    const el = document.getElementById(k);
                    if (!el) return;
                    if (k === id) {
                        el.className = 'flex flex-col items-center gap-1 px-3 py-1 rounded-xl text-gray-900 bg-slate-100';
                    } else {
                        el.className = 'flex flex-col items-center gap-1 px-3 py-1 rounded-xl text-gray-600';
                    }
                });
            }

            function smoothScrollTo(targetId) {
                const el = document.getElementById(targetId);
                if (!el) return;
                el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            const homeBtn = document.getElementById('navHome');
            const matrixBtn = document.getElementById('navMatrix');
            const tagsBtn = document.getElementById('navTags');
            const filterBtn = document.getElementById('navFilter');
            if (homeBtn) homeBtn.onclick = () => { smoothScrollTo('top'); setActiveNav('navHome'); };
            if (matrixBtn) matrixBtn.onclick = () => { smoothScrollTo('matrix'); setActiveNav('navMatrix'); };
            if (tagsBtn) tagsBtn.onclick = () => { smoothScrollTo('tags'); setActiveNav('navTags'); };
            if (filterBtn) {
                filterBtn.onclick = () => {
                    openMobileFilter();
                    setActiveNav('navFilter');
                };
                ['touchstart','mousedown'].forEach(evt => {
                    filterBtn.addEventListener(evt, () => filterBtn.classList.add('bg-slate-100'));
                });
                ['touchend','mouseup','mouseleave'].forEach(evt => {
                    filterBtn.addEventListener(evt, () => filterBtn.classList.remove('bg-slate-100'));
                });
            }

            function openMobileFilter() {
                try {
                    const sheet = document.getElementById('mobileFilterSheet');
                    const backdrop = document.getElementById('mobileFilterBackdrop');
                    if (!sheet || !backdrop) return;
                    backdrop.classList.remove('pointer-events-none');
                    backdrop.classList.add('opacity-100');
                    sheet.classList.remove('translate-y-full');
                } catch (e) {
                    setGlobalLoading(false, 'Unable to open filters');
                    console.error(e);
                }
            }
            function closeMobileFilter() {
                try {
                    const sheet = document.getElementById('mobileFilterSheet');
                    const backdrop = document.getElementById('mobileFilterBackdrop');
                    if (!sheet || !backdrop) return;
                    sheet.classList.add('translate-y-full');
                    backdrop.classList.remove('opacity-100');
                    backdrop.classList.add('pointer-events-none');
                } catch (e) {
                    setGlobalLoading(false, 'Unable to close filters');
                    console.error(e);
                }
            }
            const mobileFilterClose = document.getElementById('mobileFilterClose');
            const mobileBackdrop = document.getElementById('mobileFilterBackdrop');
            if (mobileFilterClose) mobileFilterClose.onclick = closeMobileFilter;
            if (mobileBackdrop) mobileBackdrop.onclick = closeMobileFilter;

            const observerTargets = [
                { id: 'top', btn: 'navHome' },
                { id: 'matrix', btn: 'navMatrix' },
                { id: 'tags', btn: 'navTags' }
            ].map(({ id, btn }) => ({ el: document.getElementById(id), btn }));

            const io = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const t = observerTargets.find(x => x.el === entry.target);
                        if (t) setActiveNav(t.btn);
                    }
                });
            }, { root: null, threshold: 0.4 });

            observerTargets.forEach(t => { if (t.el) io.observe(t.el); });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.dropdown')) {
                    window.closeDropdown();
                }
                if (!e.target.closest('#datePicker')) {
                    const dd = document.getElementById('dateDropdown');
                    if (dd) dd.classList.add('hidden');
                }
            });

            // Close modal on outside click
            document.getElementById('taskModal').addEventListener('click', (e) => {
                if (e.target.id === 'taskModal') {
                    window.closeModal();
                }
            });

            // Load tag filters
            const tagUrl = `/api/tags?date=${window.currentDate}&period=${window.currentPeriod}`;
            if (!navigator.onLine) {
                setGlobalLoading(false, 'You are offline. Filters may be limited.');
            }
            fetch(tagUrl)
            .then(r => {
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                return r.json();
            })
            .then(data => {
                const container = document.getElementById('tagFilters');
                const mobileContainer = document.getElementById('mobileTagFilters');
                const appendTag = (target, tag) => {
                    const item = document.createElement(target === mobileContainer ? 'button' : 'div');
                    item.className = target === mobileContainer
                        ? 'px-3 py-2 rounded-xl bg-white border border-slate-200 text-xs text-gray-700 active:scale-[0.98] transition'
                        : 'dropdown-item';
                    item.textContent = `${tag.name} (${tag.hours}h)`;
                    item.onclick = () => window.applyFilter('tag', tag.name, tag.name);
                    target.appendChild(item);
                };
                if (data.tags && data.tags.length > 0) {
                    data.tags.forEach(tag => {
                        if (container) appendTag(container, tag);
                        if (mobileContainer) appendTag(mobileContainer, tag);
                    });
                }
            })
            .catch(err => {
                console.error('Tag fetch failed:', err);
                setGlobalLoading(false, 'Failed to load tags');
            });

            window.dateCursor = new Date(window.currentDate);
            window.renderDateGrid();

            {% if tags.labels %}
            const tagCanvas = document.getElementById('tagChart');
            const tagCtx = tagCanvas ? tagCanvas.getContext('2d') : null;
            const isMobile = window.matchMedia('(max-width: 767px)').matches;
            const tagPalette = ['#111827', '#16A34A', '#F59E0B', '#E11D48', '#64748B', '#0369A1', '#7C3AED', '#F97316'];
            const tagLabels = {{ tags.labels | safe }};
            const tagColors = tagLabels.map((label, idx) => TAG_COLOR_MAP[label] || tagPalette[idx % tagPalette.length]);
            try {
                const tagChart = new Chart(tagCtx, {
                    type: 'doughnut',
                    data: {
                        labels: tagLabels,
                        datasets: [{
                            data: {{ tags.data | safe }},
                            backgroundColor: tagColors,
                            borderWidth: 0,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: isMobile ? '80%' : '75%',
                        plugins: {
                            legend: {
                                display: !isMobile,
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    font: { family: 'Inter', size: 11, weight: '400' },
                                    padding: 15,
                                    color: '#6B7280'
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(31, 41, 55, 0.95)',
                                padding: 12,
                                titleFont: { family: 'Inter', size: 12, weight: '500' },
                                bodyFont: { family: 'Inter', size: 11 },
                                cornerRadius: 8
                            }
                        }
                    }
                });
                tagChart.options.onClick = function(evt, elements) {
                    if (!elements || !elements.length) return;
                    const index = elements[0].index;
                    const label = tagChart.data.labels[index];
                    window.applyFilter('tag', label, label);
                };
                tagChart.update();
                const mobileLegend = document.getElementById('mobileTagLegend');
                if (isMobile && mobileLegend) {
                    tagChart.options.plugins.legend.display = false;
                    tagChart.update();
                    mobileLegend.innerHTML = tagLabels.map((label, idx) => (
                        `<span class="inline-flex items-center gap-1">
                            <span class="inline-block w-2.5 h-2.5 rounded-full" style="background:${tagColors[idx]}"></span>
                            ${label}
                        </span>`
                    )).join('');
                }
            } catch (e) {
                const wrap = document.getElementById('tags');
                if (wrap) {
                    const holder = wrap.querySelector('[aria-label=\"Time spent by tag category\"]');
                    if (holder) {
                        holder.innerHTML = '<div class=\"text-center text-xs text-gray-400\">Unable to render chart</div>';
                    }
                }
            }
            {% endif %}
            // Decimal handling helpers: sum in minutes to avoid float drift, format using fixed decimals
            function ensureFinite(n) {
                const v = Number(n);
                return Number.isFinite(v) ? v : 0;
            }
            function minutesFromHours(h) {
                return Math.round(ensureFinite(h) * 60);
            }
            function formatHours(h, decimals = 1) {
                return ensureFinite(h).toFixed(decimals);
            }
            function hoursToHM(h) {
                const total = Math.max(0, Math.round(Number(h || 0) * 60));
                const hrs = Math.floor(total / 60);
                const mins = total % 60;
                if (hrs === 0) return `${mins} min`;
                if (mins === 0) return `${hrs} hr`;
                return `${hrs} hr ${mins} min`;
            }
            const titleBtn = document.getElementById('appTitleBtn');
            if (titleBtn) {
                titleBtn.addEventListener('click', async () => {
                    try {
                        setGlobalLoading(true, '');
                        const r = await fetch('/sync-now', { method: 'GET', credentials: 'include' });
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        await r.json();
                        setGlobalLoading(false, '');
                        window.location.href = `/?date=${window.currentDate}&period=${window.currentPeriod}`;
                    } catch (e) {
                        console.error('Manual sync failed', e);
                        setGlobalLoading(false, 'Failed to sync from cloud');
                    }
                });
            }
            function attachHoverSwap() {
                document.querySelectorAll('.js-hover-hours').forEach(el => {
                    if (el.__hoverBound) return;
                    const raw = el.getAttribute('data-hours') || el.textContent;
                    const h = Number(raw);
                    if (isNaN(h)) return;
                    const decimalText = `${window.formatHours(h, 1)}h`;
                    const humanText = hoursToHM(h);
                    el.classList.add('hover-swap', 'cursor-default');
                    el.addEventListener('mouseenter', () => {
                        el.style.opacity = '0';
                        el.style.transform = 'scale(0.98)';
                        setTimeout(() => {
                            el.textContent = humanText;
                            el.style.opacity = '1';
                            el.style.transform = 'scale(1)';
                        }, 100);
                    });
                    el.addEventListener('mouseleave', () => {
                        el.style.opacity = '0';
                        el.style.transform = 'scale(0.98)';
                        setTimeout(() => {
                            el.textContent = decimalText;
                            el.style.opacity = '1';
                            el.style.transform = 'scale(1)';
                        }, 100);
                    });
                    el.__hoverBound = true;
                });
            }
            attachHoverSwap();
        }); // End DOMContentLoaded
    </script>
</body>
</html>
